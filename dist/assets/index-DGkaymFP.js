(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function t(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(o){if(o.ep)return;o.ep=!0;const n=t(o);fetch(o.href,n)}})();class O{constructor(e,t=null){this.scene=e,this.editorManager=t,this.selectedObject=null,this.highlightLayer=null,this.onSelectionChanged=null,this.selectionCallbacks=[],this.initialize()}initialize(){this.highlightLayer=new BABYLON.HighlightLayer("highlight",this.scene),this.highlightLayer.outerGlow=!0,this.highlightLayer.innerGlow=!1,console.log("SelectionManager initialized with HighlightLayer")}setupPicking(e){this.scene.onPointerDown=(t,i)=>{this.editorManager&&!this.editorManager.isEditorMode||t.button===0&&(i.hit&&i.pickedMesh?i.pickedMesh.name.startsWith("_")||this.selectObject(i.pickedMesh):this.deselectObject())},console.log("Mouse picking enabled for object selection")}selectObject(e){if(!e||e.isDisposed()){console.warn("Cannot select invalid or disposed object");return}let t=e;if(e instanceof BABYLON.Mesh){let i=e;for(;i;){if(i.metadata&&i.metadata.isImportedGLTF){t=i,console.log(`Found GLTF root: ${t.name} (clicked on ${e.name})`);break}i=i.parent}}this.selectedObject&&this.selectedObject instanceof BABYLON.Mesh&&this.highlightLayer.removeMesh(this.selectedObject),this.selectedObject=t,t instanceof BABYLON.Mesh&&this.highlightLayer.addMesh(t,BABYLON.Color3.Yellow()),this.onSelectionChanged&&this.onSelectionChanged(t),this.selectionCallbacks.forEach(i=>i(t)),console.log(`Selected object: ${t.name}`)}deselectObject(){this.selectedObject&&(this.selectedObject instanceof BABYLON.Mesh&&this.highlightLayer.removeMesh(this.selectedObject),console.log(`Deselected object: ${this.selectedObject.name}`),this.selectedObject=null,this.onSelectionChanged&&this.onSelectionChanged(null),this.selectionCallbacks.forEach(e=>e(null)))}addSelectionCallback(e){e&&typeof e=="function"&&this.selectionCallbacks.push(e)}dispose(){this.highlightLayer&&(this.highlightLayer.dispose(),this.highlightLayer=null)}}class L{constructor(e,t){this.scene=e,this.canvas=t,this.editorCamera=null,this.playerCamera=null,this.activeCamera=null}createPlayerCamera(){const e=new BABYLON.UniversalCamera("playerCamera",new BABYLON.Vector3(-.1,2.5,.35),this.scene);e.setTarget(new BABYLON.Vector3(3.6,1.55,.5)),e.speed=0,e.angularSensibility=2e3,e.keysUp=[],e.keysDown=[],e.keysLeft=[],e.keysRight=[],e.minZ=.1,e.maxZ=1e3,e.fov=.6;const t=-1.4,i=.39;return this.scene.onBeforeRenderObservable.add(()=>{e.rotation.x<t&&(e.rotation.x=t),e.rotation.x>i&&(e.rotation.x=i)}),console.log("Player camera (UniversalCamera) created - sitting mode (rotation only)"),this.playerCamera=e,e}createEditorCamera(){const e=new BABYLON.ArcRotateCamera("editorCamera",Math.PI/2,Math.PI/3,15,new BABYLON.Vector3(0,1.5,0),this.scene);return e.panningSensibility=1e3,e.wheelPrecision=50,e.angularSensibilityX=1e3,e.angularSensibilityY=1e3,e.lowerRadiusLimit=2,e.upperRadiusLimit=100,e.lowerBetaLimit=.1,e.upperBetaLimit=Math.PI/2,e.inputs.attached.pointers.buttons=[2,1,0],console.log("Editor camera (ArcRotateCamera) created"),this.editorCamera=e,e}switchToEditorCamera(){this.editorCamera||this.createEditorCamera(),document.pointerLockElement===this.canvas&&document.exitPointerLock(),this.playerCamera&&this.playerCamera.detachControl(),this.editorCamera.attachControl(this.canvas,!0),this.scene.activeCamera=this.editorCamera,this.activeCamera=this.editorCamera,console.log("Switched to editor camera")}switchToPlayerCamera(){this.playerCamera||this.createPlayerCamera(),this.editorCamera&&this.editorCamera.detachControl(),this.playerCamera.attachControl(this.canvas,!0),this.scene.activeCamera=this.playerCamera,this.activeCamera=this.playerCamera,this.canvas.requestPointerLock(),console.log("Switched to player camera")}initialize(){this.createPlayerCamera(),this.createEditorCamera(),this.switchToEditorCamera()}}class C{constructor(e){this.scene=e,this.objectCounter=0}createPrimitive(e){const t=`${e}_${this.objectCounter++}`;let i;switch(e.toLowerCase()){case"box":i=BABYLON.MeshBuilder.CreateBox(t,{size:1},this.scene);break;case"sphere":i=BABYLON.MeshBuilder.CreateSphere(t,{diameter:1},this.scene);break;case"cylinder":i=BABYLON.MeshBuilder.CreateCylinder(t,{height:2,diameter:1},this.scene);break;case"cone":i=BABYLON.MeshBuilder.CreateCylinder(t,{height:2,diameterTop:0,diameterBottom:1},this.scene);break;case"plane":i=BABYLON.MeshBuilder.CreatePlane(t,{size:1},this.scene);break;case"torus":i=BABYLON.MeshBuilder.CreateTorus(t,{diameter:1,thickness:.3},this.scene);break;default:return console.warn(`Unknown primitive type: ${e}`),null}i.position=new BABYLON.Vector3(0,1,0);const o=new BABYLON.StandardMaterial(`${t}_mat`,this.scene);return o.diffuseColor=new BABYLON.Color3(Math.random(),Math.random(),Math.random()),i.material=o,console.log(`Created primitive: ${t}`),i}createLight(e){const t=`${e}Light_${this.objectCounter++}`;let i;switch(e.toLowerCase()){case"point":i=new BABYLON.PointLight(t,new BABYLON.Vector3(0,3,0),this.scene);break;case"directional":i=new BABYLON.DirectionalLight(t,new BABYLON.Vector3(0,-1,0),this.scene),i.position=new BABYLON.Vector3(0,5,0);break;case"spot":i=new BABYLON.SpotLight(t,new BABYLON.Vector3(0,3,0),new BABYLON.Vector3(0,-1,0),Math.PI/3,2,this.scene);break;case"hemispheric":i=new BABYLON.HemisphericLight(t,new BABYLON.Vector3(0,1,0),this.scene);break;default:return console.warn(`Unknown light type: ${e}`),null}return i.intensity=.5,console.log(`Created light: ${t}`),i}async importGLTF(e,t=null,i=!1){try{console.log(`Importing GLTF from: ${e}`);let o="",n=e;e.startsWith("/models/")&&(o="/models/",n=e.replace("/models/",""));const s=await BABYLON.SceneLoader.ImportMeshAsync(null,o,n,this.scene,null,".glb");if(s.meshes&&s.meshes.length>0){let r=s.meshes[0];const l=s.meshes.find(d=>d.name==="__root__");l&&(r=l),console.log("GLTF meshes:",s.meshes.map(d=>{var m;return{name:d.name,parent:(m=d.parent)==null?void 0:m.name}})),console.log("Selected root mesh:",r.name),r.name=`imported_${this.objectCounter++}`;const c=r.scaling.clone();return r.position=new BABYLON.Vector3(0,0,0),r.rotation=new BABYLON.Vector3(0,0,0),r.scaling=new BABYLON.Vector3(Math.sign(c.x)||1,Math.sign(c.y)||1,Math.sign(c.z)||1),i?console.log(`Reset transforms for ${r.name}, ready for saved transforms`):(r.position=new BABYLON.Vector3(0,1,0),console.log(`Set default position for ${r.name}:`,r.position)),r.metadata={isImportedGLTF:!0,modelPath:e.startsWith("/models/")?e:null,modelName:t,originalName:r.name},console.log(`Successfully imported GLTF: ${r.name} with ${s.meshes.length} meshes`),r}else throw new Error("No meshes found in GLTF file")}catch(o){throw console.error("Failed to load GLTF:",o),new Error(`Unable to load model: ${o.message}`)}}duplicateObject(e){if(!e)return console.warn("Cannot duplicate null object"),null;let t=null;if(e instanceof BABYLON.Mesh){if(t=e.clone(`${e.name}_copy_${this.objectCounter++}`),t.position=e.position.add(new BABYLON.Vector3(1,0,1)),e.material){const i=e.material.clone(`${t.name}_mat`);t.material=i}console.log(`Duplicated mesh: ${t.name}`)}else if(e instanceof BABYLON.Light){const i=this.getLightType(e);t=this.createLight(i),t.intensity=e.intensity,e.diffuse&&(t.diffuse=e.diffuse.clone()),e.position&&(t.position=e.position.add(new BABYLON.Vector3(1,0,1))),e.direction&&t.direction&&(t.direction=e.direction.clone()),console.log(`Duplicated light: ${t.name}`)}else console.warn(`Cannot duplicate object of type: ${e.constructor.name}`);return t}getLightType(e){return e instanceof BABYLON.PointLight?"point":e instanceof BABYLON.DirectionalLight?"directional":e instanceof BABYLON.SpotLight?"spot":e instanceof BABYLON.HemisphericLight?"hemispheric":"point"}}class M{constructor(e){this.scene=e}serializeScene(){const e={version:"1.0",objects:[],postProcessing:null};if(this.scene.meshes.forEach(t=>{if(t.name.startsWith("_")||t.name==="floor"||t.name==="ceiling"||t.name.startsWith("wall"))return;if(t.metadata&&t.metadata.isImportedGLTF){console.log(`Serializing GLTF model ${t.name}`);const n={type:"gltf",name:t.name,position:t.position.asArray(),rotation:t.rotation.asArray(),scaling:t.scaling.asArray(),modelPath:t.metadata.modelPath,modelName:t.metadata.modelName};e.objects.push(n);return}let i=t.parent;for(;i;){if(i.metadata&&i.metadata.isImportedGLTF)return;i=i.parent}const o={type:"mesh",meshType:this.getMeshType(t),name:t.name,position:t.position.asArray(),rotation:t.rotation.asArray(),scaling:t.scaling.asArray()};t.material&&(o.material=this.serializeMaterial(t.material)),e.objects.push(o)}),this.scene.lights.forEach(t=>{const i={type:"light",lightType:this.getLightType(t),name:t.name,intensity:t.intensity,diffuse:t.diffuse.asArray()};t.specular&&(i.specular=t.specular.asArray()),t.groundColor&&(i.groundColor=t.groundColor.asArray()),t.position&&(i.position=t.position.asArray()),t.direction&&(i.direction=t.direction.asArray()),t.range!==void 0&&(i.range=t.range),e.objects.push(i)}),window.postProcessingPipeline){const t=window.postProcessingPipeline;e.postProcessing={fxaaEnabled:t.fxaaEnabled,bloomEnabled:t.bloomEnabled,bloomThreshold:t.bloomThreshold,bloomWeight:t.bloomWeight,bloomScale:t.bloomScale,contrast:t.imageProcessing.contrast,exposure:t.imageProcessing.exposure,vignetteEnabled:t.imageProcessing.vignetteEnabled,vignetteWeight:t.imageProcessing.vignetteWeight,chromaticAberrationEnabled:t.chromaticAberrationEnabled,chromaticAberrationAmount:t.chromaticAberration.aberrationAmount,grainEnabled:t.grainEnabled,grainIntensity:t.grain.intensity,grainAnimated:t.grain.animated,sharpenEnabled:t.sharpenEnabled,sharpenEdgeAmount:t.sharpen.edgeAmount,sharpenColorAmount:t.sharpen.colorAmount},console.log("Post-processing settings serialized")}return JSON.stringify(e,null,2)}getMeshType(e){const t=e.name.toLowerCase();return t.includes("box")?"box":t.includes("sphere")?"sphere":t.includes("cylinder")?"cylinder":t.includes("cone")?"cone":t.includes("plane")?"plane":t.includes("torus")?"torus":"box"}getLightType(e){return e instanceof BABYLON.PointLight?"point":e instanceof BABYLON.DirectionalLight?"directional":e instanceof BABYLON.SpotLight?"spot":e instanceof BABYLON.HemisphericLight?"hemispheric":"point"}serializeMaterial(e){const t={};return e.diffuseColor&&(t.diffuseColor=e.diffuseColor.asArray()),e.specularColor&&(t.specularColor=e.specularColor.asArray()),e.emissiveColor&&(t.emissiveColor=e.emissiveColor.asArray()),t}applyMaterialData(e,t){t.diffuseColor&&(e.diffuseColor=BABYLON.Color3.FromArray(t.diffuseColor)),t.specularColor&&(e.specularColor=BABYLON.Color3.FromArray(t.specularColor)),t.emissiveColor&&(e.emissiveColor=BABYLON.Color3.FromArray(t.emissiveColor))}clearScene(){this.scene.meshes.filter(i=>!i.name.startsWith("_")&&i.name!=="floor"&&i.name!=="ceiling"&&!i.name.startsWith("wall")).forEach(i=>{i.material&&i.material.dispose(),i.dispose()}),[...this.scene.lights].forEach(i=>{i.dispose()})}async deserializeScene(e){const t=JSON.parse(e),i=new C(this.scene);this.clearScene();for(const o of t.objects)if(o.type==="gltf")try{const n=await i.importGLTF(o.modelPath,o.modelName,!0);n&&(n.name=o.name,n.position.fromArray(o.position),n.rotation.fromArray(o.rotation),n.scaling.fromArray(o.scaling),console.log(`Restored GLTF model ${o.name}`))}catch(n){console.error(`Failed to restore GLTF model ${o.name}:`,n)}else if(o.type==="mesh"){const n=i.createPrimitive(o.meshType);n&&(n.name=o.name,n.position.fromArray(o.position),n.rotation.fromArray(o.rotation),n.scaling.fromArray(o.scaling),o.material&&n.material&&this.applyMaterialData(n.material,o.material))}else if(o.type==="light"){const n=i.createLight(o.lightType);n&&(n.name=o.name,n.intensity=o.intensity,n.diffuse.fromArray(o.diffuse),o.specular&&n.specular&&n.specular.fromArray(o.specular),o.groundColor&&n.groundColor&&n.groundColor.fromArray(o.groundColor),o.position&&n.position&&n.position.fromArray(o.position),o.direction&&n.direction&&n.direction.fromArray(o.direction),o.range!==void 0&&n.range!==void 0&&(n.range=o.range))}if(t.postProcessing&&window.postProcessingPipeline){const o=window.postProcessingPipeline,n=t.postProcessing;o.fxaaEnabled=n.fxaaEnabled,o.bloomEnabled=n.bloomEnabled,o.bloomThreshold=n.bloomThreshold,o.bloomWeight=n.bloomWeight,o.bloomScale=n.bloomScale,o.imageProcessing.contrast=n.contrast,o.imageProcessing.exposure=n.exposure,o.imageProcessing.vignetteEnabled=n.vignetteEnabled,o.imageProcessing.vignetteWeight=n.vignetteWeight,o.chromaticAberrationEnabled=n.chromaticAberrationEnabled,o.chromaticAberration.aberrationAmount=n.chromaticAberrationAmount,o.grainEnabled=n.grainEnabled,o.grain.intensity=n.grainIntensity,o.grain.animated=n.grainAnimated,o.sharpenEnabled=n.sharpenEnabled,o.sharpen.edgeAmount=n.sharpenEdgeAmount,o.sharpen.colorAmount=n.sharpenColorAmount,console.log("Post-processing settings restored"),window.settingsPanel&&window.settingsPanel.refresh()}console.log("Scene deserialized successfully")}async saveToFile(){try{console.log("Starting scene save...");const e=this.serializeScene(),i=await(await fetch("http://localhost:3001/api/save-scene",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:e})})).json();if(i.success)console.log("âœ“ Scene saved to saved-3d-env.json");else throw new Error(i.error)}catch(e){throw console.error("âœ— Failed to save scene:",e),alert(`Failed to save scene: ${e.message}
Make sure the server is running (npm run server)`),e}}async loadFromFile(e=!1){try{console.log("Starting scene load...");const t=await fetch("/saved-3d-env.json");if(!t.ok)throw new Error("No saved scene found");const i=await t.text();console.log("Deserializing scene data..."),await this.deserializeScene(i),console.log("âœ“ Scene loaded from saved-3d-env.json")}catch(t){throw e||console.error("âœ— Failed to load scene:",t),t}}}class N{constructor(e,t){this.scene=e,this.guiTexture=t,this.panel=null,this.isVisible=!1,this.monitorMesh=null,this.helperBox=null,this.initialize()}initialize(){this.panel=new BABYLON.GUI.StackPanel,this.panel.width="300px",this.panel.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER,this.panel.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,this.panel.top="10px",this.panel.background="#1a1a1a",this.panel.isVisible=!1,this.panel.isPointerBlocker=!0,this.guiTexture.addControl(this.panel);const e=new BABYLON.GUI.TextBlock;e.text="HtmlMesh Alignment",e.height="40px",e.color="#00ff00",e.fontSize=18,e.fontWeight="bold",this.panel.addControl(e),this.addButton("ðŸ” Find Monitor Mesh",()=>this.findMonitorMesh()),this.addButton("ðŸ“ Align to Monitor",()=>this.alignToMonitor()),this.addButton("ðŸ“‹ Copy Position",()=>this.copyTransform("position")),this.addButton("ðŸ“‹ Copy Rotation",()=>this.copyTransform("rotation")),this.addButton("ðŸ“‹ Copy Scaling",()=>this.copyTransform("scaling")),this.addButton("ðŸ“‹ Copy All",()=>this.copyTransform("all")),this.addButton("âŒ Close",()=>this.hide()),this.statusText=new BABYLON.GUI.TextBlock,this.statusText.height="100px",this.statusText.color="white",this.statusText.fontSize=12,this.statusText.textWrapping=!0,this.statusText.paddingTop="10px",this.statusText.paddingLeft="10px",this.statusText.paddingRight="10px",this.panel.addControl(this.statusText),console.log("HtmlMeshAlignPanel initialized")}addButton(e,t){const i=BABYLON.GUI.Button.CreateSimpleButton(`align_${Date.now()}`,e);i.width="280px",i.height="35px",i.color="white",i.background="#00ff00",i.fontSize=14,i.cornerRadius=4,i.thickness=0,i.paddingTop="5px",i.onPointerEnterObservable.add(()=>{i.background="#00cc00"}),i.onPointerOutObservable.add(()=>{i.background="#00ff00"}),i.onPointerClickObservable.add(t),this.panel.addControl(i)}findMonitorMesh(){if(this.monitorMesh=this.scene.getMeshByName("SM_Prop_ComputerMonitor_B_32_StaticMeshComponent0.screen"),this.monitorMesh){this.monitorMesh.computeWorldMatrix(!0);const e=this.monitorMesh.getAbsolutePosition();this.setStatus("success",`âœ… Monitor mesh found!
Position: (${e.x.toFixed(3)}, ${e.y.toFixed(3)}, ${e.z.toFixed(3)})
Rotation: (${this.monitorMesh.rotation.x.toFixed(3)}, ${this.monitorMesh.rotation.y.toFixed(3)}, ${this.monitorMesh.rotation.z.toFixed(3)})`),console.log("âœ“ Monitor mesh found:",this.monitorMesh.name),console.log("  Position:",e)}else{const e=this.scene.meshes.map(t=>t.name).join(", ");this.setStatus("error",`âŒ Monitor mesh not found!
Available meshes: ${e.substring(0,100)}...`),console.error("Monitor mesh not found")}}alignToMonitor(){var n;if(!this.monitorMesh){this.setStatus("error","âŒ Find monitor mesh first!");return}if(this.helperBox=this.scene.getMeshByName("HtmlMesh_Helper"),!this.helperBox){this.setStatus("error",`âŒ HtmlMesh_Helper not found!
Make sure HtmlMeshMonitor is initialized.`);return}this.monitorMesh.parent&&this.monitorMesh.parent.computeWorldMatrix(!0),this.monitorMesh.computeWorldMatrix(!0);const e=this.monitorMesh.getWorldMatrix(),t=new BABYLON.Vector3;e.decompose(null,null,t);const i=new BABYLON.Quaternion,o=new BABYLON.Vector3;e.decompose(o,i,null),this.helperBox.position.copyFrom(t),this.helperBox.rotationQuaternion=i.clone(),this.helperBox.scaling.copyFrom(o),console.log("Monitor mesh hierarchy:"),console.log("  Parent:",(n=this.monitorMesh.parent)==null?void 0:n.name),console.log("  Local position:",this.monitorMesh.position),console.log("  World position:",t),console.log("  Local rotation:",this.monitorMesh.rotation),console.log("  World rotation (quat):",i),console.log("  Local scaling:",this.monitorMesh.scaling),console.log("  World scaling:",o),this.setStatus("success",`âœ… Aligned!
Position: (${this.helperBox.position.x.toFixed(3)}, ${this.helperBox.position.y.toFixed(3)}, ${this.helperBox.position.z.toFixed(3)})
Rotation: (${this.helperBox.rotation.x.toFixed(3)}, ${this.helperBox.rotation.y.toFixed(3)}, ${this.helperBox.rotation.z.toFixed(3)})`),console.log("âœ“ HtmlMesh aligned to monitor")}copyTransform(e){if(this.helperBox=this.scene.getMeshByName("HtmlMesh_Helper"),!this.helperBox){this.setStatus("error","âŒ HtmlMesh_Helper not found!");return}let t="";switch(e){case"position":t=`new BABYLON.Vector3(${this.helperBox.position.x}, ${this.helperBox.position.y}, ${this.helperBox.position.z})`;break;case"rotation":t=`new BABYLON.Vector3(${this.helperBox.rotation.x}, ${this.helperBox.rotation.y}, ${this.helperBox.rotation.z})`;break;case"scaling":t=`new BABYLON.Vector3(${this.helperBox.scaling.x}, ${this.helperBox.scaling.y}, ${this.helperBox.scaling.z})`;break;case"all":t=`helperBox.position = new BABYLON.Vector3(${this.helperBox.position.x}, ${this.helperBox.position.y}, ${this.helperBox.position.z});
helperBox.rotation = new BABYLON.Vector3(${this.helperBox.rotation.x}, ${this.helperBox.rotation.y}, ${this.helperBox.rotation.z});
helperBox.scaling = new BABYLON.Vector3(${this.helperBox.scaling.x}, ${this.helperBox.scaling.y}, ${this.helperBox.scaling.z});`;break}navigator.clipboard.writeText(t).then(()=>{this.setStatus("success",`âœ… ${e.toUpperCase()} copied to clipboard!`),console.log("Copied:",t)}).catch(i=>{this.setStatus("error",`âŒ Failed to copy: ${i.message}`)})}setStatus(e,t){this.statusText.text=t,e==="success"?this.statusText.color="#00ff00":e==="error"?this.statusText.color="#ff0000":this.statusText.color="white"}show(){this.panel.isVisible=!0,this.isVisible=!0}hide(){this.panel.isVisible=!1,this.isVisible=!1}toggle(){this.isVisible?this.hide():this.show()}}const A={computer_audio_machine:{displayName:"Computer & Audio Equipment",meshName:"SM_ComputerParts_C05_N1_54_StaticMeshComponent0",cameraPosition:{x:.32,y:2.297,z:-.099},cameraRotation:{x:.024,y:2.336,z:0},interactiveElements:{powerButton:{type:"button",meshName:"SM_ComputerParts_C05_N1_54_StaticMeshComponent0_power",pressOffset:{x:.021,y:0,z:.015},action:"togglePower"},dial:{type:"dial",meshName:"SM_ComputerParts_C05_N1_54_StaticMeshComponent0.dial",rotationAxis:{x:0,y:0,z:1},sensitivity:.01,action:"adjustVolume"}}},cube18_machine:{displayName:"Cube18 Equipment",meshName:"Cube18_StaticMeshComponent0",cameraPosition:{x:.222,y:2.115,z:-.058},cameraRotation:{x:.003,y:2.23,z:0},interactiveElements:{powerButton:{type:"button",meshName:"Cube18_StaticMeshComponent0.power",pressOffset:{x:.006,y:0,z:.004},action:"togglePower"},lever1:{type:"lever",meshName:"Cube18_StaticMeshComponent0.lv.1",minOffset:{x:0,y:-.043,z:0},maxOffset:{x:0,y:.043,z:0}},lever2:{type:"lever",meshName:"Cube18_StaticMeshComponent0.lv.2",minOffset:{x:0,y:-.043,z:0},maxOffset:{x:0,y:.043,z:0}},lever3:{type:"lever",meshName:"Cube18_StaticMeshComponent0.lv.3",minOffset:{x:0,y:-.043,z:0},maxOffset:{x:0,y:.043,z:0}},lever4:{type:"lever",meshName:"Cube18_StaticMeshComponent0.lv.4",minOffset:{x:0,y:-.043,z:0},maxOffset:{x:0,y:.043,z:0}},lever5:{type:"lever",meshName:"Cube18_StaticMeshComponent0.lv.5",minOffset:{x:0,y:-.043,z:0},maxOffset:{x:0,y:.043,z:0}},lever6:{type:"lever",meshName:"Cube18_StaticMeshComponent0.lv.6",minOffset:{x:0,y:-.043,z:0},maxOffset:{x:0,y:.043,z:0}},lever7:{type:"lever",meshName:"Cube18_StaticMeshComponent0.lv.7",minOffset:{x:0,y:-.043,z:0},maxOffset:{x:0,y:.043,z:0}},lever8:{type:"lever",meshName:"Cube18_StaticMeshComponent0.lv.8",minOffset:{x:0,y:-.043,z:0},maxOffset:{x:0,y:.043,z:0}},lever9:{type:"lever",meshName:"Cube18_StaticMeshComponent0.lv.9",minOffset:{x:0,y:-.043,z:0},maxOffset:{x:0,y:.043,z:0}},lever10:{type:"lever",meshName:"Cube18_StaticMeshComponent0.lv.10",minOffset:{x:0,y:-.043,z:0},maxOffset:{x:0,y:.043,z:0}}}},computer_monitor:{displayName:"Computer Monitor",meshName:"SM_Prop_ComputerMonitor_B_32_StaticMeshComponent0.001",cameraPosition:{x:.208,y:2.202,z:.414},cameraRotation:{x:-.028,y:1.58,z:0},interactiveElements:{powerButton:{type:"button",meshName:"SM_Prop_ComputerMonitor_B_32_StaticMeshComponent0.power",pressOffset:{x:.004,y:0,z:0},action:"togglePower"}}},monitor_frame:{displayName:"Monitor Frame",meshName:"monitorFrame",cameraPosition:{x:.208,y:2.202,z:.414},cameraRotation:{x:-.028,y:1.58,z:0},interactiveElements:{}}};function T(a){for(const[e,t]of Object.entries(A))if(t.meshName===a)return{id:e,...t};return null}class v{constructor(e,t,i){this.scene=e,this.camera=t,this.canvas=i,this.focusedObject=null,this.isLockedOn=!1,this.interactableObjects=[],this.enabled=!1,this.promptElement=null,this.highlightLayer=null,this.raycastDistance=5,this.raycastThrottle=0,this.raycastInterval=5,this.initialize()}initialize(){this.highlightLayer=null,this.originalMaterials=new Map,this.createPromptUI(),this.createCrosshair(),this.registerInteractableObjects(),setTimeout(()=>{console.log("Re-scanning for interactables after 1 second..."),this.registerInteractableObjects()},1e3),setTimeout(()=>{console.log("Re-scanning for interactables after 3 seconds..."),this.registerInteractableObjects()},3e3),this.setupKeyboardListener(),console.log("InteractionSystem initialized")}createPromptUI(){this.promptElement=document.createElement("div"),this.promptElement.id="interaction-prompt",this.promptElement.style.cssText=`
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #00ff00;
      padding: 15px 30px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      font-weight: bold;
      border: 2px solid #00ff00;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
      display: none;
      z-index: 1000;
      text-align: center;
    `,this.promptElement.innerHTML='Press <span style="color: #ffff00;">[F]</span> to Interact',document.body.appendChild(this.promptElement)}createCrosshair(){this.crosshairElement=document.createElement("div"),this.crosshairElement.id="interaction-crosshair",this.crosshairElement.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      pointer-events: none;
      z-index: 999;
      transition: all 0.1s ease;
    `,document.body.appendChild(this.crosshairElement)}registerInteractableObjects(){this.interactableObjects=[];const e=["SM_ComputerParts_C05_N1_54_StaticMeshComponent0","Cube18_StaticMeshComponent0","SM_Prop_ComputerMonitor_B_32_StaticMeshComponent0.001","monitorFrame"];console.log("=== Scanning scene for interactable objects ==="),console.log("Total meshes in scene:",this.scene.meshes.length),this.scene.meshes.forEach(t=>{e.includes(t.name)&&t.isPickable!==!1&&(this.interactableObjects.push(t),console.log("âœ“ Registered interactable:",t.name))}),console.log(`=== Found ${this.interactableObjects.length} interactable objects ===`),this.interactableObjects.length===0&&(console.warn("âš ï¸ NO INTERACTABLE OBJECTS FOUND! Listing all meshes:"),this.scene.meshes.slice(0,20).forEach(t=>{console.log("  -",t.name,"| Pickable:",t.isPickable)}))}setupKeyboardListener(){window.addEventListener("keydown",e=>{(e.key==="f"||e.key==="F")&&this.focusedObject&&!this.isLockedOn&&this.lockOnToObject(),e.key==="Escape"&&this.isLockedOn&&this.exitLockOn()})}update(){if(!this.enabled||!this.camera||this.isLockedOn||(this.raycastThrottle++,this.raycastThrottle<this.raycastInterval))return;this.raycastThrottle=0;const e=this.camera.position,t=this.camera.getDirection(BABYLON.Axis.Z),i=this.raycastDistance,o=new BABYLON.Ray(e,t,i);if(this.scene.getFrameId()%60===0){const s=this.scene.pickWithRay(o);s&&s.pickedMesh?console.log("ðŸŽ¯ Looking at mesh:",s.pickedMesh.name,"| Distance:",s.distance.toFixed(2)):console.log("âŒ Not looking at any mesh")}const n=this.scene.pickWithRay(o,s=>this.interactableObjects.includes(s));n&&n.pickedMesh?this.setFocusedObject(n.pickedMesh):this.clearFocusedObject()}setFocusedObject(e){this.focusedObject!==e&&(this.clearFocusedObject(),this.focusedObject=e,this.crosshairElement&&(this.crosshairElement.style.background="#00ff00",this.crosshairElement.style.width="8px",this.crosshairElement.style.height="8px",this.crosshairElement.style.boxShadow="0 0 10px rgba(0, 255, 0, 0.8)"),this.promptElement.style.display="block")}clearFocusedObject(){this.focusedObject&&(this.focusedObject=null),this.crosshairElement&&(this.crosshairElement.style.background="rgba(255, 255, 255, 0.5)",this.crosshairElement.style.width="4px",this.crosshairElement.style.height="4px",this.crosshairElement.style.boxShadow="none"),this.promptElement.style.display="none"}lockOnToObject(){if(!this.focusedObject)return;this.isLockedOn=!0,this.crosshairElement&&(this.crosshairElement.style.display="none"),this.promptElement.style.display="none",document.pointerLockElement===this.canvas&&document.exitPointerLock(),this.canvas.style.cursor="pointer",this.scene.stopAnimation(this.camera),this.camera.detachControl(),this.originalCameraPosition=this.camera.position.clone(),this.originalCameraRotation=this.camera.rotation.clone(),this.originalRotationLimits={lowerRotationLimit:this.camera.lowerRotationLimit,upperRotationLimit:this.camera.upperRotationLimit},this.camera.lowerRotationLimit=null,this.camera.upperRotationLimit=null,console.log("Stored original camera:",this.originalCameraPosition.toString(),this.originalCameraRotation.toString());const e=T(this.focusedObject.name);let t,i;if(e){const l=window.lockOnOverrides&&window.lockOnOverrides[e.id];l?(t=new BABYLON.Vector3(l.cameraPosition.x,l.cameraPosition.y,l.cameraPosition.z),i=new BABYLON.Vector3(l.cameraRotation.x,l.cameraRotation.y,l.cameraRotation.z),console.log("Using OVERRIDE camera config for machine:",e.displayName)):(t=new BABYLON.Vector3(e.cameraPosition.x,e.cameraPosition.y,e.cameraPosition.z),i=new BABYLON.Vector3(e.cameraRotation.x,e.cameraRotation.y,e.cameraRotation.z),console.log("Using camera config for machine:",e.displayName))}else t=new BABYLON.Vector3(.2,2.3,.1),i=new BABYLON.Vector3(-.01,2.38,0),console.warn("No camera config found for mesh:",this.focusedObject.name);const o=60,n=new BABYLON.Animation("cameraPositionAnimation","position",60,BABYLON.Animation.ANIMATIONTYPE_VECTOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);n.setKeys([{frame:0,value:this.camera.position.clone()},{frame:o,value:t}]);const s=new BABYLON.CubicEase;s.setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT),n.setEasingFunction(s);const r=new BABYLON.Animation("cameraRotationAnimation","rotation",60,BABYLON.Animation.ANIMATIONTYPE_VECTOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);r.setKeys([{frame:0,value:this.camera.rotation.clone()},{frame:o,value:i}]),r.setEasingFunction(s),this.camera.animations=[],this.camera.animations=[n,r],this.scene.stopAnimation(this.camera),this.scene.beginAnimation(this.camera,0,o,!1,1,()=>{this.camera.position.copyFrom(t),this.camera.rotation.copyFrom(i),this.camera.rotationQuaternion=null,console.log("Camera animation complete - locked on to:",this.focusedObject.name)}),console.log("Locking on to:",this.focusedObject.name),this.onObjectInteract(this.focusedObject)}exitLockOn(){if(this.isLockedOn){if(this.isLockedOn=!1,this.promptElement.style.display="none",this.originalCameraPosition&&this.originalCameraRotation){console.log("Returning to original camera:",this.originalCameraPosition.toString(),this.originalCameraRotation.toString()),console.log("Current camera rotation:",this.camera.rotation.toString()),this.scene.stopAnimation(this.camera),this.camera.rotationQuaternion=null;const e=60,t=new BABYLON.Animation("cameraReturnPositionAnimation","position",60,BABYLON.Animation.ANIMATIONTYPE_VECTOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);t.setKeys([{frame:0,value:this.camera.position.clone()},{frame:e,value:this.originalCameraPosition.clone()}]);const i=new BABYLON.CubicEase;i.setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT),t.setEasingFunction(i);const o=new BABYLON.Animation("cameraReturnRotationAnimation","rotation",60,BABYLON.Animation.ANIMATIONTYPE_VECTOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);o.setKeys([{frame:0,value:this.camera.rotation.clone()},{frame:e,value:this.originalCameraRotation.clone()}]),o.setEasingFunction(i),this.camera.animations=[],this.camera.animations=[t,o],this.scene.beginAnimation(this.camera,0,e,!1,1,()=>{this.camera.position.copyFrom(this.originalCameraPosition),this.camera.rotation.x=this.originalCameraRotation.x,this.camera.rotation.y=this.originalCameraRotation.y,this.camera.rotation.z=this.originalCameraRotation.z,this.camera.rotationQuaternion=null,console.log("Set final rotation to:",this.camera.rotation.toString()),this.originalRotationLimits&&(this.camera.lowerRotationLimit=this.originalRotationLimits.lowerRotationLimit,this.camera.upperRotationLimit=this.originalRotationLimits.upperRotationLimit),setTimeout(()=>{this.camera.rotation.x=this.originalCameraRotation.x,this.camera.rotation.y=this.originalCameraRotation.y,this.camera.rotation.z=this.originalCameraRotation.z,this.camera.rotationQuaternion=null,this.camera.attachControl(this.canvas,!0),this.canvas.requestPointerLock(),this.crosshairElement&&(this.crosshairElement.style.display="block"),this.focusedObject&&(this.promptElement.style.display="block"),console.log("Returned to original camera position and controls restored"),console.log("Final camera rotation after attach:",this.camera.rotation.toString())},50)})}else this.camera.attachControl(this.canvas,!0),this.canvas.requestPointerLock(),this.crosshairElement&&(this.crosshairElement.style.display="block"),this.focusedObject&&(this.promptElement.style.display="block");this.canvas.style.cursor="default",console.log("Exited lock-on mode")}}onObjectInteract(e){console.log("Interacting with:",e.name)}dispose(){this.highlightLayer&&(this.highlightLayer.dispose(),this.highlightLayer=null),this.originalMaterials.clear(),this.promptElement&&this.promptElement.remove(),this.crosshairElement&&this.crosshairElement.remove(),console.log("InteractionSystem disposed")}}class S{constructor(e,t){this.scene=e,this.canvas=t,this.isEditorMode=!0,this.selectionManager=null,this.objectFactory=null,this.serializationManager=null,this.cameraManager=null,this.objectPalette=null,this.propertyPanel=null,this.sceneHierarchy=null,this.htmlMeshAlignPanel=null,this.interactionSystem=null,this.guiTexture=null,this.gizmoManager=null,this.activeGizmo=null,this.lightHelpers=new Map}initialize(e){this.guiTexture=e,this.selectionManager=new O(this.scene,this),this.objectFactory=new C(this.scene),this.serializationManager=new M(this.scene),this.cameraManager=new L(this.scene,this.canvas),this.cameraManager.initialize(),this.interactionSystem=new v(this.scene,this.cameraManager.playerCamera,this.canvas),this.selectionManager.setupPicking(this.canvas),this.initializeGizmos(),this.selectionManager.addSelectionCallback(t=>{this.updateGizmoAttachment()}),this.setupKeyboardShortcuts(),console.log("EditorManager initialized")}initializeGizmos(){this.gizmoManager=new BABYLON.GizmoManager(this.scene),this.gizmoManager.usePointerToAttachGizmos=!1,this.gizmoManager.scaleRatio=1,this.gizmoManager.gizmoCoordinatesMode=BABYLON.GizmoCoordinatesMode.Local,this.gizmoManager.positionGizmoEnabled=!1,this.gizmoManager.scaleGizmoEnabled=!1,this.gizmoManager.rotationGizmoEnabled=!1,console.log("Gizmo system initialized"),console.log("GizmoManager:",this.gizmoManager)}setGizmoMode(e){this.gizmoManager.positionGizmoEnabled=!1,this.gizmoManager.rotationGizmoEnabled=!1,this.gizmoManager.scaleGizmoEnabled=!1;const t=this.selectionManager.selectedObject;if(!e||!t){this.activeGizmo=null,this.gizmoManager.attachToMesh(null);return}e==="move"?(this.gizmoManager.positionGizmoEnabled=!0,this.gizmoManager.attachToMesh(t),this.activeGizmo="move",console.log("Position gizmo enabled for:",t.name)):e==="rotate"?(this.gizmoManager.rotationGizmoEnabled=!0,this.gizmoManager.attachToMesh(t),this.activeGizmo="rotate",console.log("Rotation gizmo enabled for:",t.name)):e==="scale"&&(this.gizmoManager.scaleGizmoEnabled=!0,this.gizmoManager.attachToMesh(t),this.activeGizmo="scale",setTimeout(()=>{if(this.gizmoManager.gizmos&&this.gizmoManager.gizmos.scaleGizmo){const i=this.propertyPanel?this.propertyPanel.uniformScaling:!0,o=this.gizmoManager.gizmos.scaleGizmo;i?(o.xGizmo&&(o.xGizmo.isEnabled=!1),o.yGizmo&&(o.yGizmo.isEnabled=!1),o.zGizmo&&(o.zGizmo.isEnabled=!1),o.uniformScaleGizmo&&(o.uniformScaleGizmo.isEnabled=!0)):(o.xGizmo&&(o.xGizmo.isEnabled=!0),o.yGizmo&&(o.yGizmo.isEnabled=!0),o.zGizmo&&(o.zGizmo.isEnabled=!0),o.uniformScaleGizmo&&(o.uniformScaleGizmo.isEnabled=!1)),console.log("Scale gizmo configured - uniform mode:",i)}},10),console.log("Scale gizmo enabled for:",t.name))}updateScaleGizmoUniformMode(e){if(console.log("updateScaleGizmoUniformMode called with:",e),this.gizmoManager&&this.gizmoManager.gizmos&&this.gizmoManager.gizmos.scaleGizmo){const t=this.gizmoManager.gizmos.scaleGizmo;e?(t.xGizmo&&(t.xGizmo.isEnabled=!1),t.yGizmo&&(t.yGizmo.isEnabled=!1),t.zGizmo&&(t.zGizmo.isEnabled=!1),t.uniformScaleGizmo&&(t.uniformScaleGizmo.isEnabled=!0),console.log("Uniform scaling enabled - showing center gizmo only")):(t.xGizmo&&(t.xGizmo.isEnabled=!0),t.yGizmo&&(t.yGizmo.isEnabled=!0),t.zGizmo&&(t.zGizmo.isEnabled=!0),t.uniformScaleGizmo&&(t.uniformScaleGizmo.isEnabled=!1),console.log("Non-uniform scaling enabled - showing axis gizmos"))}else console.warn("Scale gizmo not available")}setupKeyboardShortcuts(){window.addEventListener("keydown",e=>{if(e.key==="e"||e.key==="E"){this.toggleMode();return}this.isEditorMode&&(e.key==="Delete"&&this.deleteSelected(),e.ctrlKey&&(e.key==="d"||e.key==="D")&&(e.preventDefault(),this.duplicateSelected()),e.ctrlKey&&(e.key==="s"||e.key==="S")&&(e.preventDefault(),this.saveScene()),e.ctrlKey&&(e.key==="o"||e.key==="O")&&(e.preventDefault(),this.loadScene()),(e.key==="f"||e.key==="F")&&this.focusOnSelected(),e.key==="Escape"&&this.selectionManager.deselectObject())}),console.log("Keyboard shortcuts registered")}focusOnSelected(){if(this.selectionManager.selectedObject&&this.cameraManager.editorCamera){const e=this.selectionManager.selectedObject.position;this.cameraManager.editorCamera.setTarget(e),console.log(`Focused camera on: ${this.selectionManager.selectedObject.name}`)}}toggleMode(){this.isEditorMode=!this.isEditorMode,this.isEditorMode?this.enterEditorMode():this.enterPlayMode(),console.log(`Mode switched to: ${this.isEditorMode?"Editor":"Play"}`)}enterEditorMode(){this.isEditorMode=!0,this.cameraManager.switchToEditorCamera(),this.guiTexture&&(this.guiTexture.layer.isEnabled=!0),this.objectPalette&&this.objectPalette.show(),this.propertyPanel&&this.propertyPanel.show(),this.sceneHierarchy&&this.sceneHierarchy.show(),this.selectionManager&&this.selectionManager.setupPicking(this.canvas),this.interactionSystem&&(this.interactionSystem.enabled=!1,this.interactionSystem.clearFocusedObject(),this.interactionSystem.isLockedOn&&this.interactionSystem.exitLockOn()),console.log("Entered editor mode")}enterPlayMode(){this.isEditorMode=!1,this.cameraManager.switchToPlayerCamera(),this.guiTexture&&(this.guiTexture.layer.isEnabled=!1),this.objectPalette&&this.objectPalette.hide(),this.propertyPanel&&this.propertyPanel.hide(),this.sceneHierarchy&&this.sceneHierarchy.hide(),this.selectionManager&&this.selectionManager.deselectObject(),this.interactionSystem&&(this.interactionSystem.enabled=!0,console.log("âœ“ InteractionSystem enabled")),console.log("Entered play mode")}deleteSelected(){const e=this.selectionManager.selectedObject;if(!e){console.warn("No object selected to delete");return}if(["playerCamera","editorCamera","camera"].includes(e.name)){console.warn(`Cannot delete essential object: ${e.name}`),alert(`Cannot delete essential object: ${e.name}`);return}const i=e.name;this.gizmoManager&&this.gizmoManager.attachToMesh(null),this.selectionManager.deselectObject(),e.material&&e.material.dispose(),e.dispose(),this.sceneHierarchy&&this.sceneHierarchy.refresh(),console.log(`Deleted object: ${i}`)}duplicateSelected(){const e=this.selectionManager.selectedObject;if(!e){console.warn("No object selected to duplicate");return}const t=this.objectFactory.duplicateObject(e);t&&(this.selectionManager.selectObject(t),this.sceneHierarchy&&this.sceneHierarchy.refresh(),console.log(`Duplicated object: ${t.name}`))}async saveScene(){try{await this.serializationManager.saveToFile(),console.log("Scene saved successfully")}catch(e){console.error("Failed to save scene:",e)}}async loadScene(e=!1){try{await this.serializationManager.loadFromFile(e),this.selectionManager.deselectObject(),this.sceneHierarchy&&this.sceneHierarchy.refresh(),console.log("Scene loaded successfully")}catch(t){e||console.error("Failed to load scene:",t)}}async autoLoadScene(){try{await this.loadScene(!0),this.sceneHierarchy&&this.sceneHierarchy.refresh(),console.log("Auto-loaded saved scene")}catch{console.log("No saved scene to auto-load"),this.sceneHierarchy&&this.sceneHierarchy.refresh()}}setLightGizmoMode(e,t){if(this.gizmoManager.positionGizmoEnabled=!1,this.gizmoManager.scaleGizmoEnabled=!1,!e||!t){this.activeGizmo=null,this.gizmoManager.attachToMesh(null),this.lightHelpers.has(t)&&(this.lightHelpers.get(t).dispose(),this.lightHelpers.delete(t));return}let i=this.lightHelpers.get(t);if(i||(i=BABYLON.MeshBuilder.CreateSphere(`_lightHelper_${t.name}`,{diameter:.3},this.scene),i.isVisible=!1,i.isPickable=!1,this.scene.onBeforeRenderObservable.add(()=>{t.position&&i&&i.position.copyFrom(t.position)}),this.lightHelpers.set(t,i)),t.position&&i.position.copyFrom(t.position),e==="move"){this.gizmoManager.positionGizmoEnabled=!0,this.gizmoManager.attachToMesh(i),this.activeGizmo="move";const o=this.gizmoManager.gizmos.positionGizmo;o&&o.onDragEndObservable.add(()=>{t.position&&t.position.copyFrom(i.position)}),console.log("Position gizmo enabled for light:",t.name)}else if(e==="scale"){this.gizmoManager.scaleGizmoEnabled=!0,this.gizmoManager.attachToMesh(i),this.activeGizmo="scale";const o=t.range||10,n=t.intensity||1,s=i.scaling.x;setTimeout(()=>{const r=this.gizmoManager.gizmos.scaleGizmo;r&&r.onDragObservable.add(()=>{const l=i.scaling.x/s;t.range!==void 0&&(t.range=o*l),t.intensity!==void 0&&(t.intensity=n*l)})},100),console.log("Scale gizmo enabled for light:",t.name)}}updateGizmoAttachment(){const e=this.selectionManager.selectedObject;this.activeGizmo&&this.gizmoManager&&this.gizmoManager.attachToMesh(e)}dispose(){this.selectionManager&&this.selectionManager.dispose(),this.gizmoManager&&this.gizmoManager.dispose(),this.lightHelpers.forEach(e=>e.dispose()),this.lightHelpers.clear()}}class z{constructor(e,t){this.editor=e,this.guiTexture=t,this.panel=null,this.scrollViewer=null,this.isVisible=!0,this.initialize()}initialize(){this.scrollViewer=new BABYLON.GUI.ScrollViewer,this.scrollViewer.width="240px",this.scrollViewer.height="45%",this.scrollViewer.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,this.scrollViewer.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,this.scrollViewer.top="10px",this.scrollViewer.left="10px",this.scrollViewer.background="#2a2a2a",this.scrollViewer.thickness=2,this.scrollViewer.thumbLength=.5,this.scrollViewer.barColor="#4a9eff",this.scrollViewer.barBackground="#1a1a1a",this.scrollViewer.isPointerBlocker=!0,this.guiTexture.addControl(this.scrollViewer),this.panel=new BABYLON.GUI.StackPanel,this.panel.width="200px",this.scrollViewer.addControl(this.panel),this.createFileSection(),this.createPrimitiveSection(),this.createLightSection(),this.createModelSection(),console.log("ObjectPalette initialized with 45% height and scrolling")}createFileSection(){const e=this.createSectionHeader("File");this.panel.addControl(e);const t=this.createButton("Save Scene",()=>{this.editor.saveScene()});this.panel.addControl(t);const i=this.createButton("Load Scene",()=>{this.editor.loadScene()});this.panel.addControl(i);const o=new BABYLON.GUI.Container;o.height="10px",this.panel.addControl(o)}createSectionHeader(e){const t=new BABYLON.GUI.TextBlock;return t.text=e,t.height="30px",t.width="190px",t.color="#4a9eff",t.fontSize=16,t.fontWeight="bold",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.textWrapping=!0,t.paddingLeft="5px",t}createButton(e,t){const i=BABYLON.GUI.Button.CreateSimpleButton(`btn_${e}_${Date.now()}`,e);return i.width="180px",i.height="30px",i.color="white",i.background="#3a3a3a",i.fontSize=14,i.cornerRadius=4,i.onPointerEnterObservable.add(()=>{i.background="#4a4a4a"}),i.onPointerOutObservable.add(()=>{i.background="#3a3a3a"}),i.onPointerClickObservable.add(t),i}createPrimitiveSection(){const e=this.createSectionHeader("Primitives");this.panel.addControl(e),["Box","Sphere","Cylinder","Cone","Plane","Torus"].forEach(o=>{const n=this.createButton(o,()=>{const s=this.editor.objectFactory.createPrimitive(o);s&&(this.editor.selectionManager.selectObject(s),this.editor.sceneHierarchy&&this.editor.sceneHierarchy.refresh())});this.panel.addControl(n)});const i=new BABYLON.GUI.Container;i.height="10px",this.panel.addControl(i)}createLightSection(){const e=this.createSectionHeader("Lights");this.panel.addControl(e),["Point","Directional","Spot","Hemispheric"].forEach(o=>{const n=this.createButton(o,()=>{const s=this.editor.objectFactory.createLight(o);s&&(this.editor.selectionManager.selectObject(s),this.editor.sceneHierarchy&&this.editor.sceneHierarchy.refresh())});this.panel.addControl(n)});const i=new BABYLON.GUI.Container;i.height="10px",this.panel.addControl(i)}createModelSection(){const e=this.createSectionHeader("Models");this.panel.addControl(e);const t=this.createButton("Load Model",()=>{this.openModelSelector()});this.panel.addControl(t)}async openModelSelector(){try{const t=await(await fetch("http://localhost:3001/api/list-models")).json();if(!t.success)throw new Error(t.error);const i=t.models;if(i.length===0){alert(`No models found in the /models directory.
Place your .gltf or .glb files there.`);return}this.showModelSelectionDialog(i)}catch(e){console.error("Failed to list models:",e),alert(`Failed to load models list: ${e.message}
Make sure the server is running.`)}}showModelSelectionDialog(e){const t=document.createElement("div");t.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    `;const i=document.createElement("div");i.style.cssText=`
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      max-height: 500px;
      overflow-y: auto;
      color: white;
      font-family: Arial, sans-serif;
    `;const o=document.createElement("h3");o.textContent="Select Model",o.style.cssText="margin-top: 0; color: #4a9eff;",i.appendChild(o),e.forEach(s=>{const r=document.createElement("button");r.textContent=s,r.style.cssText=`
        display: block;
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        background: #3a3a3a;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      `,r.onmouseenter=()=>r.style.background="#4a4a4a",r.onmouseleave=()=>r.style.background="#3a3a3a",r.onclick=async()=>{document.body.removeChild(t),await this.loadModelFromServer(s)},i.appendChild(r)});const n=document.createElement("button");n.textContent="Cancel",n.style.cssText=`
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      background: #555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    `,n.onclick=()=>document.body.removeChild(t),i.appendChild(n),t.appendChild(i),document.body.appendChild(t)}async loadModelFromServer(e){try{console.log(`Loading model: ${e}`);const t=`/models/${e}`,i=await this.editor.objectFactory.importGLTF(t,e);i&&(this.editor.selectionManager.selectObject(i),this.editor.sceneHierarchy&&this.editor.sceneHierarchy.refresh(),console.log("Model loaded successfully"))}catch(t){console.error("Failed to load model:",t),alert(`Failed to load model: ${t.message}`)}}show(){this.scrollViewer&&(this.scrollViewer.isVisible=!0,this.isVisible=!0)}hide(){this.scrollViewer&&(this.scrollViewer.isVisible=!1,this.isVisible=!1)}}class E{constructor(e,t){this.editor=e,this.guiTexture=t,this.panel=null,this.currentObject=null,this.propertyControls=[],this.isVisible=!1,this.activeGizmoMode=null,this.uniformScaling=!0,this.moveButton=null,this.rotateButton=null,this.scaleButton=null,this.uniformScaleCheckbox=null,this.initialize()}initialize(){const e=new BABYLON.GUI.ScrollViewer;e.width="320px",e.height="600px",e.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT,e.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,e.paddingTop="10px",e.paddingRight="10px",e.background="#2a2a2a",e.thickness=2,e.color="#4a9eff",e.isVisible=!1,this.guiTexture.addControl(e),this.panel=new BABYLON.GUI.StackPanel,this.panel.width="300px",this.panel.background="#2a2a2a",e.isPointerBlocker=!0,e.addControl(this.panel),this.scrollViewer=e,this.editor.selectionManager.addSelectionCallback(t=>{this.updateForObject(t)}),console.log("PropertyPanel initialized")}updateForObject(e){if(console.log("PropertyPanel.updateForObject called with:",e?e.name:"null"),this.clearControls(),this.currentObject=e,!e){this.scrollViewer.isVisible=!1,console.log("PropertyPanel hidden - no object selected");return}console.log("PropertyPanel showing for object:",e.name),this.scrollViewer.isVisible=!0,this.createHeader(e),e instanceof BABYLON.Mesh?(this.createTransformSection(e),this.createMaterialSection(e)):e instanceof BABYLON.Light&&this.createLightSection(e),this.createDeleteButton()}clearControls(){this.panel&&this.panel.clearControls(),this.propertyControls=[]}createHeader(e){const t=new BABYLON.GUI.TextBlock;t.text=`Object: ${e.name}`,t.height="40px",t.color="#4a9eff",t.fontSize=18,t.fontWeight="bold",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.paddingLeft="5px",this.panel.addControl(t);const i=new BABYLON.GUI.InputText;i.width="280px",i.height="30px",i.color="white",i.background="#3a3a3a",i.text=e.name,i.fontSize=14,i.onTextChangedObservable.add(n=>{const s=n.text.trim();if(s&&s!==e.name){let r=s,l=1;for(;this.editor.scene.getMeshByName(r)||this.editor.scene.getLightByName(r);)r=`${s}_${l}`,l++;e.name=r,t.text=`Object: ${r}`,n.text=r,this.editor.sceneHierarchy&&this.editor.sceneHierarchy.refresh()}}),this.panel.addControl(i);const o=new BABYLON.GUI.Container;o.height="10px",this.panel.addControl(o)}createMaterialSection(e){if(!e.material)return;this.addSectionHeader("Material");const t=e.material;t.diffuseColor&&this.addColorControl("Diffuse",t.diffuseColor,i=>{t.diffuseColor=i}),t.specularColor&&this.addColorControl("Specular",t.specularColor,i=>{t.specularColor=i}),t.emissiveColor&&this.addColorControl("Emissive",t.emissiveColor,i=>{t.emissiveColor=i})}addColorControl(e,t,i){const o=new BABYLON.GUI.TextBlock;o.text=e+" Color:",o.height="25px",o.color="white",o.fontSize=12,o.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,o.paddingLeft="5px",this.panel.addControl(o);const n=new BABYLON.GUI.ColorPicker;n.value=t,n.height="180px",n.width="180px",n.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER,n.onValueChangedObservable.add(r=>{t.r=r.r,t.g=r.g,t.b=r.b,i(t)}),this.panel.addControl(n);const s=new BABYLON.GUI.Container;s.height="10px",this.panel.addControl(s)}createLightSection(e){if(e.position){this.addSectionHeader("Transform Gizmos"),this.createLightGizmoButtons(e);const s=new BABYLON.GUI.Container;s.height="10px",this.panel.addControl(s)}this.addSectionHeader("Light Properties");const t=new BABYLON.GUI.StackPanel;t.height="40px",t.isVertical=!1;const i=new BABYLON.GUI.TextBlock;i.text="Intensity:",i.width="80px",i.color="white",i.fontSize=12,t.addControl(i);const o=new BABYLON.GUI.Slider;o.minimum=0,o.maximum=10,o.value=e.intensity,o.height="20px",o.width="150px",o.color="#4a9eff",o.background="#3a3a3a",o.onValueChangedObservable.add(s=>{e.intensity=s}),t.addControl(o);const n=new BABYLON.GUI.TextBlock;if(n.text=e.intensity.toFixed(2),n.width="50px",n.color="white",n.fontSize=12,t.addControl(n),o.onValueChangedObservable.add(s=>{n.text=s.toFixed(2)}),this.panel.addControl(t),e.diffuse&&this.addColorControl("Light",e.diffuse,s=>{e.diffuse=s}),e.position&&(this.addSectionHeader("Position"),this.addVector3Control("X",e.position.x,s=>{e.position.x=s}),this.addVector3Control("Y",e.position.y,s=>{e.position.y=s}),this.addVector3Control("Z",e.position.z,s=>{e.position.z=s})),e.direction&&(this.addSectionHeader("Direction"),this.addVector3Control("X",e.direction.x,s=>{e.direction.x=s,e.direction.normalize()}),this.addVector3Control("Y",e.direction.y,s=>{e.direction.y=s,e.direction.normalize()}),this.addVector3Control("Z",e.direction.z,s=>{e.direction.z=s,e.direction.normalize()})),e.range!==void 0){this.addSectionHeader("Range");const s=new BABYLON.GUI.StackPanel;s.height="40px",s.isVertical=!1;const r=new BABYLON.GUI.TextBlock;r.text="Range:",r.width="80px",r.color="white",r.fontSize=12,s.addControl(r);const l=new BABYLON.GUI.Slider;l.minimum=1,l.maximum=50,l.value=e.range,l.height="20px",l.width="150px",l.color="#4a9eff",l.background="#3a3a3a",l.onValueChangedObservable.add(d=>{e.range=d}),s.addControl(l);const c=new BABYLON.GUI.TextBlock;c.text=e.range.toFixed(1),c.width="50px",c.color="white",c.fontSize=12,s.addControl(c),l.onValueChangedObservable.add(d=>{c.text=d.toFixed(1)}),this.panel.addControl(s)}}createDeleteButton(){const e=new BABYLON.GUI.Container;e.height="20px",this.panel.addControl(e);const t=BABYLON.GUI.Button.CreateSimpleButton("deleteBtn","Delete Object");t.width="280px",t.height="35px",t.color="white",t.background="#cc0000",t.fontSize=14,t.cornerRadius=4,t.onPointerEnterObservable.add(()=>{t.background="#ff0000"}),t.onPointerOutObservable.add(()=>{t.background="#cc0000"}),t.onPointerClickObservable.add(()=>{this.editor.deleteSelected()}),this.panel.addControl(t)}show(){this.currentObject&&this.scrollViewer&&(this.scrollViewer.isVisible=!0,this.isVisible=!0)}hide(){this.scrollViewer&&(this.scrollViewer.isVisible=!1,this.isVisible=!1)}createTransformSection(e){this.addSectionHeader("Transform Gizmos"),this.createGizmoButtons(e);const t=new BABYLON.GUI.Container;t.height="10px",this.panel.addControl(t),this.addSectionHeader("Position"),this.addVector3Control("X",e.position.x,i=>{e.position.x=i}),this.addVector3Control("Y",e.position.y,i=>{e.position.y=i}),this.addVector3Control("Z",e.position.z,i=>{e.position.z=i}),this.addSectionHeader("Rotation"),this.addVector3Control("X",e.rotation.x*180/Math.PI,i=>{e.rotation.x=i*Math.PI/180}),this.addVector3Control("Y",e.rotation.y*180/Math.PI,i=>{e.rotation.y=i*Math.PI/180}),this.addVector3Control("Z",e.rotation.z*180/Math.PI,i=>{e.rotation.z=i*Math.PI/180}),this.addSectionHeader("Scale"),this.addVector3Control("X",e.scaling.x,i=>{e.scaling.x=i}),this.addVector3Control("Y",e.scaling.y,i=>{e.scaling.y=i}),this.addVector3Control("Z",e.scaling.z,i=>{e.scaling.z=i})}createLightGizmoButtons(e){const t=new BABYLON.GUI.StackPanel;t.height="40px",t.isVertical=!1,t.paddingLeft="5px",this.moveButton=BABYLON.GUI.Button.CreateSimpleButton("moveGizmo","Move"),this.moveButton.width="90px",this.moveButton.height="35px",this.moveButton.color="white",this.moveButton.background="#3a3a3a",this.moveButton.fontSize=13,this.moveButton.cornerRadius=4,this.moveButton.paddingRight="3px",this.moveButton.onPointerClickObservable.add(()=>{this.toggleLightGizmoMode("move",e)}),t.addControl(this.moveButton),this.scaleButton=BABYLON.GUI.Button.CreateSimpleButton("scaleGizmo","Scale"),this.scaleButton.width="90px",this.scaleButton.height="35px",this.scaleButton.color="white",this.scaleButton.background="#3a3a3a",this.scaleButton.fontSize=13,this.scaleButton.cornerRadius=4,this.scaleButton.onPointerClickObservable.add(()=>{this.toggleLightGizmoMode("scale",e)}),t.addControl(this.scaleButton),this.panel.addControl(t),this.updateGizmoButtonStates()}createGizmoButtons(e){const t=new BABYLON.GUI.StackPanel;t.height="40px",t.isVertical=!1,t.paddingLeft="5px",this.moveButton=BABYLON.GUI.Button.CreateSimpleButton("moveGizmo","Move"),this.moveButton.width="90px",this.moveButton.height="35px",this.moveButton.color="white",this.moveButton.background="#3a3a3a",this.moveButton.fontSize=13,this.moveButton.cornerRadius=4,this.moveButton.paddingRight="3px",this.moveButton.onPointerClickObservable.add(()=>{this.toggleGizmoMode("move")}),t.addControl(this.moveButton),this.rotateButton=BABYLON.GUI.Button.CreateSimpleButton("rotateGizmo","Rotate"),this.rotateButton.width="90px",this.rotateButton.height="35px",this.rotateButton.color="white",this.rotateButton.background="#3a3a3a",this.rotateButton.fontSize=13,this.rotateButton.cornerRadius=4,this.rotateButton.paddingLeft="3px",this.rotateButton.paddingRight="3px",this.rotateButton.onPointerClickObservable.add(()=>{this.toggleGizmoMode("rotate")}),t.addControl(this.rotateButton),this.scaleButton=BABYLON.GUI.Button.CreateSimpleButton("scaleGizmo","Scale"),this.scaleButton.width="90px",this.scaleButton.height="35px",this.scaleButton.color="white",this.scaleButton.background="#3a3a3a",this.scaleButton.fontSize=13,this.scaleButton.cornerRadius=4,this.scaleButton.paddingLeft="3px",this.scaleButton.onPointerClickObservable.add(()=>{this.toggleGizmoMode("scale")}),t.addControl(this.scaleButton),this.panel.addControl(t);const i=new BABYLON.GUI.StackPanel;i.height="30px",i.isVertical=!1,i.paddingLeft="5px",i.paddingTop="5px";const o=new BABYLON.GUI.Checkbox;o.name="uniformScale",o.width="20px",o.height="20px",o.isChecked=this.uniformScaling,o.color="#4a9eff",o.background="#3a3a3a",o.onIsCheckedChangedObservable.add(s=>{this.uniformScaling=s,this.editor.updateScaleGizmoUniformMode(s)}),i.addControl(o);const n=new BABYLON.GUI.TextBlock;n.text=" Lock Aspect Ratio",n.width="150px",n.height="20px",n.color="white",n.fontSize=12,n.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,n.paddingLeft="5px",i.addControl(n),this.panel.addControl(i),this.uniformScaleCheckbox=i,this.updateGizmoButtonStates()}toggleLightGizmoMode(e,t){this.activeGizmoMode===e?(this.activeGizmoMode=null,this.editor.setLightGizmoMode(null,t)):(this.activeGizmoMode=e,this.editor.setLightGizmoMode(e,t)),this.updateGizmoButtonStates()}toggleGizmoMode(e){this.activeGizmoMode===e?(this.activeGizmoMode=null,this.editor.setGizmoMode(null)):(this.activeGizmoMode=e,this.editor.setGizmoMode(e)),this.updateGizmoButtonStates()}updateGizmoButtonStates(){this.moveButton&&(this.activeGizmoMode==="move"?this.moveButton.background="#4a9eff":this.moveButton.background="#3a3a3a"),this.rotateButton&&(this.activeGizmoMode==="rotate"?this.rotateButton.background="#4a9eff":this.rotateButton.background="#3a3a3a"),this.scaleButton&&(this.activeGizmoMode==="scale"?this.scaleButton.background="#4a9eff":this.scaleButton.background="#3a3a3a"),this.uniformScaleCheckbox&&(this.uniformScaleCheckbox.isVisible=this.activeGizmoMode==="scale")}addSectionHeader(e){const t=new BABYLON.GUI.TextBlock;t.text=e,t.height="25px",t.color="white",t.fontSize=14,t.fontWeight="bold",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.paddingLeft="5px",this.panel.addControl(t)}addVector3Control(e,t,i){const o=new BABYLON.GUI.StackPanel;o.height="30px",o.isVertical=!1;const n=new BABYLON.GUI.TextBlock;n.text=e+":",n.width="30px",n.color="white",n.fontSize=12,n.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,o.addControl(n);const s=new BABYLON.GUI.InputText;s.width="240px",s.height="25px",s.color="white",s.background="#3a3a3a",s.text=t.toFixed(2),s.fontSize=12,s.onTextChangedObservable.add(r=>{const l=parseFloat(r.text);isNaN(l)||i(l)}),o.addControl(s),this.panel.addControl(o)}}class P{constructor(e,t){this.editor=e,this.guiTexture=t,this.panel=null,this.scrollViewer=null,this.objectButtons=new Map,this.isVisible=!0,this.initialize()}initialize(){this.scrollViewer=new BABYLON.GUI.ScrollViewer,this.scrollViewer.width="240px",this.scrollViewer.height="45%",this.scrollViewer.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,this.scrollViewer.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM,this.scrollViewer.left="10px",this.scrollViewer.top="-50px",this.scrollViewer.background="#2a2a2a",this.scrollViewer.thickness=2,this.scrollViewer.thumbLength=.5,this.scrollViewer.barColor="#4a9eff",this.scrollViewer.barBackground="#1a1a1a",this.scrollViewer.isPointerBlocker=!0,this.guiTexture.addControl(this.scrollViewer),this.panel=new BABYLON.GUI.StackPanel,this.panel.width="200px",this.scrollViewer.addControl(this.panel),this.editor.selectionManager.addSelectionCallback(e=>{this.highlightSelected(e)}),this.refresh(),console.log("SceneHierarchy initialized with 45% height and scrolling")}refresh(){this.panel.clearControls(),this.objectButtons.clear();const e=new BABYLON.GUI.StackPanel;e.height="35px",e.width="190px",e.isVertical=!1,this.panel.addControl(e);const t=new BABYLON.GUI.TextBlock;t.text="Scene Hierarchy",t.width="140px",t.color="#4a9eff",t.fontSize=16,t.fontWeight="bold",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.paddingLeft="5px",e.addControl(t);const i=BABYLON.GUI.Button.CreateSimpleButton(`hierarchy_refresh_${Date.now()}`,"â†»");i.width="40px",i.height="30px",i.color="white",i.background="#4a9eff",i.fontSize=18,i.cornerRadius=3,i.thickness=0,i.onPointerEnterObservable.add(()=>{i.background="#5ab0ff"}),i.onPointerOutObservable.add(()=>{i.background="#4a9eff"}),i.onPointerClickObservable.add(()=>{this.refresh(),console.log("Scene hierarchy manually refreshed")}),e.addControl(i);const o=this.editor.scene.meshes.filter(s=>!s.name.startsWith("_")),n=this.editor.scene.lights;this.addSection("Meshes",o),this.addSection("Lights",n)}addSection(e,t){if(t.length===0)return;const i=new BABYLON.GUI.TextBlock;i.text=e,i.height="25px",i.color="white",i.fontSize=14,i.fontWeight="bold",i.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,i.paddingLeft="5px",this.panel.addControl(i),t.forEach(n=>{const s=this.createObjectButton(n);this.panel.addControl(s),this.objectButtons.set(n,s)});const o=new BABYLON.GUI.Container;o.height="5px",this.panel.addControl(o)}createObjectButton(e){const t=BABYLON.GUI.Button.CreateSimpleButton(`hierarchy_${e.name}_${Date.now()}`,e.name);return t.width="180px",t.height="25px",t.color="white",t.background="#333",t.fontSize=12,t.cornerRadius=2,t.paddingLeft="10px",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.onPointerEnterObservable.add(()=>{this.editor.selectionManager.selectedObject!==e&&(t.background="#444")}),t.onPointerOutObservable.add(()=>{this.editor.selectionManager.selectedObject!==e&&(t.background="#333")}),t.onPointerClickObservable.add(()=>{this.editor.selectionManager.selectObject(e)}),t}highlightSelected(e){this.objectButtons.forEach((t,i)=>{i===e?t.background="#4a9eff":t.background="#333"})}show(){this.scrollViewer&&(this.scrollViewer.isVisible=!0,this.isVisible=!0)}hide(){this.scrollViewer&&(this.scrollViewer.isVisible=!1,this.isVisible=!1)}}class G{constructor(e,t){this.guiTexture=e,this.pipeline=t,this.panel=null,this.scrollViewer=null,this.isVisible=!1,this.toggleButton=null,this.initialize()}initialize(){this.toggleButton=BABYLON.GUI.Button.CreateSimpleButton("settingsToggle","âš™ Settings"),this.toggleButton.width="100px",this.toggleButton.height="30px",this.toggleButton.color="white",this.toggleButton.background="#2a2a2a",this.toggleButton.fontSize=14,this.toggleButton.cornerRadius=4,this.toggleButton.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT,this.toggleButton.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,this.toggleButton.top="50px",this.toggleButton.left="-10px",this.toggleButton.onPointerClickObservable.add(()=>{this.toggle()}),this.guiTexture.addControl(this.toggleButton),this.scrollViewer=new BABYLON.GUI.ScrollViewer,this.scrollViewer.width="320px",this.scrollViewer.height="500px",this.scrollViewer.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT,this.scrollViewer.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,this.scrollViewer.top="90px",this.scrollViewer.left="-10px",this.scrollViewer.background="#2a2a2a",this.scrollViewer.thickness=2,this.scrollViewer.barColor="#4a9eff",this.scrollViewer.barBackground="#1a1a1a",this.scrollViewer.isVisible=!1,this.scrollViewer.isPointerBlocker=!0,this.guiTexture.addControl(this.scrollViewer),this.panel=new BABYLON.GUI.StackPanel,this.panel.width="300px",this.scrollViewer.addControl(this.panel),this.createControls(),console.log("SettingsPanel initialized")}createControls(){const e=this.createHeader("Post-Processing Settings");this.panel.addControl(e),this.addCheckbox("FXAA Antialiasing",this.pipeline.fxaaEnabled,t=>{this.pipeline.fxaaEnabled=t}),this.addSectionHeader("Bloom"),this.addCheckbox("Enable Bloom",this.pipeline.bloomEnabled,t=>{this.pipeline.bloomEnabled=t}),this.addSlider("Bloom Threshold",this.pipeline.bloomThreshold,0,1,t=>{this.pipeline.bloomThreshold=t}),this.addSlider("Bloom Weight",this.pipeline.bloomWeight,0,1,t=>{this.pipeline.bloomWeight=t}),this.addSlider("Bloom Scale",this.pipeline.bloomScale,0,1,t=>{this.pipeline.bloomScale=t}),this.addSectionHeader("Image Processing"),this.addSlider("Contrast",this.pipeline.imageProcessing.contrast,.5,2,t=>{this.pipeline.imageProcessing.contrast=t}),this.addSlider("Exposure",this.pipeline.imageProcessing.exposure,.5,2,t=>{this.pipeline.imageProcessing.exposure=t}),this.addSectionHeader("Vignette"),this.addCheckbox("Enable Vignette",this.pipeline.imageProcessing.vignetteEnabled,t=>{this.pipeline.imageProcessing.vignetteEnabled=t}),this.addSlider("Vignette Weight",this.pipeline.imageProcessing.vignetteWeight,0,4,t=>{this.pipeline.imageProcessing.vignetteWeight=t}),this.addSectionHeader("Chromatic Aberration"),this.addCheckbox("Enable Chromatic Aberration",this.pipeline.chromaticAberrationEnabled,t=>{this.pipeline.chromaticAberrationEnabled=t}),this.addSlider("Aberration Amount",this.pipeline.chromaticAberration.aberrationAmount,0,100,t=>{this.pipeline.chromaticAberration.aberrationAmount=t}),this.addSectionHeader("Film Grain"),this.addCheckbox("Enable Grain",this.pipeline.grainEnabled,t=>{this.pipeline.grainEnabled=t}),this.addSlider("Grain Intensity",this.pipeline.grain.intensity,0,50,t=>{this.pipeline.grain.intensity=t}),this.addCheckbox("Animated Grain",this.pipeline.grain.animated,t=>{this.pipeline.grain.animated=t}),this.addSectionHeader("Sharpen"),this.addCheckbox("Enable Sharpen",this.pipeline.sharpenEnabled,t=>{this.pipeline.sharpenEnabled=t}),this.addSlider("Edge Amount",this.pipeline.sharpen.edgeAmount,0,1,t=>{this.pipeline.sharpen.edgeAmount=t}),this.addSlider("Color Amount",this.pipeline.sharpen.colorAmount,0,1,t=>{this.pipeline.sharpen.colorAmount=t})}createHeader(e){const t=new BABYLON.GUI.TextBlock;return t.text=e,t.height="40px",t.color="#4a9eff",t.fontSize=18,t.fontWeight="bold",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.paddingLeft="10px",t}addSectionHeader(e){const t=new BABYLON.GUI.TextBlock;t.text=e,t.height="30px",t.color="white",t.fontSize=14,t.fontWeight="bold",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.paddingLeft="10px",t.paddingTop="10px",this.panel.addControl(t)}addCheckbox(e,t,i){const o=new BABYLON.GUI.StackPanel;o.height="30px",o.isVertical=!1,o.paddingLeft="10px";const n=new BABYLON.GUI.Checkbox;n.width="20px",n.height="20px",n.isChecked=t,n.color="#4a9eff",n.background="#3a3a3a",n.onIsCheckedChangedObservable.add(r=>{i(r)});const s=new BABYLON.GUI.TextBlock;s.text=e,s.width="250px",s.height="20px",s.color="white",s.fontSize=12,s.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,s.paddingLeft="10px",o.addControl(n),o.addControl(s),this.panel.addControl(o)}addSlider(e,t,i,o,n){const s=new BABYLON.GUI.TextBlock;s.text=`${e}: ${t.toFixed(2)}`,s.height="25px",s.color="white",s.fontSize=12,s.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,s.paddingLeft="10px",this.panel.addControl(s);const r=new BABYLON.GUI.Slider;r.minimum=i,r.maximum=o,r.value=t,r.height="20px",r.width="280px",r.color="#4a9eff",r.background="#3a3a3a",r.borderColor="#4a9eff",r.onValueChangedObservable.add(c=>{s.text=`${e}: ${c.toFixed(2)}`,n(c)}),this.panel.addControl(r);const l=new BABYLON.GUI.Container;l.height="5px",this.panel.addControl(l)}toggle(){this.isVisible=!this.isVisible,this.scrollViewer.isVisible=this.isVisible,this.isVisible?this.toggleButton.background="#4a9eff":this.toggleButton.background="#2a2a2a"}show(){this.isVisible=!0,this.scrollViewer.isVisible=!0,this.toggleButton.background="#4a9eff"}hide(){this.isVisible=!1,this.scrollViewer.isVisible=!1,this.toggleButton.background="#2a2a2a"}refresh(){this.panel.clearControls(),this.createControls(),console.log("Settings panel refreshed with loaded values")}}class I{constructor(e){this.scene=e,this.monitorMesh=null,this.dynamicTexture=null,this.originalMaterial=null,this.isActive=!1,this.isPoweredOn=!1,this.debugPanel=null,this.iframe=null,this.captureCanvas=null,this.currentFrame=1,this.frameTimer=0,this.frameDuration=5e3,this.textureWidth=2048,this.textureHeight=2048,console.log("MonitorController initialized (iframe + base64 fonts mode)")}async initialize(){try{return this.createHiddenIframe(),this.captureCanvas=document.createElement("canvas"),this.captureCanvas.width=this.textureWidth,this.captureCanvas.height=this.textureHeight,this.setupMonitorMesh(),console.log("MonitorController initialized - iframe rendering ready"),!0}catch(e){return console.error("Failed to initialize MonitorController:",e),!1}}createHiddenIframe(){this.iframe=document.createElement("iframe"),this.iframe.style.position="absolute",this.iframe.style.left="-9999px",this.iframe.style.width=this.textureWidth+"px",this.iframe.style.height=this.textureHeight+"px",this.iframe.style.border="none",this.iframe.style.background="#0a0a0a",document.body.appendChild(this.iframe),console.log("âœ“ Hidden iframe created")}setupMonitorMesh(){return this.monitorMesh=this.scene.getMeshByName("SM_Prop_ComputerMonitor_B_32_StaticMeshComponent0.screen"),this.monitorMesh||(this.monitorMesh=this.scene.getMeshByName("monitor_screen")),this.monitorMesh?(console.log("âœ“ Monitor mesh found:",this.monitorMesh.name),this.applyMaterialToMesh(),!0):(console.log("Monitor mesh not found yet, waiting for scene to load..."),this.setupMeshObserver(),!1)}setupMeshObserver(){const e=setInterval(()=>{this.monitorMesh=this.scene.getMeshByName("SM_Prop_ComputerMonitor_B_32_StaticMeshComponent0.screen"),this.monitorMesh||(this.monitorMesh=this.scene.getMeshByName("monitor_screen")),this.monitorMesh&&(console.log("âœ“ Monitor mesh found:",this.monitorMesh.name),clearInterval(e),this.applyMaterialToMesh())},200);setTimeout(()=>{clearInterval(e),this.monitorMesh||console.warn("âš  Monitor mesh not found after 10s")},1e4)}async loadFrame(e){if(!(!this.iframe||!this.dynamicTexture))try{this.iframe.src=`src/monitor/frames/${e}.html`,await new Promise((i,o)=>{const n=setTimeout(()=>o(new Error("Iframe load timeout")),5e3);this.iframe.onload=()=>{clearTimeout(n),i()},this.iframe.onerror=()=>{clearTimeout(n),o(new Error("Iframe load error"))}});const t=this.iframe.contentDocument||this.iframe.contentWindow.document;t.fonts&&await t.fonts.ready,await new Promise(i=>setTimeout(i,200)),await this.captureIframeToTexture(),console.log(`âœ“ Frame ${e} loaded and captured`)}catch(t){console.error(`Failed to load frame ${e}:`,t)}}async captureIframeToTexture(){try{const e=this.iframe.contentDocument||this.iframe.contentWindow.document;if(!e)throw new Error("Cannot access iframe document");const i=new XMLSerializer().serializeToString(e.documentElement),o=`
        <svg xmlns="http://www.w3.org/2000/svg" width="${this.textureWidth}" height="${this.textureHeight}">
          <foreignObject width="100%" height="100%">
            ${i}
          </foreignObject>
        </svg>
      `,s=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(o)))}`,r=new Image;return new Promise((l,c)=>{const d=setTimeout(()=>{c(new Error("Image load timeout"))},5e3);r.onload=()=>{clearTimeout(d);try{const m=document.createElement("canvas");m.width=this.textureWidth,m.height=this.textureHeight,m.getContext("2d",{willReadFrequently:!0}).drawImage(r,0,0,this.textureWidth,this.textureHeight);const x=this.dynamicTexture.getContext();x.clearRect(0,0,this.textureWidth,this.textureHeight),x.drawImage(m,0,0,this.textureWidth,this.textureHeight),this.dynamicTexture.update(),l()}catch(m){c(m)}},r.onerror=m=>{clearTimeout(d),c(new Error("Failed to load SVG image"))},r.src=s})}catch(e){throw console.error("Capture error:",e),e}}async applyMaterialToMesh(){this.monitorMesh&&(console.log("âœ“ Monitor mesh found:",this.monitorMesh.name),this.originalMaterial=this.monitorMesh.material,this.dynamicTexture=new BABYLON.DynamicTexture("monitorTexture",{width:this.textureWidth,height:this.textureHeight},this.scene,!1),this.dynamicTexture.wAng=270*Math.PI/180,this.dynamicTexture.uScale=1,this.dynamicTexture.vScale=-1,this.dynamicTexture.uOffset=0,this.dynamicTexture.vOffset=1,this.showBlackScreen(),this.originalMaterial&&(this.originalMaterial.albedoTexture!==void 0?(this.originalMaterial.albedoTexture=this.dynamicTexture,this.originalMaterial.emissiveTexture=this.dynamicTexture,this.originalMaterial.emissiveColor=new BABYLON.Color3(1,1,1),this.originalMaterial.emissiveIntensity=1,this.originalMaterial.unlit=!0):(this.originalMaterial.diffuseTexture=this.dynamicTexture,this.originalMaterial.emissiveTexture=this.dynamicTexture,this.originalMaterial.emissiveColor=new BABYLON.Color3(1,1,1),this.originalMaterial.disableLighting=!0)),console.log("âœ“ DynamicTexture created and applied"),console.log("âœ“ Monitor ready"))}handleInput(e){this.isActive}createControlFromJSON(e){let t=null;switch(e.className){case"Rectangle":t=new BABYLON.GUI.Rectangle(e.name),e.background&&(t.background=e.background),e.color&&(t.color=e.color),e.thickness!==void 0&&(t.thickness=e.thickness),e.cornerRadius!==void 0&&(t.cornerRadius=e.cornerRadius);break;case"TextBlock":t=new BABYLON.GUI.TextBlock(e.name),e.text&&(t.text=e.text),e.color&&(t.color=e.color),e.fontSize&&(t.fontSize=e.fontSize),e.fontFamily&&(t.fontFamily=e.fontFamily),e.fontStyle&&(t.fontStyle=e.fontStyle),e.fontWeight&&(t.fontWeight=e.fontWeight),e.textHorizontalAlignment!==void 0&&(t.textHorizontalAlignment=e.textHorizontalAlignment),e.textVerticalAlignment!==void 0&&(t.textVerticalAlignment=e.textVerticalAlignment),e.textWrapping!==void 0&&(t.textWrapping=e.textWrapping);break;case"Ellipse":t=new BABYLON.GUI.Ellipse(e.name),e.background&&(t.background=e.background),e.color&&(t.color=e.color),e.thickness!==void 0&&(t.thickness=e.thickness);break;case"Image":t=new BABYLON.GUI.Image(e.name,e.source),e.stretch!==void 0&&(t.stretch=e.stretch),e.sourceLeft!==void 0&&(t.sourceLeft=e.sourceLeft),e.sourceTop!==void 0&&(t.sourceTop=e.sourceTop),e.sourceWidth!==void 0&&(t.sourceWidth=e.sourceWidth),e.sourceHeight!==void 0&&(t.sourceHeight=e.sourceHeight),e.autoScale!==void 0&&(t.autoScale=e.autoScale);break;case"Line":t=new BABYLON.GUI.Line(e.name),e.lineWidth!==void 0&&(t.lineWidth=e.lineWidth),e.color&&(t.color=e.color),e.x1!==void 0&&(t.x1=e.x1),e.y1!==void 0&&(t.y1=e.y1),e.x2!==void 0&&(t.x2=e.x2),e.y2!==void 0&&(t.y2=e.y2),e.dash!==void 0&&(t.dash=e.dash),e.connectedControl&&(t.connectedControl=e.connectedControl);break;case"InputText":t=new BABYLON.GUI.InputText(e.name),e.text&&(t.text=e.text),e.color&&(t.color=e.color),e.background&&(t.background=e.background),e.fontSize&&(t.fontSize=e.fontSize),e.fontFamily&&(t.fontFamily=e.fontFamily),e.fontStyle&&(t.fontStyle=e.fontStyle),e.fontWeight&&(t.fontWeight=e.fontWeight),e.placeholderText&&(t.placeholderText=e.placeholderText),e.placeholderColor&&(t.placeholderColor=e.placeholderColor),e.thickness!==void 0&&(t.thickness=e.thickness),e.focusedBackground&&(t.focusedBackground=e.focusedBackground),e.textHighlightColor&&(t.textHighlightColor=e.textHighlightColor),e.highligherOpacity!==void 0&&(t.highligherOpacity=e.highligherOpacity),e.maxWidth&&(t.maxWidth=e.maxWidth),e.autoStretchWidth!==void 0&&(t.autoStretchWidth=e.autoStretchWidth);break;default:return console.warn("Unknown control type:",e.className),null}return t&&(e.width&&(t.width=e.width),e.height&&(t.height=e.height),e.left&&(t.left=e.left),e.top&&(t.top=e.top),e.horizontalAlignment!==void 0&&(t.horizontalAlignment=e.horizontalAlignment),e.verticalAlignment!==void 0&&(t.verticalAlignment=e.verticalAlignment),e.alpha!==void 0&&(t.alpha=e.alpha),e.isVisible!==void 0&&(t.isVisible=e.isVisible)),t}showBlackScreen(){if(!this.dynamicTexture)return;const e=this.dynamicTexture.getContext();e.fillStyle="#000000",e.fillRect(0,0,this.textureWidth,this.textureHeight),this.dynamicTexture.update()}async powerOn(){if(!this.isPoweredOn){this.isPoweredOn=!0,this.currentFrame=1,this.frameTimer=0;try{const t=await(await fetch("src/monitor/frames/frames-config.json")).json(),i=t.activeFrame,o=t.frames[i];if(o&&o.file){const n=o.file.replace(".html","");await this.loadFrame(n),console.log(`âœ“ Monitor powered on - ${o.name} loaded`)}else console.error("No active frame found in config")}catch(e){console.error("Failed to load frames config:",e)}}}activate(){this.isPoweredOn||this.powerOn(),this.isActive=!0,console.log("âœ“ Monitor activated")}deactivate(){this.isActive=!1,console.log("âœ“ Monitor deactivated")}update(){}dispose(){this.dynamicTexture&&this.dynamicTexture.dispose(),this.iframe&&(document.body.removeChild(this.iframe),this.iframe=null),console.log("MonitorController disposed")}}class k{constructor(e){this.scene=e,this.interactiveButtons=new Map,this.buttonStates=new Map,this.rightSequence=this.generateRandomSequence(),this.currentSequence=[1,1,1,1,1,1,1,1,1,1],this.solvedColumns=[!1,!1,!1,!1,!1],this.currentDraggingLever=null,this.leverObserversSetup=!1,this.initialize()}generateRandomSequence(){const e=[4,3,8,2,6];return console.log("ðŸŽ¯ Target sequence (5 columns):",e),e}initialize(){this.setupGlobalLeverObservers(),this.registerAllInteractiveElements(),console.log("MachineInteractions initialized")}registerAllInteractiveElements(){for(const[e,t]of Object.entries(A)){const i=t.interactiveElements;for(const[o,n]of Object.entries(i)){const s=`${e}_${o}`;n.type==="button"?this.registerButton(s,n):n.type==="dial"?this.registerDialFromConfig(s,n):n.type==="lever"&&this.registerLever(s,n)}}}registerButton(e,t){const i=this.scene.getMeshByName(t.meshName);if(!i){console.warn(`Button mesh not found: ${t.meshName}`),setTimeout(()=>this.registerButton(e,t),1e3);return}i.isPickable=!0;const o=i.position.clone();this.interactiveButtons.set(e,{mesh:i,originalPosition:o,pressDepth:t.pressOffset,isPressed:!1,action:t.action}),i.actionManager=new BABYLON.ActionManager(this.scene),i.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger,()=>{document.body.style.cursor="pointer"})),i.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOutTrigger,()=>{document.body.style.cursor="default"})),i.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger,()=>{this.pressButton(e)})),console.log(`âœ“ Button registered: ${t.meshName}`)}pressButton(e){const t=this.interactiveButtons.get(e);if(!t||t.isPressed)return;t.isPressed=!0;const i=t.mesh;console.log(`ðŸ”˜ Button pressed: ${e}`);const o=new BABYLON.Vector3(t.pressDepth.x,t.pressDepth.y,t.pressDepth.z),n=t.originalPosition.add(o),s=new BABYLON.Animation("buttonPressAnimation","position",60,BABYLON.Animation.ANIMATIONTYPE_VECTOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);s.setKeys([{frame:0,value:i.position.clone()},{frame:5,value:n}]);const r=new BABYLON.Animation("buttonReleaseAnimation","position",60,BABYLON.Animation.ANIMATIONTYPE_VECTOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);r.setKeys([{frame:0,value:n},{frame:10,value:t.originalPosition}]),i.animations=[s],this.scene.beginAnimation(i,0,5,!1,2,()=>{i.animations=[r],this.scene.beginAnimation(i,0,10,!1,1,()=>{t.isPressed=!1,this.onButtonPressed(e,t.action)})})}onButtonPressed(e,t){console.log(`âš¡ Button action: ${t}`),t==="togglePower"&&(e.includes("computer_monitor")?this.toggleMonitorPower():e.includes("computer_audio_machine")?this.toggleCassettePlayerPower():e.includes("cube18_machine")?this.toggleRadioPower():window.monitorController&&(window.monitorController.activate(),console.log("âœ“ Monitor activated")))}toggleMonitorPower(){if(!window.monitorController){console.warn("Monitor controller not found");return}window.monitorController.isActive?(window.monitorController.deactivate(),this.setMonitorLED(!1),console.log("âœ“ Monitor powered off")):(window.monitorController.activate(),this.setMonitorLED(!0),console.log("âœ“ Monitor powered on"))}setMonitorLED(e){const t=this.scene.getMeshByName("SM_Prop_ComputerMonitor_B_32_StaticMeshComponent0.powerled");if(!t){console.warn("Monitor LED mesh not found"),setTimeout(()=>this.setMonitorLED(e),500);return}if(!t.material||t.material.name!=="monitorLEDMat"){const i=new BABYLON.StandardMaterial("monitorLEDMat",this.scene);t.material=i}e?(t.material.emissiveColor=new BABYLON.Color3(0,1,0),t.material.diffuseColor=new BABYLON.Color3(0,.5,0)):(t.material.emissiveColor=new BABYLON.Color3(0,0,0),t.material.diffuseColor=new BABYLON.Color3(.1,.1,.1))}async toggleCassettePlayerPower(){const e=this.scene.getMeshByName("SM_ComputerParts_C05_N1_54_StaticMeshComponent0.screen");if(!e){console.warn("Cassette display mesh not found"),setTimeout(()=>this.toggleCassettePlayerPower(),500);return}e.material&&e.material.name!=="cassetedisplay"&&console.warn('Expected material "cassetedisplay" but found:',e.material.name),this.cassettePlayerPowered===void 0&&(this.cassettePlayerPowered=!1),this.cassettePlayerPowered=!this.cassettePlayerPowered,this.cassettePlayerPowered?(await this.loadCassettePlayerGUI(e),this.playCassetteAudio(),console.log("âœ“ Cassette player powered on")):(this.cassetteGUITexture&&this.cassetteGUITexture.rootContainer.clearControls(),this.stopCassetteAudio(),console.log("âœ“ Cassette player powered off"))}async loadCassettePlayerGUI(e){this.cassetteGUITexture||(this.cassetteGUITexture=BABYLON.GUI.AdvancedDynamicTexture.CreateForMeshTexture(e,1024,1024),this.cassetteGUITexture.rootContainer.rotation=4.7124,this.cassetteGUITexture.rootContainer.scaleX=1,this.cassetteGUITexture.rootContainer.scaleY=1,this.cassetteGUITexture.rootContainer.left=0,this.cassetteGUITexture.rootContainer.top=0,this.cassetteGUITexture.uScale=1,this.cassetteGUITexture.vScale=1,this.cassetteGUITexture.uOffset=0,this.cassetteGUITexture.vOffset=0,this.cassetteGUITexture.uAng=Math.PI,this.cassetteGUITexture.vAng=0,this.cassetteGUITexture.wAng=0,this.cassetteOriginalMaterial=e.material,this.cassetteOriginalMaterial&&(this.cassetteOriginalMaterial.albedoTexture!==void 0?(this.cassetteOriginalMaterial.albedoTexture=this.cassetteGUITexture,this.cassetteOriginalMaterial.emissiveTexture=this.cassetteGUITexture,this.cassetteOriginalMaterial.emissiveColor=new BABYLON.Color3(1,1,1),this.cassetteOriginalMaterial.emissiveIntensity=1,this.cassetteOriginalMaterial.unlit=!0):(this.cassetteOriginalMaterial.diffuseTexture=this.cassetteGUITexture,this.cassetteOriginalMaterial.emissiveTexture=this.cassetteGUITexture,this.cassetteOriginalMaterial.emissiveColor=new BABYLON.Color3(1,1,1),this.cassetteOriginalMaterial.disableLighting=!0)),console.log("âœ“ Cassette GUI texture created"));try{const i=await(await fetch("textures/casseteplayer/frame1.json")).json();if(this.cassetteGUITexture.rootContainer.clearControls(),i.root&&i.root.children)for(const o of i.root.children){const n=await this.createControlFromJSON(o);n&&(this.cassetteGUITexture.addControl(n),n.name==="Textblock"&&o.text&&o.text.includes(":")&&(this.cassetteTimeText=n,console.log("âœ“ Found time text control")))}console.log("âœ“ Cassette player GUI loaded")}catch(t){console.error("Failed to load cassette player GUI:",t)}}async createControlFromJSON(e){const t=e.className;let i=null;return t==="Image"?(i=new BABYLON.GUI.Image(e.name,e.source),e.stretch!==void 0&&(i.stretch=e.stretch)):t==="TextBlock"?(i=new BABYLON.GUI.TextBlock(e.name,e.text),e.textHorizontalAlignment!==void 0&&(i.textHorizontalAlignment=e.textHorizontalAlignment),e.textVerticalAlignment!==void 0&&(i.textVerticalAlignment=e.textVerticalAlignment),e.fontSize&&(i.fontSize=e.fontSize),e.fontFamily&&(i.fontFamily=e.fontFamily),e.color&&(i.color=e.color)):t==="Rectangle"?(i=new BABYLON.GUI.Rectangle(e.name),e.background&&(i.background=e.background),e.thickness!==void 0&&(i.thickness=e.thickness),e.cornerRadius!==void 0&&(i.cornerRadius=e.cornerRadius)):t==="Container"?i=new BABYLON.GUI.Container(e.name):t==="StackPanel"?i=new BABYLON.GUI.StackPanel(e.name):t==="Button"?(i=BABYLON.GUI.Button.CreateSimpleButton(e.name,e.text||""),e.background&&(i.background=e.background)):t==="Ellipse"&&(i=new BABYLON.GUI.Ellipse(e.name),e.background&&(i.background=e.background),e.thickness!==void 0&&(i.thickness=e.thickness)),i?(e.width&&(i.width=e.width),e.height&&(i.height=e.height),e.left&&(i.left=e.left),e.top&&(i.top=e.top),e.horizontalAlignment!==void 0&&(i.horizontalAlignment=e.horizontalAlignment),e.verticalAlignment!==void 0&&(i.verticalAlignment=e.verticalAlignment),e.isVisible!==void 0&&(i.isVisible=e.isVisible),e.color&&(i.color=e.color),e.alpha!==void 0&&(i.alpha=e.alpha),i):(console.warn(`Unsupported control type: ${t}`),null)}playCassetteAudio(){this.cassetteAudio||(console.log("ðŸŽµ Creating cassette audio with HTML5 Audio..."),this.cassetteAudio=new Audio("textures/casseteplayer/audio.mp3"),this.cassetteAudio.volume=.5,this.cassetteAudio.loop=!1,this.cassetteAudio.addEventListener("ended",()=>{console.log("ðŸŽµ Cassette audio finished - powering off"),this.cassettePlayerPowered=!1,this.cassetteGUITexture&&this.cassetteGUITexture.rootContainer.clearControls(),this.stopTimeUpdate()}),this.cassetteAudio.addEventListener("error",t=>{console.error("ðŸŽµ Audio error:",t)}),this.cassetteAudio.addEventListener("canplaythrough",()=>{console.log("ðŸŽµ Audio loaded and ready")})),console.log("ðŸŽµ Attempting to play audio...");const e=this.cassetteAudio.play();e!==void 0&&e.then(()=>{console.log("ðŸŽµ Audio playing successfully!"),this.startTimeUpdate()}).catch(t=>{console.error("ðŸŽµ Failed to play audio:",t)})}startTimeUpdate(){this.timeUpdateInterval=setInterval(()=>{if(this.cassetteAudio&&this.cassetteTimeText){const e=this.cassetteAudio.currentTime,t=Math.floor(e/60),i=Math.floor(e%60),o=`00:${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`;this.cassetteTimeText.text=o}},100)}stopTimeUpdate(){this.timeUpdateInterval&&(clearInterval(this.timeUpdateInterval),this.timeUpdateInterval=null)}stopCassetteAudio(){this.cassetteAudio&&(this.cassetteAudio.pause(),this.cassetteAudio.currentTime=0,console.log("ðŸŽµ Cassette audio stopped")),this.stopTimeUpdate()}registerDialFromConfig(e,t){const i=this.scene.getMeshByName(t.meshName);if(!i){console.warn(`Dial mesh not found: ${t.meshName}`),setTimeout(()=>this.registerDialFromConfig(e,t),1e3);return}i.isPickable=!0;const o=i.rotationQuaternion?i.rotationQuaternion.clone():BABYLON.Quaternion.FromEulerAngles(i.rotation.x,i.rotation.y,i.rotation.z);this.interactiveButtons.set(e,{mesh:i,originalRotation:o,currentAngle:0,rotationAxis:new BABYLON.Vector3(t.rotationAxis.x,t.rotationAxis.y,t.rotationAxis.z).normalize(),isDragging:!1,lastMouseX:0,sensitivity:t.sensitivity,action:t.action}),this.setupDialDrag(i,e),console.log(`âœ“ Dial registered: ${t.meshName}`)}registerDial(){const e=this.scene.getMeshByName("SM_ComputerParts_C05_N1_54_StaticMeshComponent0.dial");if(!e){console.warn("Dial mesh not found"),setTimeout(()=>this.registerDial(),1e3);return}e.isPickable=!0;const t=e.rotationQuaternion?e.rotationQuaternion.clone():BABYLON.Quaternion.FromEulerAngles(e.rotation.x,e.rotation.y,e.rotation.z);this.interactiveButtons.set("dial",{mesh:e,originalRotation:t,currentAngle:0,rotationAxis:new BABYLON.Vector3(0,0,1).normalize(),isDragging:!1,lastMouseX:0,sensitivity:.01}),this.setupDialDrag(e),console.log("âœ“ Dial registered:",e.name)}setupDialDrag(e,t){const i=this.interactiveButtons.get(t);e.actionManager=new BABYLON.ActionManager(this.scene),e.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger,()=>{document.body.style.cursor="grab"})),e.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOutTrigger,()=>{i.isDragging||(document.body.style.cursor="default")})),e.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickDownTrigger,o=>{i.isDragging=!0,i.lastMouseX=this.scene.pointerX,document.body.style.cursor="grabbing",console.log("ðŸŽ›ï¸ Started dragging dial")})),this.scene.onPointerObservable.add(o=>{if(o.type===BABYLON.PointerEventTypes.POINTERMOVE&&i.isDragging){const n=this.scene.pointerX-i.lastMouseX;i.lastMouseX=this.scene.pointerX,i.currentAngle-=n*i.sensitivity,i.action==="adjustVolume"&&(i.currentAngle=Math.max(-Math.PI/2,Math.min(Math.PI/2,i.currentAngle)));const s=BABYLON.Quaternion.RotationAxis(i.rotationAxis,i.currentAngle);e.rotationQuaternion=i.originalRotation.multiply(s),i.action==="adjustVolume"&&this.adjustCassetteVolume(i.currentAngle)}}),this.scene.onPointerObservable.add(o=>{o.type===BABYLON.PointerEventTypes.POINTERUP&&i.isDragging&&(i.isDragging=!1,document.body.style.cursor="grab",console.log("ðŸŽ›ï¸ Stopped dragging dial at angle:",i.currentAngle.toFixed(2)),this.onDialRotated(t,i.currentAngle,i.action))})}onDialRotated(e,t,i){console.log(`ðŸŽ›ï¸ Dial ${e} rotated to angle:`,t.toFixed(2),"radians"),i==="adjustVolume"&&this.adjustCassetteVolume(t)}adjustCassetteVolume(e){if(!this.cassetteAudio)return;let t=1-(e+Math.PI/2)/Math.PI;const i=Math.max(0,Math.min(1,t));this.cassetteAudio.volume=i,console.log(`ðŸ”Š Volume: ${(i*100).toFixed(0)}% (angle: ${e.toFixed(2)})`)}async toggleRadioPower(){const e=this.scene.getMeshByName("Cube18_StaticMeshComponent0.screen");if(!e){console.warn("Radio display mesh not found"),setTimeout(()=>this.toggleRadioPower(),500);return}e.material&&e.material.name!=="radiodisplay"&&console.warn('Expected material "radiodisplay" but found:',e.material.name),this.radioPowered===void 0&&(this.radioPowered=!1),this.radioPowered=!this.radioPowered,this.radioPowered?(await this.loadRadioGUI(e),console.log("âœ“ Radio powered on")):(this.radioGUITexture&&this.radioGUITexture.rootContainer.clearControls(),console.log("âœ“ Radio powered off"))}async loadRadioGUI(e){this.radioGUITexture||(this.radioGUITexture=BABYLON.GUI.AdvancedDynamicTexture.CreateForMeshTexture(e,1024,1024),this.radioGUITexture.rootContainer.rotation=1.5708,this.radioGUITexture.rootContainer.scaleX=1,this.radioGUITexture.rootContainer.scaleY=1,this.radioGUITexture.rootContainer.left=-553,this.radioGUITexture.rootContainer.top=-2,this.radioGUITexture.uScale=1,this.radioGUITexture.vScale=1,this.radioGUITexture.uOffset=0,this.radioGUITexture.vOffset=0,this.radioGUITexture.uAng=3.14,this.radioGUITexture.vAng=0,this.radioGUITexture.wAng=0,this.radioOriginalMaterial=e.material,this.radioOriginalMaterial&&(this.radioOriginalMaterial.albedoTexture!==void 0?(this.radioOriginalMaterial.albedoTexture=this.radioGUITexture,this.radioOriginalMaterial.emissiveTexture=this.radioGUITexture,this.radioOriginalMaterial.emissiveColor=new BABYLON.Color3(1,1,1),this.radioOriginalMaterial.emissiveIntensity=1,this.radioOriginalMaterial.unlit=!0):(this.radioOriginalMaterial.diffuseTexture=this.radioGUITexture,this.radioOriginalMaterial.emissiveTexture=this.radioGUITexture,this.radioOriginalMaterial.emissiveColor=new BABYLON.Color3(1,1,1),this.radioOriginalMaterial.disableLighting=!0)),console.log("âœ“ Radio GUI texture created"));try{const i=await(await fetch("textures/radio/radioframe1.json")).json();if(this.radioGUITexture.rootContainer.clearControls(),this.columnBars={},this.columnNumbers={},this.radioBarControls=[],this.radioNumberControls=[],this.radioAllControls=[],i.root&&i.root.children)for(let o=0;o<i.root.children.length;o++){const n=i.root.children[o],s=await this.createControlFromJSON(n);s&&(n.className==="Image"&&(s.zIndex=-1,s.isPointerBlocker=!1),this.radioGUITexture.addControl(s),this.radioAllControls.push({control:s,data:n}),n.className==="Rectangle"?this.radioBarControls.push(s):n.className==="TextBlock"&&this.radioNumberControls.push(s))}console.log("âœ“ Radio GUI loaded"),console.log(`  Total controls: ${this.radioAllControls.length}`),console.log(`  Rectangle controls: ${this.radioBarControls.length}`),console.log(`  TextBlock controls: ${this.radioNumberControls.length}`),this.initializeAllColumns()}catch(t){console.error("Failed to load radio GUI:",t)}}initializeAllColumns(){if(console.log("ðŸŽšï¸ Initializing all equalizer columns (5 columns, 2 levers each)..."),!this.radioPowered){console.log("âš ï¸ Radio is OFF - skipping column initialization");return}for(let e=0;e<10;e++){const t=`cube18_machine_lever${e+1}`,i=this.interactiveButtons.get(t);if(i&&i.currentOffset!==void 0){const o=Math.round((i.currentOffset+1)/2*9)+1;this.currentSequence[e]=o,console.log(`  Lever ${e+1}: offset=${i.currentOffset.toFixed(2)}, height=${o}`)}}for(let e=0;e<5;e++){const t=e*2,i=e*2+1,o=this.currentSequence[t],n=this.currentSequence[i],s=Math.round((o+n)/2);this.updateEqualizerDisplay(e,s),this.checkLeverMatch(e,s)}console.log("âœ“ All 5 columns initialized from current lever positions")}registerLever(e,t){const i=this.scene.getMeshByName(t.meshName);if(!i){console.warn(`Lever mesh not found: ${t.meshName}`),setTimeout(()=>this.registerLever(e,t),1e3);return}i.isPickable=!0;const o=i.position.clone();this.interactiveButtons.set(e,{mesh:i,originalPosition:o,minOffset:new BABYLON.Vector3(t.minOffset.x,t.minOffset.y,t.minOffset.z),maxOffset:new BABYLON.Vector3(t.maxOffset.x,t.maxOffset.y,t.maxOffset.z),currentOffset:0,isDragging:!1,lastMouseY:0,sensitivity:.01}),this.setupLeverDrag(i,e),console.log(`âœ“ Lever registered: ${t.meshName}`)}setupLeverDrag(e,t){const i=this.interactiveButtons.get(t),o=t.match(/lever(\d+)/),n=o?parseInt(o[1])-1:-1;i.leverId=t,i.leverIndex=n,e.actionManager=new BABYLON.ActionManager(this.scene),e.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger,()=>{document.body.style.cursor="ns-resize"})),e.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOutTrigger,()=>{i.isDragging||(document.body.style.cursor="default")})),e.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickDownTrigger,s=>{i.isDragging=!0,i.lastMouseY=this.scene.pointerY,this.currentDraggingLever=t,document.body.style.cursor="ns-resize",console.log("ðŸŽšï¸ Started dragging lever",n+1)}))}setupGlobalLeverObservers(){this.leverObserversSetup||(this.leverObserversSetup=!0,this.scene.onPointerObservable.add(e=>{if(e.type===BABYLON.PointerEventTypes.POINTERMOVE&&this.currentDraggingLever){const t=this.interactiveButtons.get(this.currentDraggingLever);if(!t||!t.isDragging)return;const i=this.scene.pointerY-t.lastMouseY;t.lastMouseY=this.scene.pointerY,t.currentOffset-=i*t.sensitivity,t.currentOffset=Math.max(-1,Math.min(1,t.currentOffset));const o=t.minOffset.scale((1-t.currentOffset)/2).add(t.maxOffset.scale((1+t.currentOffset)/2));t.mesh.position=t.originalPosition.add(o);const n=t.leverIndex;if(n>=0&&n<10){const s=Math.round((t.currentOffset+1)/2*9)+1;this.currentSequence[n]=s;const r=Math.floor(n/2),l=r*2,c=r*2+1,d=this.currentSequence[l],m=this.currentSequence[c],w=Math.round((d+m)/2);this.updateEqualizerDisplay(r,w),this.columnNumbers&&this.columnNumbers[r]&&(this.columnNumbers[r].isVisible=!1)}}}),this.scene.onPointerObservable.add(e=>{if(e.type===BABYLON.PointerEventTypes.POINTERUP&&this.currentDraggingLever){const t=this.interactiveButtons.get(this.currentDraggingLever);if(!t)return;t.isDragging=!1,document.body.style.cursor="default";const i=t.leverIndex;if(i>=0&&i<10){const o=this.currentSequence[i],n=Math.floor(i/2),s=n*2,r=n*2+1,l=this.currentSequence[s],c=this.currentSequence[r],d=Math.round((l+c)/2);console.log(`ðŸŽšï¸ Lever ${i+1} set to ${o}/10 â†’ Column ${n+1} = ${d}/10`),this.checkLeverMatch(n,d)}this.currentDraggingLever=null}}))}updateEqualizerDisplay(e,t){if(!this.radioGUITexture)return;if(!this.radioPowered){console.log(`âš ï¸ Radio is OFF - skipping GUI update for column ${e+1}`);return}this.columnBars||(this.columnBars={}),this.columnBars[e]&&this.columnBars[e].forEach(s=>{s&&!s.isDisposed&&(this.radioGUITexture.removeControl(s),s.dispose())}),this.columnBars[e]=[];const i=this.columnBars[e],o=this.solvedColumns[e],n=o?"#A2E723FF":"#E77123FF";for(let s=0;s<t;s++){const r=new BABYLON.GUI.Rectangle(`col${e}_bar${s}`);r.width="108px",r.height="18px",r.thickness=0,r.background=n,r.left=-280+e*140,r.top=-144-s*22,r.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER,r.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER,r.zIndex=100+e*10+s,this.radioGUITexture.addControl(r),i[s]=r}console.log(`âœ“ Column ${e+1}: Rendered ${t} bars (${o?"GREEN":"ORANGE"})`)}checkLeverMatch(e,t){const i=this.rightSequence[e];t===i?(this.solvedColumns[e]||(this.solvedColumns[e]=!0,console.log(`âœ… Column ${e+1} CORRECT! (${t}/10)`)),this.showCorrectColumn(e,t),this.solvedColumns.every(o=>o)&&(console.log("ðŸŽ‰ PUZZLE SOLVED! All 5 columns correct!"),this.onPuzzleSolved())):this.solvedColumns[e]&&t!==i&&(this.solvedColumns[e]=!1,console.log(`âŒ Column ${e+1} no longer correct`),this.showIncorrectColumn(e))}showCorrectColumn(e,t){if(console.log(`ðŸŸ¢ Column ${e+1} turned green, showing number ${t}`),this.updateEqualizerDisplay(e,t),this.columnNumbers||(this.columnNumbers={}),this.columnNumbers[e])this.columnNumbers[e].text=t.toString(),this.columnNumbers[e].top=-144-t*22-35,this.columnNumbers[e].isVisible=!0;else{const i=new BABYLON.GUI.TextBlock(`column${e}_number`,t.toString());i.width="80px",i.height="50px",i.color="#A2E723FF",i.fontSize="45px",i.fontFamily="Print Char",i.left=-280+e*140,i.top=-144-t*22-35,i.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER,i.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER,i.zIndex=200+e,this.radioGUITexture.addControl(i),this.columnNumbers[e]=i}}showIncorrectColumn(e){console.log(`ðŸŸ  Column ${e+1} back to orange`);const t=e*2,i=e*2+1,o=this.currentSequence[t],n=this.currentSequence[i],s=Math.round((o+n)/2);this.updateEqualizerDisplay(e,s),this.columnNumbers&&this.columnNumbers[e]&&(this.columnNumbers[e].isVisible=!1)}onPuzzleSolved(){console.log("ðŸŽŠ EQUALIZER PUZZLE COMPLETE!")}dispose(){this.interactiveButtons.forEach(e=>{e.mesh.actionManager&&e.mesh.actionManager.dispose()}),this.interactiveButtons.clear(),console.log("MachineInteractions disposed")}}let p=null,u=null,f=null;window.scene=null;window.openAlignmentTool=function(){const a=window.location.origin+"/htmlmesh-align.html";window.open(a,"HtmlMeshAlignment","width=900,height=800,scrollbars=yes"),console.log("âœ“ Alignment tool opened. Use it to align HtmlMesh to monitor screen.")};window.openPositionDebug=function(){const a=window.location.origin+"/htmlmesh-position-debug.html";window.open(a,"HtmlMeshPositionDebug","width=700,height=700,scrollbars=yes"),console.log("âœ“ Position debug tool opened. Use sliders to adjust HtmlMesh position in real-time.")};window.openPlayerPositionDebug=function(){const a=window.location.origin+"/player-position-debug.html";window.open(a,"PlayerPositionDebug","width=700,height=900,scrollbars=yes"),console.log("âœ“ Player position debug tool opened. Adjust starting position for play mode.")};window.openCameraLockOnDebug=function(){const a=window.location.origin+"/camera-lockon-debug.html";window.open(a,"CameraLockOnDebug","width=750,height=950,scrollbars=yes"),console.log("âœ“ Camera lock-on debug tool opened. Adjust camera position/rotation for lock-on view.")};window.openButtonAnimationDebug=function(){const a=window.location.origin+"/button-animation-debug.html";window.open(a,"ButtonAnimationDebug","width=750,height=850,scrollbars=yes"),console.log("âœ“ Button animation debug tool opened. Adjust button press animation.")};window.openDialRotationDebug=function(){const a=window.location.origin+"/dial-rotation-debug.html";window.open(a,"DialRotationDebug","width=750,height=950,scrollbars=yes"),console.log("âœ“ Dial rotation debug tool opened. Find the correct rotation axis for the dial.")};window.openMonitorLockOnDebug=function(){const a=window.location.origin+"/monitor-lockon-debug.html";window.open(a,"MonitorLockOnDebug","width=750,height=950,scrollbars=yes"),console.log("âœ“ Monitor lock-on debug tool opened. Adjust camera position/rotation for monitor lock-on view.")};window.openLeverPositionDebug=function(){const a=window.location.origin+"/lever-position-debug.html";window.open(a,"LeverPositionDebug","width=750,height=950,scrollbars=yes"),console.log("âœ“ Lever position debug tool opened. Adjust lever start/end positions for equalizer.")};window.openRadioAlignDebug=function(){const a=window.location.origin+"/radio-align-debug.html";window.open(a,"RadioAlignDebug","width=750,height=850,scrollbars=yes"),console.log("âœ“ Radio alignment debug tool opened. Adjust rotation and UV transforms for radio display.")};window.openLockOnEditor=function(){const a=window.location.origin+"/lockon-position-editor.html";window.open(a,"LockOnEditor","width=700,height=900,scrollbars=yes"),console.log("âœ“ Lock-on position editor opened. Adjust camera positions for all interactive devices.")};window.lockOnOverrides={};window.addEventListener("message",a=>{if(a.data.type==="updateLockOnPosition"){const{device:e,cameraPosition:t,cameraRotation:i}=a.data.config;window.lockOnOverrides[e]={cameraPosition:t,cameraRotation:i},console.log(`âœ“ Updated lock-on position for ${e}:`,t,i),console.log("Lock on to the device again to see changes.")}if(a.data.type==="updateLockOnPositionLive"){const{device:e,cameraPosition:t,cameraRotation:i}=a.data.config;if(console.log("Received live update for",e,t,i),window.lockOnOverrides[e]={cameraPosition:t,cameraRotation:i},window.scene&&window.scene.activeCamera){const o=window.scene.activeCamera;console.log("Updating camera to:",t,i),o.position.x=t.x,o.position.y=t.y,o.position.z=t.z,o.rotation.x=i.x,o.rotation.y=i.y,o.rotation.z=i.z,o.rotationQuaternion=null}else console.warn("No scene or camera available")}});let Y=Date.now(),h=null,b=null,g=null,y=null;window.addEventListener("DOMContentLoaded",()=>{H()});function U(a,e){const t=new BABYLON.DefaultRenderingPipeline("defaultPipeline",!0,a,e);return t.samples=4,t.fxaaEnabled=!0,t.bloomEnabled=!1,t.imageProcessingEnabled=!0,t.imageProcessing.contrast=1.1,t.imageProcessing.exposure=1,t.imageProcessing.toneMappingEnabled=!0,t.imageProcessing.toneMappingType=BABYLON.ImageProcessingConfiguration.TONEMAPPING_ACES,t.imageProcessing.vignetteEnabled=!0,t.imageProcessing.vignetteWeight=1.5,t.imageProcessing.vignetteCameraFov=.8,t.chromaticAberrationEnabled=!0,t.chromaticAberration.aberrationAmount=5,t.grainEnabled=!0,t.grain.intensity=10,t.grain.animated=!0,t.sharpenEnabled=!0,t.sharpen.edgeAmount=.3,t.sharpen.colorAmount=.5,console.log("Post-processing pipeline initialized with AA and effects"),t}function V(){const a={webglSupported:!1,webgl2Supported:!1,browserName:"Unknown",browserVersion:"Unknown",compatible:!1,warnings:[]},e=navigator.userAgent;e.indexOf("Chrome")>-1&&e.indexOf("Edg")===-1?a.browserName="Chrome":e.indexOf("Firefox")>-1?a.browserName="Firefox":e.indexOf("Edg")>-1?a.browserName="Edge":e.indexOf("Safari")>-1&&(a.browserName="Safari");const t=document.createElement("canvas"),i=t.getContext("webgl")||t.getContext("experimental-webgl"),o=t.getContext("webgl2");return i&&(a.webglSupported=!0),o&&(a.webgl2Supported=!0),a.webgl2Supported?(a.compatible=!0,console.log("âœ“ WebGL 2.0 supported")):a.webglSupported?(a.compatible=!0,a.warnings.push("WebGL 2.0 not supported, falling back to WebGL 1.0"),console.warn("âš  WebGL 2.0 not supported, using WebGL 1.0 fallback")):(a.compatible=!1,console.error("âœ— WebGL not supported")),["Chrome","Firefox","Edge"].includes(a.browserName)||a.warnings.push(`Browser ${a.browserName} may not be fully supported. Recommended: Chrome, Firefox, or Edge`),console.log(`Browser: ${a.browserName}, WebGL: ${a.webglSupported}, WebGL2: ${a.webgl2Supported}`),a}function R(){const a=document.createElement("div");return a.id="fps-counter",a.style.cssText=`
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: #00ff00;
    padding: 8px 12px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    z-index: 1000;
    min-width: 80px;
  `,a.textContent="FPS: --",document.body.appendChild(a),a}function _(){if(f&&p){const a=p.getFps().toFixed(0);f.textContent=`FPS: ${a}`,a>=50?f.style.color="#00ff00":a>=30?f.style.color="#ffff00":f.style.color="#ff0000"}}function F(){const a=(Date.now()-Y)/1e3;return console.log(`Game loaded in ${a.toFixed(2)} seconds`),a>5?console.warn(`âš  Load time (${a.toFixed(2)}s) exceeds target of 5 seconds`):console.log("âœ“ Load time within target (< 5 seconds)"),a}async function H(){try{const a=V();if(!a.compatible){B("WebGL is not supported in your browser. Please use a modern browser like Chrome, Firefox, or Edge.");return}a.warnings.length>0&&a.warnings.forEach(s=>{console.warn(s)});const e=document.getElementById("renderCanvas");if(!e){console.error("Canvas element not found"),B("Failed to initialize: Canvas element not found");return}try{p=new BABYLON.Engine(e,!0,{preserveDrawingBuffer:!0,stencil:!0,disableWebGL2Support:!a.webgl2Supported})}catch(s){console.error("Failed to create Babylon.js engine:",s),B("WebGL not supported or failed to initialize. Please use a modern browser.");return}u=new BABYLON.Scene(p),u.clearColor=new BABYLON.Color4(0,0,0,1),window.scene=u,BABYLON.KhronosTextureContainer2&&(p.enableOfflineSupport=!1,u.enableOfflineSupport=!1,BABYLON.KhronosTextureContainer2.URLConfig||(BABYLON.KhronosTextureContainer2.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,jsMSCTranscoder:null,wasmMSCTranscoder:null}),console.log("KTX2 decoder initialized for compressed textures"));const t=new BABYLON.HemisphericLight("hemisphericLight",new BABYLON.Vector3(0,1,0),u);t.intensity=.5,t.diffuse=new BABYLON.Color3(.8,.8,.9),console.log("Basic scene initialized without room geometry");const i=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");h=new S(u,e),h.initialize(i),h.objectPalette=new z(h,i),h.propertyPanel=new E(h,i),h.sceneHierarchy=new P(h,i),h.htmlMeshAlignPanel=new N(u,i);const o=[h.cameraManager.editorCamera,h.cameraManager.playerCamera];b=U(u,o),window.postProcessingPipeline=b;const n=new G(i,b);window.settingsPanel=n,g=new I(u),window.monitorController=g,g.initialize().then(()=>{console.log("Monitor system ready")}).catch(s=>{console.error("Monitor initialization failed:",s)}),y=new k(u),window.machineInteractions=y,window.addEventListener("keydown",s=>{if(g&&g.isActive){g.handleInput(s.key),s.preventDefault();return}(s.key==="h"||s.key==="H")&&(h.htmlMeshAlignPanel.toggle(),console.log("HtmlMesh Alignment Panel toggled - press H to toggle"))}),h.enterPlayMode(),setTimeout(()=>{h.autoLoadScene()},100),window.addEventListener("resize",()=>{p.resize()}),console.log("Spooky Game - Engine and scene initialized successfully"),f=R(),F(),p.runRenderLoop(()=>{try{u.render(),_(),g&&g.update(),h&&h.interactionSystem&&!h.isEditorMode&&h.interactionSystem.update()}catch(s){console.error("Render error:",s)}})}catch(a){console.error("Unexpected error during initialization:",a),B("An unexpected error occurred during initialization")}}function B(a){let e=document.getElementById("error-message");e||(e=document.createElement("div"),e.id="error-message",e.style.cssText="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ff0000; color: #ffffff; padding: 20px; border-radius: 5px; font-family: Arial, sans-serif; z-index: 1000;",document.body.appendChild(e)),e.textContent=a}
