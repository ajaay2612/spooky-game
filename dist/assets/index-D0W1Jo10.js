(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}})();class w{constructor(t,e=null){this.scene=t,this.editorManager=e,this.selectedObject=null,this.highlightLayer=null,this.onSelectionChanged=null,this.selectionCallbacks=[],this.initialize()}initialize(){this.highlightLayer=new BABYLON.HighlightLayer("highlight",this.scene),this.highlightLayer.outerGlow=!0,this.highlightLayer.innerGlow=!1,console.log("SelectionManager initialized with HighlightLayer")}setupPicking(t){this.scene.onPointerDown=(e,i)=>{this.editorManager&&!this.editorManager.isEditorMode||e.button===0&&(i.hit&&i.pickedMesh?i.pickedMesh.name.startsWith("_")||this.selectObject(i.pickedMesh):this.deselectObject())},console.log("Mouse picking enabled for object selection")}selectObject(t){if(!t||t.isDisposed()){console.warn("Cannot select invalid or disposed object");return}let e=t;if(t instanceof BABYLON.Mesh){let i=t;for(;i;){if(i.metadata&&i.metadata.isImportedGLTF){e=i,console.log(`Found GLTF root: ${e.name} (clicked on ${t.name})`);break}i=i.parent}}this.selectedObject&&this.selectedObject instanceof BABYLON.Mesh&&this.highlightLayer.removeMesh(this.selectedObject),this.selectedObject=e,e instanceof BABYLON.Mesh&&this.highlightLayer.addMesh(e,BABYLON.Color3.Yellow()),this.onSelectionChanged&&this.onSelectionChanged(e),this.selectionCallbacks.forEach(i=>i(e)),console.log(`Selected object: ${e.name}`)}deselectObject(){this.selectedObject&&(this.selectedObject instanceof BABYLON.Mesh&&this.highlightLayer.removeMesh(this.selectedObject),console.log(`Deselected object: ${this.selectedObject.name}`),this.selectedObject=null,this.onSelectionChanged&&this.onSelectionChanged(null),this.selectionCallbacks.forEach(t=>t(null)))}addSelectionCallback(t){t&&typeof t=="function"&&this.selectionCallbacks.push(t)}dispose(){this.highlightLayer&&(this.highlightLayer.dispose(),this.highlightLayer=null)}}class C{constructor(t,e){this.scene=t,this.canvas=e,this.editorCamera=null,this.playerCamera=null,this.activeCamera=null}createPlayerCamera(){const t=new BABYLON.UniversalCamera("playerCamera",new BABYLON.Vector3(0,1.6,-5),this.scene);return t.setTarget(new BABYLON.Vector3(0,1.6,0)),t.speed=.1,t.angularSensibility=2e3,t.keysUp=[87],t.keysDown=[83],t.keysLeft=[65],t.keysRight=[68],console.log("Player camera (UniversalCamera) created"),this.playerCamera=t,t}createEditorCamera(){const t=new BABYLON.ArcRotateCamera("editorCamera",Math.PI/2,Math.PI/3,15,new BABYLON.Vector3(0,1.5,0),this.scene);return t.panningSensibility=1e3,t.wheelPrecision=50,t.angularSensibilityX=1e3,t.angularSensibilityY=1e3,t.lowerRadiusLimit=2,t.upperRadiusLimit=100,t.lowerBetaLimit=.1,t.upperBetaLimit=Math.PI/2,t.inputs.attached.pointers.buttons=[2,1,0],console.log("Editor camera (ArcRotateCamera) created"),this.editorCamera=t,t}switchToEditorCamera(){this.editorCamera||this.createEditorCamera(),document.pointerLockElement===this.canvas&&document.exitPointerLock(),this.playerCamera&&this.playerCamera.detachControl(),this.editorCamera.attachControl(this.canvas,!0),this.scene.activeCamera=this.editorCamera,this.activeCamera=this.editorCamera,console.log("Switched to editor camera")}switchToPlayerCamera(){this.playerCamera||this.createPlayerCamera(),this.editorCamera&&this.editorCamera.detachControl(),this.playerCamera.attachControl(this.canvas,!0),this.scene.activeCamera=this.playerCamera,this.activeCamera=this.playerCamera,this.canvas.requestPointerLock(),console.log("Switched to player camera")}initialize(){this.createPlayerCamera(),this.createEditorCamera(),this.switchToEditorCamera()}}class b{constructor(t){this.scene=t,this.objectCounter=0}createPrimitive(t){const e=`${t}_${this.objectCounter++}`;let i;switch(t.toLowerCase()){case"box":i=BABYLON.MeshBuilder.CreateBox(e,{size:1},this.scene);break;case"sphere":i=BABYLON.MeshBuilder.CreateSphere(e,{diameter:1},this.scene);break;case"cylinder":i=BABYLON.MeshBuilder.CreateCylinder(e,{height:2,diameter:1},this.scene);break;case"cone":i=BABYLON.MeshBuilder.CreateCylinder(e,{height:2,diameterTop:0,diameterBottom:1},this.scene);break;case"plane":i=BABYLON.MeshBuilder.CreatePlane(e,{size:1},this.scene);break;case"torus":i=BABYLON.MeshBuilder.CreateTorus(e,{diameter:1,thickness:.3},this.scene);break;default:return console.warn(`Unknown primitive type: ${t}`),null}i.position=new BABYLON.Vector3(0,1,0);const o=new BABYLON.StandardMaterial(`${e}_mat`,this.scene);return o.diffuseColor=new BABYLON.Color3(Math.random(),Math.random(),Math.random()),i.material=o,console.log(`Created primitive: ${e}`),i}createLight(t){const e=`${t}Light_${this.objectCounter++}`;let i;switch(t.toLowerCase()){case"point":i=new BABYLON.PointLight(e,new BABYLON.Vector3(0,3,0),this.scene);break;case"directional":i=new BABYLON.DirectionalLight(e,new BABYLON.Vector3(0,-1,0),this.scene),i.position=new BABYLON.Vector3(0,5,0);break;case"spot":i=new BABYLON.SpotLight(e,new BABYLON.Vector3(0,3,0),new BABYLON.Vector3(0,-1,0),Math.PI/3,2,this.scene);break;case"hemispheric":i=new BABYLON.HemisphericLight(e,new BABYLON.Vector3(0,1,0),this.scene);break;default:return console.warn(`Unknown light type: ${t}`),null}return i.intensity=.5,console.log(`Created light: ${e}`),i}async importGLTF(t,e=null,i=!1){try{console.log(`Importing GLTF from: ${t}`);let o="",n=t;t.startsWith("/models/")&&(o="/models/",n=t.replace("/models/",""));const s=await BABYLON.SceneLoader.ImportMeshAsync(null,o,n,this.scene,null,".glb");if(s.meshes&&s.meshes.length>0){let a=s.meshes[0];const l=s.meshes.find(d=>d.name==="__root__");l&&(a=l),console.log("GLTF meshes:",s.meshes.map(d=>{var B;return{name:d.name,parent:(B=d.parent)==null?void 0:B.name}})),console.log("Selected root mesh:",a.name),a.name=`imported_${this.objectCounter++}`;const c=a.scaling.clone();return a.position=new BABYLON.Vector3(0,0,0),a.rotation=new BABYLON.Vector3(0,0,0),a.scaling=new BABYLON.Vector3(Math.sign(c.x)||1,Math.sign(c.y)||1,Math.sign(c.z)||1),i?console.log(`Reset transforms for ${a.name}, ready for saved transforms`):(a.position=new BABYLON.Vector3(0,1,0),console.log(`Set default position for ${a.name}:`,a.position)),a.metadata={isImportedGLTF:!0,modelPath:t.startsWith("/models/")?t:null,modelName:e,originalName:a.name},console.log(`Successfully imported GLTF: ${a.name} with ${s.meshes.length} meshes`),a}else throw new Error("No meshes found in GLTF file")}catch(o){throw console.error("Failed to load GLTF:",o),new Error(`Unable to load model: ${o.message}`)}}duplicateObject(t){if(!t)return console.warn("Cannot duplicate null object"),null;let e=null;if(t instanceof BABYLON.Mesh){if(e=t.clone(`${t.name}_copy_${this.objectCounter++}`),e.position=t.position.add(new BABYLON.Vector3(1,0,1)),t.material){const i=t.material.clone(`${e.name}_mat`);e.material=i}console.log(`Duplicated mesh: ${e.name}`)}else if(t instanceof BABYLON.Light){const i=this.getLightType(t);e=this.createLight(i),e.intensity=t.intensity,t.diffuse&&(e.diffuse=t.diffuse.clone()),t.position&&(e.position=t.position.add(new BABYLON.Vector3(1,0,1))),t.direction&&e.direction&&(e.direction=t.direction.clone()),console.log(`Duplicated light: ${e.name}`)}else console.warn(`Cannot duplicate object of type: ${t.constructor.name}`);return e}getLightType(t){return t instanceof BABYLON.PointLight?"point":t instanceof BABYLON.DirectionalLight?"directional":t instanceof BABYLON.SpotLight?"spot":t instanceof BABYLON.HemisphericLight?"hemispheric":"point"}}class L{constructor(t){this.scene=t}serializeScene(){const t={version:"1.0",objects:[],postProcessing:null};if(this.scene.meshes.forEach(e=>{if(e.name.startsWith("_")||e.name==="floor"||e.name==="ceiling"||e.name.startsWith("wall"))return;if(e.metadata&&e.metadata.isImportedGLTF){console.log(`Serializing GLTF model ${e.name}`);const n={type:"gltf",name:e.name,position:e.position.asArray(),rotation:e.rotation.asArray(),scaling:e.scaling.asArray(),modelPath:e.metadata.modelPath,modelName:e.metadata.modelName};t.objects.push(n);return}let i=e.parent;for(;i;){if(i.metadata&&i.metadata.isImportedGLTF)return;i=i.parent}const o={type:"mesh",meshType:this.getMeshType(e),name:e.name,position:e.position.asArray(),rotation:e.rotation.asArray(),scaling:e.scaling.asArray()};e.material&&(o.material=this.serializeMaterial(e.material)),t.objects.push(o)}),this.scene.lights.forEach(e=>{const i={type:"light",lightType:this.getLightType(e),name:e.name,intensity:e.intensity,diffuse:e.diffuse.asArray()};e.specular&&(i.specular=e.specular.asArray()),e.groundColor&&(i.groundColor=e.groundColor.asArray()),e.position&&(i.position=e.position.asArray()),e.direction&&(i.direction=e.direction.asArray()),e.range!==void 0&&(i.range=e.range),t.objects.push(i)}),window.postProcessingPipeline){const e=window.postProcessingPipeline;t.postProcessing={fxaaEnabled:e.fxaaEnabled,bloomEnabled:e.bloomEnabled,bloomThreshold:e.bloomThreshold,bloomWeight:e.bloomWeight,bloomScale:e.bloomScale,contrast:e.imageProcessing.contrast,exposure:e.imageProcessing.exposure,vignetteEnabled:e.imageProcessing.vignetteEnabled,vignetteWeight:e.imageProcessing.vignetteWeight,chromaticAberrationEnabled:e.chromaticAberrationEnabled,chromaticAberrationAmount:e.chromaticAberration.aberrationAmount,grainEnabled:e.grainEnabled,grainIntensity:e.grain.intensity,grainAnimated:e.grain.animated,sharpenEnabled:e.sharpenEnabled,sharpenEdgeAmount:e.sharpen.edgeAmount,sharpenColorAmount:e.sharpen.colorAmount},console.log("Post-processing settings serialized")}return JSON.stringify(t,null,2)}getMeshType(t){const e=t.name.toLowerCase();return e.includes("box")?"box":e.includes("sphere")?"sphere":e.includes("cylinder")?"cylinder":e.includes("cone")?"cone":e.includes("plane")?"plane":e.includes("torus")?"torus":"box"}getLightType(t){return t instanceof BABYLON.PointLight?"point":t instanceof BABYLON.DirectionalLight?"directional":t instanceof BABYLON.SpotLight?"spot":t instanceof BABYLON.HemisphericLight?"hemispheric":"point"}serializeMaterial(t){const e={};return t.diffuseColor&&(e.diffuseColor=t.diffuseColor.asArray()),t.specularColor&&(e.specularColor=t.specularColor.asArray()),t.emissiveColor&&(e.emissiveColor=t.emissiveColor.asArray()),e}applyMaterialData(t,e){e.diffuseColor&&(t.diffuseColor=BABYLON.Color3.FromArray(e.diffuseColor)),e.specularColor&&(t.specularColor=BABYLON.Color3.FromArray(e.specularColor)),e.emissiveColor&&(t.emissiveColor=BABYLON.Color3.FromArray(e.emissiveColor))}clearScene(){this.scene.meshes.filter(i=>!i.name.startsWith("_")&&i.name!=="floor"&&i.name!=="ceiling"&&!i.name.startsWith("wall")).forEach(i=>{i.material&&i.material.dispose(),i.dispose()}),[...this.scene.lights].forEach(i=>{i.dispose()})}async deserializeScene(t){const e=JSON.parse(t),i=new b(this.scene);this.clearScene();for(const o of e.objects)if(o.type==="gltf")try{const n=await i.importGLTF(o.modelPath,o.modelName,!0);n&&(n.name=o.name,n.position.fromArray(o.position),n.rotation.fromArray(o.rotation),n.scaling.fromArray(o.scaling),console.log(`Restored GLTF model ${o.name}`))}catch(n){console.error(`Failed to restore GLTF model ${o.name}:`,n)}else if(o.type==="mesh"){const n=i.createPrimitive(o.meshType);n&&(n.name=o.name,n.position.fromArray(o.position),n.rotation.fromArray(o.rotation),n.scaling.fromArray(o.scaling),o.material&&n.material&&this.applyMaterialData(n.material,o.material))}else if(o.type==="light"){const n=i.createLight(o.lightType);n&&(n.name=o.name,n.intensity=o.intensity,n.diffuse.fromArray(o.diffuse),o.specular&&n.specular&&n.specular.fromArray(o.specular),o.groundColor&&n.groundColor&&n.groundColor.fromArray(o.groundColor),o.position&&n.position&&n.position.fromArray(o.position),o.direction&&n.direction&&n.direction.fromArray(o.direction),o.range!==void 0&&n.range!==void 0&&(n.range=o.range))}if(e.postProcessing&&window.postProcessingPipeline){const o=window.postProcessingPipeline,n=e.postProcessing;o.fxaaEnabled=n.fxaaEnabled,o.bloomEnabled=n.bloomEnabled,o.bloomThreshold=n.bloomThreshold,o.bloomWeight=n.bloomWeight,o.bloomScale=n.bloomScale,o.imageProcessing.contrast=n.contrast,o.imageProcessing.exposure=n.exposure,o.imageProcessing.vignetteEnabled=n.vignetteEnabled,o.imageProcessing.vignetteWeight=n.vignetteWeight,o.chromaticAberrationEnabled=n.chromaticAberrationEnabled,o.chromaticAberration.aberrationAmount=n.chromaticAberrationAmount,o.grainEnabled=n.grainEnabled,o.grain.intensity=n.grainIntensity,o.grain.animated=n.grainAnimated,o.sharpenEnabled=n.sharpenEnabled,o.sharpen.edgeAmount=n.sharpenEdgeAmount,o.sharpen.colorAmount=n.sharpenColorAmount,console.log("Post-processing settings restored"),window.settingsPanel&&window.settingsPanel.refresh()}console.log("Scene deserialized successfully")}async saveToFile(){try{console.log("Starting scene save...");const t=this.serializeScene(),i=await(await fetch("http://localhost:3001/api/save-scene",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:t})})).json();if(i.success)console.log("✓ Scene saved to saved-3d-env.json");else throw new Error(i.error)}catch(t){throw console.error("✗ Failed to save scene:",t),alert(`Failed to save scene: ${t.message}
Make sure the server is running (npm run server)`),t}}async loadFromFile(t=!1){try{console.log("Starting scene load...");const e=await fetch("/saved-3d-env.json");if(!e.ok)throw new Error("No saved scene found");const i=await e.text();console.log("Deserializing scene data..."),await this.deserializeScene(i),console.log("✓ Scene loaded from saved-3d-env.json")}catch(e){throw t||console.error("✗ Failed to load scene:",e),e}}}class x{constructor(t,e){this.scene=t,this.canvas=e,this.isEditorMode=!0,this.selectionManager=null,this.objectFactory=null,this.serializationManager=null,this.cameraManager=null,this.objectPalette=null,this.propertyPanel=null,this.sceneHierarchy=null,this.guiTexture=null,this.gizmoManager=null,this.activeGizmo=null,this.lightHelpers=new Map}initialize(t){this.guiTexture=t,this.selectionManager=new w(this.scene,this),this.objectFactory=new b(this.scene),this.serializationManager=new L(this.scene),this.cameraManager=new C(this.scene,this.canvas),this.cameraManager.initialize(),this.selectionManager.setupPicking(this.canvas),this.initializeGizmos(),this.selectionManager.addSelectionCallback(e=>{this.updateGizmoAttachment()}),this.setupKeyboardShortcuts(),console.log("EditorManager initialized")}initializeGizmos(){this.gizmoManager=new BABYLON.GizmoManager(this.scene),this.gizmoManager.usePointerToAttachGizmos=!1,this.gizmoManager.scaleRatio=1,this.gizmoManager.gizmoCoordinatesMode=BABYLON.GizmoCoordinatesMode.Local,this.gizmoManager.positionGizmoEnabled=!1,this.gizmoManager.scaleGizmoEnabled=!1,this.gizmoManager.rotationGizmoEnabled=!1,console.log("Gizmo system initialized"),console.log("GizmoManager:",this.gizmoManager)}setGizmoMode(t){this.gizmoManager.positionGizmoEnabled=!1,this.gizmoManager.rotationGizmoEnabled=!1,this.gizmoManager.scaleGizmoEnabled=!1;const e=this.selectionManager.selectedObject;if(!t||!e){this.activeGizmo=null,this.gizmoManager.attachToMesh(null);return}t==="move"?(this.gizmoManager.positionGizmoEnabled=!0,this.gizmoManager.attachToMesh(e),this.activeGizmo="move",console.log("Position gizmo enabled for:",e.name)):t==="rotate"?(this.gizmoManager.rotationGizmoEnabled=!0,this.gizmoManager.attachToMesh(e),this.activeGizmo="rotate",console.log("Rotation gizmo enabled for:",e.name)):t==="scale"&&(this.gizmoManager.scaleGizmoEnabled=!0,this.gizmoManager.attachToMesh(e),this.activeGizmo="scale",setTimeout(()=>{if(this.gizmoManager.gizmos&&this.gizmoManager.gizmos.scaleGizmo){const i=this.propertyPanel?this.propertyPanel.uniformScaling:!0,o=this.gizmoManager.gizmos.scaleGizmo;i?(o.xGizmo&&(o.xGizmo.isEnabled=!1),o.yGizmo&&(o.yGizmo.isEnabled=!1),o.zGizmo&&(o.zGizmo.isEnabled=!1),o.uniformScaleGizmo&&(o.uniformScaleGizmo.isEnabled=!0)):(o.xGizmo&&(o.xGizmo.isEnabled=!0),o.yGizmo&&(o.yGizmo.isEnabled=!0),o.zGizmo&&(o.zGizmo.isEnabled=!0),o.uniformScaleGizmo&&(o.uniformScaleGizmo.isEnabled=!1)),console.log("Scale gizmo configured - uniform mode:",i)}},10),console.log("Scale gizmo enabled for:",e.name))}updateScaleGizmoUniformMode(t){if(console.log("updateScaleGizmoUniformMode called with:",t),this.gizmoManager&&this.gizmoManager.gizmos&&this.gizmoManager.gizmos.scaleGizmo){const e=this.gizmoManager.gizmos.scaleGizmo;t?(e.xGizmo&&(e.xGizmo.isEnabled=!1),e.yGizmo&&(e.yGizmo.isEnabled=!1),e.zGizmo&&(e.zGizmo.isEnabled=!1),e.uniformScaleGizmo&&(e.uniformScaleGizmo.isEnabled=!0),console.log("Uniform scaling enabled - showing center gizmo only")):(e.xGizmo&&(e.xGizmo.isEnabled=!0),e.yGizmo&&(e.yGizmo.isEnabled=!0),e.zGizmo&&(e.zGizmo.isEnabled=!0),e.uniformScaleGizmo&&(e.uniformScaleGizmo.isEnabled=!1),console.log("Non-uniform scaling enabled - showing axis gizmos"))}else console.warn("Scale gizmo not available")}setupKeyboardShortcuts(){window.addEventListener("keydown",t=>{if(t.key==="e"||t.key==="E"){this.toggleMode();return}this.isEditorMode&&(t.key==="Delete"&&this.deleteSelected(),t.ctrlKey&&(t.key==="d"||t.key==="D")&&(t.preventDefault(),this.duplicateSelected()),t.ctrlKey&&(t.key==="s"||t.key==="S")&&(t.preventDefault(),this.saveScene()),t.ctrlKey&&(t.key==="o"||t.key==="O")&&(t.preventDefault(),this.loadScene()),(t.key==="f"||t.key==="F")&&this.focusOnSelected(),t.key==="Escape"&&this.selectionManager.deselectObject())}),console.log("Keyboard shortcuts registered")}focusOnSelected(){if(this.selectionManager.selectedObject&&this.cameraManager.editorCamera){const t=this.selectionManager.selectedObject.position;this.cameraManager.editorCamera.setTarget(t),console.log(`Focused camera on: ${this.selectionManager.selectedObject.name}`)}}toggleMode(){this.isEditorMode=!this.isEditorMode,this.isEditorMode?this.enterEditorMode():this.enterPlayMode(),console.log(`Mode switched to: ${this.isEditorMode?"Editor":"Play"}`)}enterEditorMode(){this.isEditorMode=!0,this.cameraManager.switchToEditorCamera(),this.guiTexture&&(this.guiTexture.layer.isEnabled=!0),this.objectPalette&&this.objectPalette.show(),this.propertyPanel&&this.propertyPanel.show(),this.sceneHierarchy&&this.sceneHierarchy.show(),this.selectionManager&&this.selectionManager.setupPicking(this.canvas),console.log("Entered editor mode")}enterPlayMode(){this.isEditorMode=!1,this.cameraManager.switchToPlayerCamera(),this.guiTexture&&(this.guiTexture.layer.isEnabled=!1),this.objectPalette&&this.objectPalette.hide(),this.propertyPanel&&this.propertyPanel.hide(),this.sceneHierarchy&&this.sceneHierarchy.hide(),this.selectionManager&&this.selectionManager.deselectObject(),console.log("Entered play mode")}deleteSelected(){const t=this.selectionManager.selectedObject;if(!t){console.warn("No object selected to delete");return}if(["playerCamera","editorCamera","camera"].includes(t.name)){console.warn(`Cannot delete essential object: ${t.name}`),alert(`Cannot delete essential object: ${t.name}`);return}const i=t.name;this.gizmoManager&&this.gizmoManager.attachToMesh(null),this.selectionManager.deselectObject(),t.material&&t.material.dispose(),t.dispose(),this.sceneHierarchy&&this.sceneHierarchy.refresh(),console.log(`Deleted object: ${i}`)}duplicateSelected(){const t=this.selectionManager.selectedObject;if(!t){console.warn("No object selected to duplicate");return}const e=this.objectFactory.duplicateObject(t);e&&(this.selectionManager.selectObject(e),this.sceneHierarchy&&this.sceneHierarchy.refresh(),console.log(`Duplicated object: ${e.name}`))}async saveScene(){try{await this.serializationManager.saveToFile(),console.log("Scene saved successfully")}catch(t){console.error("Failed to save scene:",t)}}async loadScene(t=!1){try{await this.serializationManager.loadFromFile(t),this.selectionManager.deselectObject(),this.sceneHierarchy&&this.sceneHierarchy.refresh(),console.log("Scene loaded successfully")}catch(e){t||console.error("Failed to load scene:",e)}}async autoLoadScene(){try{await this.loadScene(!0),this.sceneHierarchy&&this.sceneHierarchy.refresh(),console.log("Auto-loaded saved scene")}catch{console.log("No saved scene to auto-load"),this.sceneHierarchy&&this.sceneHierarchy.refresh()}}setLightGizmoMode(t,e){if(this.gizmoManager.positionGizmoEnabled=!1,this.gizmoManager.scaleGizmoEnabled=!1,!t||!e){this.activeGizmo=null,this.gizmoManager.attachToMesh(null),this.lightHelpers.has(e)&&(this.lightHelpers.get(e).dispose(),this.lightHelpers.delete(e));return}let i=this.lightHelpers.get(e);if(i||(i=BABYLON.MeshBuilder.CreateSphere(`_lightHelper_${e.name}`,{diameter:.3},this.scene),i.isVisible=!1,i.isPickable=!1,this.scene.onBeforeRenderObservable.add(()=>{e.position&&i&&i.position.copyFrom(e.position)}),this.lightHelpers.set(e,i)),e.position&&i.position.copyFrom(e.position),t==="move"){this.gizmoManager.positionGizmoEnabled=!0,this.gizmoManager.attachToMesh(i),this.activeGizmo="move";const o=this.gizmoManager.gizmos.positionGizmo;o&&o.onDragEndObservable.add(()=>{e.position&&e.position.copyFrom(i.position)}),console.log("Position gizmo enabled for light:",e.name)}}updateGizmoAttachment(){const t=this.selectionManager.selectedObject;this.activeGizmo&&this.gizmoManager&&this.gizmoManager.attachToMesh(t)}dispose(){this.selectionManager&&this.selectionManager.dispose(),this.gizmoManager&&this.gizmoManager.dispose(),this.lightHelpers.forEach(t=>t.dispose()),this.lightHelpers.clear()}}class A{constructor(t,e){this.editor=t,this.guiTexture=e,this.panel=null,this.scrollViewer=null,this.isVisible=!0,this.initialize()}initialize(){this.scrollViewer=new BABYLON.GUI.ScrollViewer,this.scrollViewer.width="240px",this.scrollViewer.height="45%",this.scrollViewer.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,this.scrollViewer.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,this.scrollViewer.top="10px",this.scrollViewer.left="10px",this.scrollViewer.background="#2a2a2a",this.scrollViewer.thickness=2,this.scrollViewer.thumbLength=.5,this.scrollViewer.barColor="#4a9eff",this.scrollViewer.barBackground="#1a1a1a",this.scrollViewer.isPointerBlocker=!0,this.guiTexture.addControl(this.scrollViewer),this.panel=new BABYLON.GUI.StackPanel,this.panel.width="200px",this.scrollViewer.addControl(this.panel),this.createFileSection(),this.createPrimitiveSection(),this.createLightSection(),this.createModelSection(),console.log("ObjectPalette initialized with 45% height and scrolling")}createFileSection(){const t=this.createSectionHeader("File");this.panel.addControl(t);const e=this.createButton("Save Scene",()=>{this.editor.saveScene()});this.panel.addControl(e);const i=this.createButton("Load Scene",()=>{this.editor.loadScene()});this.panel.addControl(i);const o=new BABYLON.GUI.Container;o.height="10px",this.panel.addControl(o)}createSectionHeader(t){const e=new BABYLON.GUI.TextBlock;return e.text=t,e.height="30px",e.width="190px",e.color="#4a9eff",e.fontSize=16,e.fontWeight="bold",e.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.textWrapping=!0,e.paddingLeft="5px",e}createButton(t,e){const i=BABYLON.GUI.Button.CreateSimpleButton(`btn_${t}_${Date.now()}`,t);return i.width="180px",i.height="30px",i.color="white",i.background="#3a3a3a",i.fontSize=14,i.cornerRadius=4,i.onPointerEnterObservable.add(()=>{i.background="#4a4a4a"}),i.onPointerOutObservable.add(()=>{i.background="#3a3a3a"}),i.onPointerClickObservable.add(e),i}createPrimitiveSection(){const t=this.createSectionHeader("Primitives");this.panel.addControl(t),["Box","Sphere","Cylinder","Cone","Plane","Torus"].forEach(o=>{const n=this.createButton(o,()=>{const s=this.editor.objectFactory.createPrimitive(o);s&&(this.editor.selectionManager.selectObject(s),this.editor.sceneHierarchy&&this.editor.sceneHierarchy.refresh())});this.panel.addControl(n)});const i=new BABYLON.GUI.Container;i.height="10px",this.panel.addControl(i)}createLightSection(){const t=this.createSectionHeader("Lights");this.panel.addControl(t),["Point","Directional","Spot","Hemispheric"].forEach(o=>{const n=this.createButton(o,()=>{const s=this.editor.objectFactory.createLight(o);s&&(this.editor.selectionManager.selectObject(s),this.editor.sceneHierarchy&&this.editor.sceneHierarchy.refresh())});this.panel.addControl(n)});const i=new BABYLON.GUI.Container;i.height="10px",this.panel.addControl(i)}createModelSection(){const t=this.createSectionHeader("Models");this.panel.addControl(t);const e=this.createButton("Load Model",()=>{this.openModelSelector()});this.panel.addControl(e)}async openModelSelector(){try{const e=await(await fetch("http://localhost:3001/api/list-models")).json();if(!e.success)throw new Error(e.error);const i=e.models;if(i.length===0){alert(`No models found in the /models directory.
Place your .gltf or .glb files there.`);return}this.showModelSelectionDialog(i)}catch(t){console.error("Failed to list models:",t),alert(`Failed to load models list: ${t.message}
Make sure the server is running.`)}}showModelSelectionDialog(t){const e=document.createElement("div");e.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    `;const i=document.createElement("div");i.style.cssText=`
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      max-height: 500px;
      overflow-y: auto;
      color: white;
      font-family: Arial, sans-serif;
    `;const o=document.createElement("h3");o.textContent="Select Model",o.style.cssText="margin-top: 0; color: #4a9eff;",i.appendChild(o),t.forEach(s=>{const a=document.createElement("button");a.textContent=s,a.style.cssText=`
        display: block;
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        background: #3a3a3a;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      `,a.onmouseenter=()=>a.style.background="#4a4a4a",a.onmouseleave=()=>a.style.background="#3a3a3a",a.onclick=async()=>{document.body.removeChild(e),await this.loadModelFromServer(s)},i.appendChild(a)});const n=document.createElement("button");n.textContent="Cancel",n.style.cssText=`
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      background: #555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    `,n.onclick=()=>document.body.removeChild(e),i.appendChild(n),e.appendChild(i),document.body.appendChild(e)}async loadModelFromServer(t){try{console.log(`Loading model: ${t}`);const e=`/models/${t}`,i=await this.editor.objectFactory.importGLTF(e,t);i&&(this.editor.selectionManager.selectObject(i),this.editor.sceneHierarchy&&this.editor.sceneHierarchy.refresh(),console.log("Model loaded successfully"))}catch(e){console.error("Failed to load model:",e),alert(`Failed to load model: ${e.message}`)}}show(){this.scrollViewer&&(this.scrollViewer.isVisible=!0,this.isVisible=!0)}hide(){this.scrollViewer&&(this.scrollViewer.isVisible=!1,this.isVisible=!1)}}class y{constructor(t,e){this.editor=t,this.guiTexture=e,this.panel=null,this.currentObject=null,this.propertyControls=[],this.isVisible=!1,this.activeGizmoMode=null,this.uniformScaling=!0,this.moveButton=null,this.rotateButton=null,this.scaleButton=null,this.uniformScaleCheckbox=null,this.initialize()}initialize(){const t=new BABYLON.GUI.ScrollViewer;t.width="320px",t.height="600px",t.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT,t.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,t.paddingTop="10px",t.paddingRight="10px",t.background="#2a2a2a",t.thickness=2,t.color="#4a9eff",t.isVisible=!1,this.guiTexture.addControl(t),this.panel=new BABYLON.GUI.StackPanel,this.panel.width="300px",this.panel.background="#2a2a2a",t.isPointerBlocker=!0,t.addControl(this.panel),this.scrollViewer=t,this.editor.selectionManager.addSelectionCallback(e=>{this.updateForObject(e)}),console.log("PropertyPanel initialized")}updateForObject(t){if(console.log("PropertyPanel.updateForObject called with:",t?t.name:"null"),this.clearControls(),this.currentObject=t,!t){this.scrollViewer.isVisible=!1,console.log("PropertyPanel hidden - no object selected");return}console.log("PropertyPanel showing for object:",t.name),this.scrollViewer.isVisible=!0,this.createHeader(t),t instanceof BABYLON.Mesh?(this.createTransformSection(t),this.createMaterialSection(t)):t instanceof BABYLON.Light&&this.createLightSection(t),this.createDeleteButton()}clearControls(){this.panel&&this.panel.clearControls(),this.propertyControls=[]}createHeader(t){const e=new BABYLON.GUI.TextBlock;e.text=`Object: ${t.name}`,e.height="40px",e.color="#4a9eff",e.fontSize=18,e.fontWeight="bold",e.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.paddingLeft="5px",this.panel.addControl(e);const i=new BABYLON.GUI.InputText;i.width="280px",i.height="30px",i.color="white",i.background="#3a3a3a",i.text=t.name,i.fontSize=14,i.onTextChangedObservable.add(n=>{const s=n.text.trim();if(s&&s!==t.name){let a=s,l=1;for(;this.editor.scene.getMeshByName(a)||this.editor.scene.getLightByName(a);)a=`${s}_${l}`,l++;t.name=a,e.text=`Object: ${a}`,n.text=a,this.editor.sceneHierarchy&&this.editor.sceneHierarchy.refresh()}}),this.panel.addControl(i);const o=new BABYLON.GUI.Container;o.height="10px",this.panel.addControl(o)}createMaterialSection(t){if(!t.material)return;this.addSectionHeader("Material");const e=t.material;e.diffuseColor&&this.addColorControl("Diffuse",e.diffuseColor,i=>{e.diffuseColor=i}),e.specularColor&&this.addColorControl("Specular",e.specularColor,i=>{e.specularColor=i}),e.emissiveColor&&this.addColorControl("Emissive",e.emissiveColor,i=>{e.emissiveColor=i})}addColorControl(t,e,i){const o=new BABYLON.GUI.TextBlock;o.text=t+" Color:",o.height="25px",o.color="white",o.fontSize=12,o.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,o.paddingLeft="5px",this.panel.addControl(o);const n=new BABYLON.GUI.ColorPicker;n.value=e,n.height="180px",n.width="180px",n.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER,n.onValueChangedObservable.add(a=>{e.r=a.r,e.g=a.g,e.b=a.b,i(e)}),this.panel.addControl(n);const s=new BABYLON.GUI.Container;s.height="10px",this.panel.addControl(s)}createLightSection(t){if(t.position){this.addSectionHeader("Transform Gizmos"),this.createLightGizmoButtons(t);const s=new BABYLON.GUI.Container;s.height="10px",this.panel.addControl(s)}this.addSectionHeader("Light Properties");const e=new BABYLON.GUI.StackPanel;e.height="40px",e.isVertical=!1;const i=new BABYLON.GUI.TextBlock;i.text="Intensity:",i.width="80px",i.color="white",i.fontSize=12,e.addControl(i);const o=new BABYLON.GUI.Slider;o.minimum=0,o.maximum=10,o.value=t.intensity,o.height="20px",o.width="150px",o.color="#4a9eff",o.background="#3a3a3a",o.onValueChangedObservable.add(s=>{t.intensity=s}),e.addControl(o);const n=new BABYLON.GUI.TextBlock;if(n.text=t.intensity.toFixed(2),n.width="50px",n.color="white",n.fontSize=12,e.addControl(n),o.onValueChangedObservable.add(s=>{n.text=s.toFixed(2)}),this.panel.addControl(e),t.diffuse&&this.addColorControl("Light",t.diffuse,s=>{t.diffuse=s}),t.position&&(this.addSectionHeader("Position"),this.addVector3Control("X",t.position.x,s=>{t.position.x=s}),this.addVector3Control("Y",t.position.y,s=>{t.position.y=s}),this.addVector3Control("Z",t.position.z,s=>{t.position.z=s})),t.direction&&(this.addSectionHeader("Direction"),this.addVector3Control("X",t.direction.x,s=>{t.direction.x=s,t.direction.normalize()}),this.addVector3Control("Y",t.direction.y,s=>{t.direction.y=s,t.direction.normalize()}),this.addVector3Control("Z",t.direction.z,s=>{t.direction.z=s,t.direction.normalize()})),t.range!==void 0){this.addSectionHeader("Range");const s=new BABYLON.GUI.StackPanel;s.height="40px",s.isVertical=!1;const a=new BABYLON.GUI.TextBlock;a.text="Range:",a.width="80px",a.color="white",a.fontSize=12,s.addControl(a);const l=new BABYLON.GUI.Slider;l.minimum=1,l.maximum=50,l.value=t.range,l.height="20px",l.width="150px",l.color="#4a9eff",l.background="#3a3a3a",l.onValueChangedObservable.add(d=>{t.range=d}),s.addControl(l);const c=new BABYLON.GUI.TextBlock;c.text=t.range.toFixed(1),c.width="50px",c.color="white",c.fontSize=12,s.addControl(c),l.onValueChangedObservable.add(d=>{c.text=d.toFixed(1)}),this.panel.addControl(s)}}createDeleteButton(){const t=new BABYLON.GUI.Container;t.height="20px",this.panel.addControl(t);const e=BABYLON.GUI.Button.CreateSimpleButton("deleteBtn","Delete Object");e.width="280px",e.height="35px",e.color="white",e.background="#cc0000",e.fontSize=14,e.cornerRadius=4,e.onPointerEnterObservable.add(()=>{e.background="#ff0000"}),e.onPointerOutObservable.add(()=>{e.background="#cc0000"}),e.onPointerClickObservable.add(()=>{this.editor.deleteSelected()}),this.panel.addControl(e)}show(){this.currentObject&&this.scrollViewer&&(this.scrollViewer.isVisible=!0,this.isVisible=!0)}hide(){this.scrollViewer&&(this.scrollViewer.isVisible=!1,this.isVisible=!1)}createTransformSection(t){this.addSectionHeader("Transform Gizmos"),this.createGizmoButtons(t);const e=new BABYLON.GUI.Container;e.height="10px",this.panel.addControl(e),this.addSectionHeader("Position"),this.addVector3Control("X",t.position.x,i=>{t.position.x=i}),this.addVector3Control("Y",t.position.y,i=>{t.position.y=i}),this.addVector3Control("Z",t.position.z,i=>{t.position.z=i}),this.addSectionHeader("Rotation"),this.addVector3Control("X",t.rotation.x*180/Math.PI,i=>{t.rotation.x=i*Math.PI/180}),this.addVector3Control("Y",t.rotation.y*180/Math.PI,i=>{t.rotation.y=i*Math.PI/180}),this.addVector3Control("Z",t.rotation.z*180/Math.PI,i=>{t.rotation.z=i*Math.PI/180}),this.addSectionHeader("Scale"),this.addVector3Control("X",t.scaling.x,i=>{t.scaling.x=i}),this.addVector3Control("Y",t.scaling.y,i=>{t.scaling.y=i}),this.addVector3Control("Z",t.scaling.z,i=>{t.scaling.z=i})}createLightGizmoButtons(t){const e=new BABYLON.GUI.StackPanel;e.height="40px",e.isVertical=!1,e.paddingLeft="5px",this.moveButton=BABYLON.GUI.Button.CreateSimpleButton("moveGizmo","Move"),this.moveButton.width="90px",this.moveButton.height="35px",this.moveButton.color="white",this.moveButton.background="#3a3a3a",this.moveButton.fontSize=13,this.moveButton.cornerRadius=4,this.moveButton.onPointerClickObservable.add(()=>{this.toggleLightGizmoMode("move",t)}),e.addControl(this.moveButton),this.panel.addControl(e),this.updateGizmoButtonStates()}createGizmoButtons(t){const e=new BABYLON.GUI.StackPanel;e.height="40px",e.isVertical=!1,e.paddingLeft="5px",this.moveButton=BABYLON.GUI.Button.CreateSimpleButton("moveGizmo","Move"),this.moveButton.width="90px",this.moveButton.height="35px",this.moveButton.color="white",this.moveButton.background="#3a3a3a",this.moveButton.fontSize=13,this.moveButton.cornerRadius=4,this.moveButton.paddingRight="3px",this.moveButton.onPointerClickObservable.add(()=>{this.toggleGizmoMode("move")}),e.addControl(this.moveButton),this.rotateButton=BABYLON.GUI.Button.CreateSimpleButton("rotateGizmo","Rotate"),this.rotateButton.width="90px",this.rotateButton.height="35px",this.rotateButton.color="white",this.rotateButton.background="#3a3a3a",this.rotateButton.fontSize=13,this.rotateButton.cornerRadius=4,this.rotateButton.paddingLeft="3px",this.rotateButton.paddingRight="3px",this.rotateButton.onPointerClickObservable.add(()=>{this.toggleGizmoMode("rotate")}),e.addControl(this.rotateButton),this.scaleButton=BABYLON.GUI.Button.CreateSimpleButton("scaleGizmo","Scale"),this.scaleButton.width="90px",this.scaleButton.height="35px",this.scaleButton.color="white",this.scaleButton.background="#3a3a3a",this.scaleButton.fontSize=13,this.scaleButton.cornerRadius=4,this.scaleButton.paddingLeft="3px",this.scaleButton.onPointerClickObservable.add(()=>{this.toggleGizmoMode("scale")}),e.addControl(this.scaleButton),this.panel.addControl(e);const i=new BABYLON.GUI.StackPanel;i.height="30px",i.isVertical=!1,i.paddingLeft="5px",i.paddingTop="5px";const o=new BABYLON.GUI.Checkbox;o.name="uniformScale",o.width="20px",o.height="20px",o.isChecked=this.uniformScaling,o.color="#4a9eff",o.background="#3a3a3a",o.onIsCheckedChangedObservable.add(s=>{this.uniformScaling=s,this.editor.updateScaleGizmoUniformMode(s)}),i.addControl(o);const n=new BABYLON.GUI.TextBlock;n.text=" Lock Aspect Ratio",n.width="150px",n.height="20px",n.color="white",n.fontSize=12,n.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,n.paddingLeft="5px",i.addControl(n),this.panel.addControl(i),this.uniformScaleCheckbox=i,this.updateGizmoButtonStates()}toggleLightGizmoMode(t,e){this.activeGizmoMode===t?(this.activeGizmoMode=null,this.editor.setLightGizmoMode(null,e)):(this.activeGizmoMode=t,this.editor.setLightGizmoMode(t,e)),this.updateGizmoButtonStates()}toggleGizmoMode(t){this.activeGizmoMode===t?(this.activeGizmoMode=null,this.editor.setGizmoMode(null)):(this.activeGizmoMode=t,this.editor.setGizmoMode(t)),this.updateGizmoButtonStates()}updateGizmoButtonStates(){this.moveButton&&(this.activeGizmoMode==="move"?this.moveButton.background="#4a9eff":this.moveButton.background="#3a3a3a"),this.rotateButton&&(this.activeGizmoMode==="rotate"?this.rotateButton.background="#4a9eff":this.rotateButton.background="#3a3a3a"),this.scaleButton&&(this.activeGizmoMode==="scale"?this.scaleButton.background="#4a9eff":this.scaleButton.background="#3a3a3a"),this.uniformScaleCheckbox&&(this.uniformScaleCheckbox.isVisible=this.activeGizmoMode==="scale")}addSectionHeader(t){const e=new BABYLON.GUI.TextBlock;e.text=t,e.height="25px",e.color="white",e.fontSize=14,e.fontWeight="bold",e.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.paddingLeft="5px",this.panel.addControl(e)}addVector3Control(t,e,i){const o=new BABYLON.GUI.StackPanel;o.height="30px",o.isVertical=!1;const n=new BABYLON.GUI.TextBlock;n.text=t+":",n.width="30px",n.color="white",n.fontSize=12,n.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,o.addControl(n);const s=new BABYLON.GUI.InputText;s.width="240px",s.height="25px",s.color="white",s.background="#3a3a3a",s.text=e.toFixed(2),s.fontSize=12,s.onTextChangedObservable.add(a=>{const l=parseFloat(a.text);isNaN(l)||i(l)}),o.addControl(s),this.panel.addControl(o)}}class O{constructor(t,e){this.editor=t,this.guiTexture=e,this.panel=null,this.scrollViewer=null,this.objectButtons=new Map,this.isVisible=!0,this.initialize()}initialize(){this.scrollViewer=new BABYLON.GUI.ScrollViewer,this.scrollViewer.width="240px",this.scrollViewer.height="45%",this.scrollViewer.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,this.scrollViewer.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM,this.scrollViewer.left="10px",this.scrollViewer.top="-50px",this.scrollViewer.background="#2a2a2a",this.scrollViewer.thickness=2,this.scrollViewer.thumbLength=.5,this.scrollViewer.barColor="#4a9eff",this.scrollViewer.barBackground="#1a1a1a",this.scrollViewer.isPointerBlocker=!0,this.guiTexture.addControl(this.scrollViewer),this.panel=new BABYLON.GUI.StackPanel,this.panel.width="200px",this.scrollViewer.addControl(this.panel),this.editor.selectionManager.addSelectionCallback(t=>{this.highlightSelected(t)}),this.refresh(),console.log("SceneHierarchy initialized with 45% height and scrolling")}refresh(){this.panel.clearControls(),this.objectButtons.clear();const t=new BABYLON.GUI.TextBlock;t.text="Scene Hierarchy",t.height="30px",t.width="190px",t.color="#4a9eff",t.fontSize=16,t.fontWeight="bold",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.textWrapping=!0,t.paddingLeft="5px",this.panel.addControl(t);const e=this.editor.scene.meshes.filter(o=>!o.name.startsWith("_")),i=this.editor.scene.lights;this.addSection("Meshes",e),this.addSection("Lights",i)}addSection(t,e){if(e.length===0)return;const i=new BABYLON.GUI.TextBlock;i.text=t,i.height="25px",i.color="white",i.fontSize=14,i.fontWeight="bold",i.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,i.paddingLeft="5px",this.panel.addControl(i),e.forEach(n=>{const s=this.createObjectButton(n);this.panel.addControl(s),this.objectButtons.set(n,s)});const o=new BABYLON.GUI.Container;o.height="5px",this.panel.addControl(o)}createObjectButton(t){const e=BABYLON.GUI.Button.CreateSimpleButton(`hierarchy_${t.name}_${Date.now()}`,t.name);return e.width="180px",e.height="25px",e.color="white",e.background="#333",e.fontSize=12,e.cornerRadius=2,e.paddingLeft="10px",e.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.onPointerEnterObservable.add(()=>{this.editor.selectionManager.selectedObject!==t&&(e.background="#444")}),e.onPointerOutObservable.add(()=>{this.editor.selectionManager.selectedObject!==t&&(e.background="#333")}),e.onPointerClickObservable.add(()=>{this.editor.selectionManager.selectObject(t)}),e}highlightSelected(t){this.objectButtons.forEach((e,i)=>{i===t?e.background="#4a9eff":e.background="#333"})}show(){this.scrollViewer&&(this.scrollViewer.isVisible=!0,this.isVisible=!0)}hide(){this.scrollViewer&&(this.scrollViewer.isVisible=!1,this.isVisible=!1)}}class z{constructor(t,e){this.guiTexture=t,this.pipeline=e,this.panel=null,this.scrollViewer=null,this.isVisible=!1,this.toggleButton=null,this.initialize()}initialize(){this.toggleButton=BABYLON.GUI.Button.CreateSimpleButton("settingsToggle","⚙ Settings"),this.toggleButton.width="100px",this.toggleButton.height="30px",this.toggleButton.color="white",this.toggleButton.background="#2a2a2a",this.toggleButton.fontSize=14,this.toggleButton.cornerRadius=4,this.toggleButton.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT,this.toggleButton.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,this.toggleButton.top="50px",this.toggleButton.left="-10px",this.toggleButton.onPointerClickObservable.add(()=>{this.toggle()}),this.guiTexture.addControl(this.toggleButton),this.scrollViewer=new BABYLON.GUI.ScrollViewer,this.scrollViewer.width="320px",this.scrollViewer.height="500px",this.scrollViewer.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT,this.scrollViewer.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,this.scrollViewer.top="90px",this.scrollViewer.left="-10px",this.scrollViewer.background="#2a2a2a",this.scrollViewer.thickness=2,this.scrollViewer.barColor="#4a9eff",this.scrollViewer.barBackground="#1a1a1a",this.scrollViewer.isVisible=!1,this.scrollViewer.isPointerBlocker=!0,this.guiTexture.addControl(this.scrollViewer),this.panel=new BABYLON.GUI.StackPanel,this.panel.width="300px",this.scrollViewer.addControl(this.panel),this.createControls(),console.log("SettingsPanel initialized")}createControls(){const t=this.createHeader("Post-Processing Settings");this.panel.addControl(t),this.addCheckbox("FXAA Antialiasing",this.pipeline.fxaaEnabled,e=>{this.pipeline.fxaaEnabled=e}),this.addSectionHeader("Bloom"),this.addCheckbox("Enable Bloom",this.pipeline.bloomEnabled,e=>{this.pipeline.bloomEnabled=e}),this.addSlider("Bloom Threshold",this.pipeline.bloomThreshold,0,1,e=>{this.pipeline.bloomThreshold=e}),this.addSlider("Bloom Weight",this.pipeline.bloomWeight,0,1,e=>{this.pipeline.bloomWeight=e}),this.addSlider("Bloom Scale",this.pipeline.bloomScale,0,1,e=>{this.pipeline.bloomScale=e}),this.addSectionHeader("Image Processing"),this.addSlider("Contrast",this.pipeline.imageProcessing.contrast,.5,2,e=>{this.pipeline.imageProcessing.contrast=e}),this.addSlider("Exposure",this.pipeline.imageProcessing.exposure,.5,2,e=>{this.pipeline.imageProcessing.exposure=e}),this.addSectionHeader("Vignette"),this.addCheckbox("Enable Vignette",this.pipeline.imageProcessing.vignetteEnabled,e=>{this.pipeline.imageProcessing.vignetteEnabled=e}),this.addSlider("Vignette Weight",this.pipeline.imageProcessing.vignetteWeight,0,4,e=>{this.pipeline.imageProcessing.vignetteWeight=e}),this.addSectionHeader("Chromatic Aberration"),this.addCheckbox("Enable Chromatic Aberration",this.pipeline.chromaticAberrationEnabled,e=>{this.pipeline.chromaticAberrationEnabled=e}),this.addSlider("Aberration Amount",this.pipeline.chromaticAberration.aberrationAmount,0,100,e=>{this.pipeline.chromaticAberration.aberrationAmount=e}),this.addSectionHeader("Film Grain"),this.addCheckbox("Enable Grain",this.pipeline.grainEnabled,e=>{this.pipeline.grainEnabled=e}),this.addSlider("Grain Intensity",this.pipeline.grain.intensity,0,50,e=>{this.pipeline.grain.intensity=e}),this.addCheckbox("Animated Grain",this.pipeline.grain.animated,e=>{this.pipeline.grain.animated=e}),this.addSectionHeader("Sharpen"),this.addCheckbox("Enable Sharpen",this.pipeline.sharpenEnabled,e=>{this.pipeline.sharpenEnabled=e}),this.addSlider("Edge Amount",this.pipeline.sharpen.edgeAmount,0,1,e=>{this.pipeline.sharpen.edgeAmount=e}),this.addSlider("Color Amount",this.pipeline.sharpen.colorAmount,0,1,e=>{this.pipeline.sharpen.colorAmount=e})}createHeader(t){const e=new BABYLON.GUI.TextBlock;return e.text=t,e.height="40px",e.color="#4a9eff",e.fontSize=18,e.fontWeight="bold",e.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.paddingLeft="10px",e}addSectionHeader(t){const e=new BABYLON.GUI.TextBlock;e.text=t,e.height="30px",e.color="white",e.fontSize=14,e.fontWeight="bold",e.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.paddingLeft="10px",e.paddingTop="10px",this.panel.addControl(e)}addCheckbox(t,e,i){const o=new BABYLON.GUI.StackPanel;o.height="30px",o.isVertical=!1,o.paddingLeft="10px";const n=new BABYLON.GUI.Checkbox;n.width="20px",n.height="20px",n.isChecked=e,n.color="#4a9eff",n.background="#3a3a3a",n.onIsCheckedChangedObservable.add(a=>{i(a)});const s=new BABYLON.GUI.TextBlock;s.text=t,s.width="250px",s.height="20px",s.color="white",s.fontSize=12,s.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,s.paddingLeft="10px",o.addControl(n),o.addControl(s),this.panel.addControl(o)}addSlider(t,e,i,o,n){const s=new BABYLON.GUI.TextBlock;s.text=`${t}: ${e.toFixed(2)}`,s.height="25px",s.color="white",s.fontSize=12,s.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,s.paddingLeft="10px",this.panel.addControl(s);const a=new BABYLON.GUI.Slider;a.minimum=i,a.maximum=o,a.value=e,a.height="20px",a.width="280px",a.color="#4a9eff",a.background="#3a3a3a",a.borderColor="#4a9eff",a.onValueChangedObservable.add(c=>{s.text=`${t}: ${c.toFixed(2)}`,n(c)}),this.panel.addControl(a);const l=new BABYLON.GUI.Container;l.height="5px",this.panel.addControl(l)}toggle(){this.isVisible=!this.isVisible,this.scrollViewer.isVisible=this.isVisible,this.isVisible?this.toggleButton.background="#4a9eff":this.toggleButton.background="#2a2a2a"}show(){this.isVisible=!0,this.scrollViewer.isVisible=!0,this.toggleButton.background="#4a9eff"}hide(){this.isVisible=!1,this.scrollViewer.isVisible=!1,this.toggleButton.background="#2a2a2a"}refresh(){this.panel.clearControls(),this.createControls(),console.log("Settings panel refreshed with loaded values")}}let m=null,g=null,p=null,S=Date.now(),h=null,f=null;window.addEventListener("DOMContentLoaded",()=>{v()});function G(r,t){const e=new BABYLON.DefaultRenderingPipeline("defaultPipeline",!0,r,t);return e.samples=4,e.fxaaEnabled=!0,e.bloomEnabled=!0,e.bloomThreshold=.8,e.bloomWeight=.3,e.bloomKernel=64,e.bloomScale=.5,e.imageProcessingEnabled=!0,e.imageProcessing.contrast=1.1,e.imageProcessing.exposure=1,e.imageProcessing.toneMappingEnabled=!0,e.imageProcessing.toneMappingType=BABYLON.ImageProcessingConfiguration.TONEMAPPING_ACES,e.imageProcessing.vignetteEnabled=!0,e.imageProcessing.vignetteWeight=1.5,e.imageProcessing.vignetteCameraFov=.8,e.chromaticAberrationEnabled=!0,e.chromaticAberration.aberrationAmount=5,e.grainEnabled=!0,e.grain.intensity=10,e.grain.animated=!0,e.sharpenEnabled=!0,e.sharpen.edgeAmount=.3,e.sharpen.colorAmount=.5,console.log("Post-processing pipeline initialized with bloom, AA, and effects"),e}function N(){const r={webglSupported:!1,webgl2Supported:!1,browserName:"Unknown",browserVersion:"Unknown",compatible:!1,warnings:[]},t=navigator.userAgent;t.indexOf("Chrome")>-1&&t.indexOf("Edg")===-1?r.browserName="Chrome":t.indexOf("Firefox")>-1?r.browserName="Firefox":t.indexOf("Edg")>-1?r.browserName="Edge":t.indexOf("Safari")>-1&&(r.browserName="Safari");const e=document.createElement("canvas"),i=e.getContext("webgl")||e.getContext("experimental-webgl"),o=e.getContext("webgl2");return i&&(r.webglSupported=!0),o&&(r.webgl2Supported=!0),r.webgl2Supported?(r.compatible=!0,console.log("✓ WebGL 2.0 supported")):r.webglSupported?(r.compatible=!0,r.warnings.push("WebGL 2.0 not supported, falling back to WebGL 1.0"),console.warn("⚠ WebGL 2.0 not supported, using WebGL 1.0 fallback")):(r.compatible=!1,console.error("✗ WebGL not supported")),["Chrome","Firefox","Edge"].includes(r.browserName)||r.warnings.push(`Browser ${r.browserName} may not be fully supported. Recommended: Chrome, Firefox, or Edge`),console.log(`Browser: ${r.browserName}, WebGL: ${r.webglSupported}, WebGL2: ${r.webgl2Supported}`),r}function M(){const r=document.createElement("div");return r.id="fps-counter",r.style.cssText=`
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: #00ff00;
    padding: 8px 12px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    z-index: 1000;
    min-width: 80px;
  `,r.textContent="FPS: --",document.body.appendChild(r),r}function T(){if(p&&m){const r=m.getFps().toFixed(0);p.textContent=`FPS: ${r}`,r>=50?p.style.color="#00ff00":r>=30?p.style.color="#ffff00":p.style.color="#ff0000"}}function E(){const r=(Date.now()-S)/1e3;return console.log(`Game loaded in ${r.toFixed(2)} seconds`),r>5?console.warn(`⚠ Load time (${r.toFixed(2)}s) exceeds target of 5 seconds`):console.log("✓ Load time within target (< 5 seconds)"),r}function v(){try{const r=N();if(!r.compatible){u("WebGL is not supported in your browser. Please use a modern browser like Chrome, Firefox, or Edge.");return}r.warnings.length>0&&r.warnings.forEach(s=>{console.warn(s)});const t=document.getElementById("renderCanvas");if(!t){console.error("Canvas element not found"),u("Failed to initialize: Canvas element not found");return}try{m=new BABYLON.Engine(t,!0,{preserveDrawingBuffer:!0,stencil:!0,disableWebGL2Support:!r.webgl2Supported})}catch(s){console.error("Failed to create Babylon.js engine:",s),u("WebGL not supported or failed to initialize. Please use a modern browser.");return}g=new BABYLON.Scene(m),g.clearColor=new BABYLON.Color3(.01,.01,.02),BABYLON.KhronosTextureContainer2&&(m.enableOfflineSupport=!1,g.enableOfflineSupport=!1,BABYLON.KhronosTextureContainer2.URLConfig||(BABYLON.KhronosTextureContainer2.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,jsMSCTranscoder:null,wasmMSCTranscoder:null}),console.log("KTX2 decoder initialized for compressed textures"));const e=new BABYLON.HemisphericLight("hemisphericLight",new BABYLON.Vector3(0,1,0),g);e.intensity=.5,e.diffuse=new BABYLON.Color3(.8,.8,.9),console.log("Basic scene initialized without room geometry");const i=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");h=new x(g,t),h.initialize(i),h.objectPalette=new A(h,i),h.propertyPanel=new y(h,i),h.sceneHierarchy=new O(h,i);const o=[h.cameraManager.editorCamera,h.cameraManager.playerCamera];f=G(g,o),window.postProcessingPipeline=f;const n=new z(i,f);window.settingsPanel=n,h.enterEditorMode(),setTimeout(()=>{h.autoLoadScene()},100),window.addEventListener("resize",()=>{m.resize()}),console.log("Spooky Game - Engine and scene initialized successfully"),p=M(),E(),m.runRenderLoop(()=>{try{g.render(),T()}catch(s){console.error("Render error:",s)}})}catch(r){console.error("Unexpected error during initialization:",r),u("An unexpected error occurred during initialization")}}function u(r){let t=document.getElementById("error-message");t||(t=document.createElement("div"),t.id="error-message",t.style.cssText="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ff0000; color: #ffffff; padding: 20px; border-radius: 5px; font-family: Arial, sans-serif; z-index: 1000;",document.body.appendChild(t)),t.textContent=r}
