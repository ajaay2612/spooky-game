(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function t(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(o){if(o.ep)return;o.ep=!0;const n=t(o);fetch(o.href,n)}})();class w{constructor(e,t=null){this.scene=e,this.editorManager=t,this.selectedObject=null,this.highlightLayer=null,this.onSelectionChanged=null,this.selectionCallbacks=[],this.initialize()}initialize(){this.highlightLayer=new BABYLON.HighlightLayer("highlight",this.scene),this.highlightLayer.outerGlow=!0,this.highlightLayer.innerGlow=!1,console.log("SelectionManager initialized with HighlightLayer")}setupPicking(e){this.scene.onPointerDown=(t,i)=>{this.editorManager&&!this.editorManager.isEditorMode||t.button===0&&(i.hit&&i.pickedMesh?i.pickedMesh.name.startsWith("_")||this.selectObject(i.pickedMesh):this.deselectObject())},console.log("Mouse picking enabled for object selection")}selectObject(e){if(!e||e.isDisposed()){console.warn("Cannot select invalid or disposed object");return}let t=e;if(e instanceof BABYLON.Mesh){let i=e;for(;i;){if(i.metadata&&i.metadata.isImportedGLTF){t=i,console.log(`Found GLTF root: ${t.name} (clicked on ${e.name})`);break}i=i.parent}}this.selectedObject&&this.selectedObject instanceof BABYLON.Mesh&&this.highlightLayer.removeMesh(this.selectedObject),this.selectedObject=t,t instanceof BABYLON.Mesh&&this.highlightLayer.addMesh(t,BABYLON.Color3.Yellow()),this.onSelectionChanged&&this.onSelectionChanged(t),this.selectionCallbacks.forEach(i=>i(t)),console.log(`Selected object: ${t.name}`)}deselectObject(){this.selectedObject&&(this.selectedObject instanceof BABYLON.Mesh&&this.highlightLayer.removeMesh(this.selectedObject),console.log(`Deselected object: ${this.selectedObject.name}`),this.selectedObject=null,this.onSelectionChanged&&this.onSelectionChanged(null),this.selectionCallbacks.forEach(e=>e(null)))}addSelectionCallback(e){e&&typeof e=="function"&&this.selectionCallbacks.push(e)}dispose(){this.highlightLayer&&(this.highlightLayer.dispose(),this.highlightLayer=null)}}class C{constructor(e,t){this.scene=e,this.canvas=t,this.editorCamera=null,this.playerCamera=null,this.activeCamera=null}createPlayerCamera(){const e=new BABYLON.UniversalCamera("playerCamera",new BABYLON.Vector3(0,1.6,-5),this.scene);return e.setTarget(new BABYLON.Vector3(0,1.6,0)),e.speed=.1,e.angularSensibility=2e3,e.keysUp=[87],e.keysDown=[83],e.keysLeft=[65],e.keysRight=[68],console.log("Player camera (UniversalCamera) created"),this.playerCamera=e,e}createEditorCamera(){const e=new BABYLON.ArcRotateCamera("editorCamera",Math.PI/2,Math.PI/3,15,new BABYLON.Vector3(0,1.5,0),this.scene);return e.panningSensibility=1e3,e.wheelPrecision=50,e.angularSensibilityX=1e3,e.angularSensibilityY=1e3,e.lowerRadiusLimit=2,e.upperRadiusLimit=100,e.lowerBetaLimit=.1,e.upperBetaLimit=Math.PI/2,e.inputs.attached.pointers.buttons=[2,1,0],console.log("Editor camera (ArcRotateCamera) created"),this.editorCamera=e,e}switchToEditorCamera(){this.editorCamera||this.createEditorCamera(),document.pointerLockElement===this.canvas&&document.exitPointerLock(),this.playerCamera&&this.playerCamera.detachControl(),this.editorCamera.attachControl(this.canvas,!0),this.scene.activeCamera=this.editorCamera,this.activeCamera=this.editorCamera,console.log("Switched to editor camera")}switchToPlayerCamera(){this.playerCamera||this.createPlayerCamera(),this.editorCamera&&this.editorCamera.detachControl(),this.playerCamera.attachControl(this.canvas,!0),this.scene.activeCamera=this.playerCamera,this.activeCamera=this.playerCamera,this.canvas.requestPointerLock(),console.log("Switched to player camera")}initialize(){this.createPlayerCamera(),this.createEditorCamera(),this.switchToEditorCamera()}}class b{constructor(e){this.scene=e,this.objectCounter=0}createPrimitive(e){const t=`${e}_${this.objectCounter++}`;let i;switch(e.toLowerCase()){case"box":i=BABYLON.MeshBuilder.CreateBox(t,{size:1},this.scene);break;case"sphere":i=BABYLON.MeshBuilder.CreateSphere(t,{diameter:1},this.scene);break;case"cylinder":i=BABYLON.MeshBuilder.CreateCylinder(t,{height:2,diameter:1},this.scene);break;case"cone":i=BABYLON.MeshBuilder.CreateCylinder(t,{height:2,diameterTop:0,diameterBottom:1},this.scene);break;case"plane":i=BABYLON.MeshBuilder.CreatePlane(t,{size:1},this.scene);break;case"torus":i=BABYLON.MeshBuilder.CreateTorus(t,{diameter:1,thickness:.3},this.scene);break;default:return console.warn(`Unknown primitive type: ${e}`),null}i.position=new BABYLON.Vector3(0,1,0);const o=new BABYLON.StandardMaterial(`${t}_mat`,this.scene);return o.diffuseColor=new BABYLON.Color3(Math.random(),Math.random(),Math.random()),i.material=o,console.log(`Created primitive: ${t}`),i}createLight(e){const t=`${e}Light_${this.objectCounter++}`;let i;switch(e.toLowerCase()){case"point":i=new BABYLON.PointLight(t,new BABYLON.Vector3(0,3,0),this.scene);break;case"directional":i=new BABYLON.DirectionalLight(t,new BABYLON.Vector3(0,-1,0),this.scene),i.position=new BABYLON.Vector3(0,5,0);break;case"spot":i=new BABYLON.SpotLight(t,new BABYLON.Vector3(0,3,0),new BABYLON.Vector3(0,-1,0),Math.PI/3,2,this.scene);break;case"hemispheric":i=new BABYLON.HemisphericLight(t,new BABYLON.Vector3(0,1,0),this.scene);break;default:return console.warn(`Unknown light type: ${e}`),null}return i.intensity=.5,console.log(`Created light: ${t}`),i}async importGLTF(e,t=null,i=!1){try{console.log(`Importing GLTF from: ${e}`);let o="",n=e;e.startsWith("/models/")&&(o="/models/",n=e.replace("/models/",""));const s=await BABYLON.SceneLoader.ImportMeshAsync(null,o,n,this.scene,null,".glb");if(s.meshes&&s.meshes.length>0){let r=s.meshes[0];const l=s.meshes.find(d=>d.name==="__root__");l&&(r=l),console.log("GLTF meshes:",s.meshes.map(d=>{var x;return{name:d.name,parent:(x=d.parent)==null?void 0:x.name}})),console.log("Selected root mesh:",r.name),r.name=`imported_${this.objectCounter++}`;const c=r.scaling.clone();return r.position=new BABYLON.Vector3(0,0,0),r.rotation=new BABYLON.Vector3(0,0,0),r.scaling=new BABYLON.Vector3(Math.sign(c.x)||1,Math.sign(c.y)||1,Math.sign(c.z)||1),i?console.log(`Reset transforms for ${r.name}, ready for saved transforms`):(r.position=new BABYLON.Vector3(0,1,0),console.log(`Set default position for ${r.name}:`,r.position)),r.metadata={isImportedGLTF:!0,modelPath:e.startsWith("/models/")?e:null,modelName:t,originalName:r.name},console.log(`Successfully imported GLTF: ${r.name} with ${s.meshes.length} meshes`),r}else throw new Error("No meshes found in GLTF file")}catch(o){throw console.error("Failed to load GLTF:",o),new Error(`Unable to load model: ${o.message}`)}}duplicateObject(e){if(!e)return console.warn("Cannot duplicate null object"),null;let t=null;if(e instanceof BABYLON.Mesh){if(t=e.clone(`${e.name}_copy_${this.objectCounter++}`),t.position=e.position.add(new BABYLON.Vector3(1,0,1)),e.material){const i=e.material.clone(`${t.name}_mat`);t.material=i}console.log(`Duplicated mesh: ${t.name}`)}else if(e instanceof BABYLON.Light){const i=this.getLightType(e);t=this.createLight(i),t.intensity=e.intensity,e.diffuse&&(t.diffuse=e.diffuse.clone()),e.position&&(t.position=e.position.add(new BABYLON.Vector3(1,0,1))),e.direction&&t.direction&&(t.direction=e.direction.clone()),console.log(`Duplicated light: ${t.name}`)}else console.warn(`Cannot duplicate object of type: ${e.constructor.name}`);return t}getLightType(e){return e instanceof BABYLON.PointLight?"point":e instanceof BABYLON.DirectionalLight?"directional":e instanceof BABYLON.SpotLight?"spot":e instanceof BABYLON.HemisphericLight?"hemispheric":"point"}}class y{constructor(e){this.scene=e}serializeScene(){const e={version:"1.0",objects:[],postProcessing:null};if(this.scene.meshes.forEach(t=>{if(t.name.startsWith("_")||t.name==="floor"||t.name==="ceiling"||t.name.startsWith("wall"))return;if(t.metadata&&t.metadata.isImportedGLTF){console.log(`Serializing GLTF model ${t.name}`);const n={type:"gltf",name:t.name,position:t.position.asArray(),rotation:t.rotation.asArray(),scaling:t.scaling.asArray(),modelPath:t.metadata.modelPath,modelName:t.metadata.modelName};e.objects.push(n);return}let i=t.parent;for(;i;){if(i.metadata&&i.metadata.isImportedGLTF)return;i=i.parent}const o={type:"mesh",meshType:this.getMeshType(t),name:t.name,position:t.position.asArray(),rotation:t.rotation.asArray(),scaling:t.scaling.asArray()};t.material&&(o.material=this.serializeMaterial(t.material)),e.objects.push(o)}),this.scene.lights.forEach(t=>{const i={type:"light",lightType:this.getLightType(t),name:t.name,intensity:t.intensity,diffuse:t.diffuse.asArray()};t.specular&&(i.specular=t.specular.asArray()),t.groundColor&&(i.groundColor=t.groundColor.asArray()),t.position&&(i.position=t.position.asArray()),t.direction&&(i.direction=t.direction.asArray()),t.range!==void 0&&(i.range=t.range),e.objects.push(i)}),window.postProcessingPipeline){const t=window.postProcessingPipeline;e.postProcessing={fxaaEnabled:t.fxaaEnabled,bloomEnabled:t.bloomEnabled,bloomThreshold:t.bloomThreshold,bloomWeight:t.bloomWeight,bloomScale:t.bloomScale,contrast:t.imageProcessing.contrast,exposure:t.imageProcessing.exposure,vignetteEnabled:t.imageProcessing.vignetteEnabled,vignetteWeight:t.imageProcessing.vignetteWeight,chromaticAberrationEnabled:t.chromaticAberrationEnabled,chromaticAberrationAmount:t.chromaticAberration.aberrationAmount,grainEnabled:t.grainEnabled,grainIntensity:t.grain.intensity,grainAnimated:t.grain.animated,sharpenEnabled:t.sharpenEnabled,sharpenEdgeAmount:t.sharpen.edgeAmount,sharpenColorAmount:t.sharpen.colorAmount},console.log("Post-processing settings serialized")}return JSON.stringify(e,null,2)}getMeshType(e){const t=e.name.toLowerCase();return t.includes("box")?"box":t.includes("sphere")?"sphere":t.includes("cylinder")?"cylinder":t.includes("cone")?"cone":t.includes("plane")?"plane":t.includes("torus")?"torus":"box"}getLightType(e){return e instanceof BABYLON.PointLight?"point":e instanceof BABYLON.DirectionalLight?"directional":e instanceof BABYLON.SpotLight?"spot":e instanceof BABYLON.HemisphericLight?"hemispheric":"point"}serializeMaterial(e){const t={};return e.diffuseColor&&(t.diffuseColor=e.diffuseColor.asArray()),e.specularColor&&(t.specularColor=e.specularColor.asArray()),e.emissiveColor&&(t.emissiveColor=e.emissiveColor.asArray()),t}applyMaterialData(e,t){t.diffuseColor&&(e.diffuseColor=BABYLON.Color3.FromArray(t.diffuseColor)),t.specularColor&&(e.specularColor=BABYLON.Color3.FromArray(t.specularColor)),t.emissiveColor&&(e.emissiveColor=BABYLON.Color3.FromArray(t.emissiveColor))}clearScene(){this.scene.meshes.filter(i=>!i.name.startsWith("_")&&i.name!=="floor"&&i.name!=="ceiling"&&!i.name.startsWith("wall")).forEach(i=>{i.material&&i.material.dispose(),i.dispose()}),[...this.scene.lights].forEach(i=>{i.dispose()})}async deserializeScene(e){const t=JSON.parse(e),i=new b(this.scene);this.clearScene();for(const o of t.objects)if(o.type==="gltf")try{const n=await i.importGLTF(o.modelPath,o.modelName,!0);n&&(n.name=o.name,n.position.fromArray(o.position),n.rotation.fromArray(o.rotation),n.scaling.fromArray(o.scaling),console.log(`Restored GLTF model ${o.name}`))}catch(n){console.error(`Failed to restore GLTF model ${o.name}:`,n)}else if(o.type==="mesh"){const n=i.createPrimitive(o.meshType);n&&(n.name=o.name,n.position.fromArray(o.position),n.rotation.fromArray(o.rotation),n.scaling.fromArray(o.scaling),o.material&&n.material&&this.applyMaterialData(n.material,o.material))}else if(o.type==="light"){const n=i.createLight(o.lightType);n&&(n.name=o.name,n.intensity=o.intensity,n.diffuse.fromArray(o.diffuse),o.specular&&n.specular&&n.specular.fromArray(o.specular),o.groundColor&&n.groundColor&&n.groundColor.fromArray(o.groundColor),o.position&&n.position&&n.position.fromArray(o.position),o.direction&&n.direction&&n.direction.fromArray(o.direction),o.range!==void 0&&n.range!==void 0&&(n.range=o.range))}if(t.postProcessing&&window.postProcessingPipeline){const o=window.postProcessingPipeline,n=t.postProcessing;o.fxaaEnabled=n.fxaaEnabled,o.bloomEnabled=n.bloomEnabled,o.bloomThreshold=n.bloomThreshold,o.bloomWeight=n.bloomWeight,o.bloomScale=n.bloomScale,o.imageProcessing.contrast=n.contrast,o.imageProcessing.exposure=n.exposure,o.imageProcessing.vignetteEnabled=n.vignetteEnabled,o.imageProcessing.vignetteWeight=n.vignetteWeight,o.chromaticAberrationEnabled=n.chromaticAberrationEnabled,o.chromaticAberration.aberrationAmount=n.chromaticAberrationAmount,o.grainEnabled=n.grainEnabled,o.grain.intensity=n.grainIntensity,o.grain.animated=n.grainAnimated,o.sharpenEnabled=n.sharpenEnabled,o.sharpen.edgeAmount=n.sharpenEdgeAmount,o.sharpen.colorAmount=n.sharpenColorAmount,console.log("Post-processing settings restored"),window.settingsPanel&&window.settingsPanel.refresh()}console.log("Scene deserialized successfully")}async saveToFile(){try{console.log("Starting scene save...");const e=this.serializeScene(),i=await(await fetch("http://localhost:3001/api/save-scene",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:e})})).json();if(i.success)console.log("✓ Scene saved to saved-3d-env.json");else throw new Error(i.error)}catch(e){throw console.error("✗ Failed to save scene:",e),alert(`Failed to save scene: ${e.message}
Make sure the server is running (npm run server)`),e}}async loadFromFile(e=!1){try{console.log("Starting scene load...");const t=await fetch("/saved-3d-env.json");if(!t.ok)throw new Error("No saved scene found");const i=await t.text();console.log("Deserializing scene data..."),await this.deserializeScene(i),console.log("✓ Scene loaded from saved-3d-env.json")}catch(t){throw e||console.error("✗ Failed to load scene:",t),t}}}class L{constructor(e,t){this.scene=e,this.canvas=t,this.isEditorMode=!0,this.selectionManager=null,this.objectFactory=null,this.serializationManager=null,this.cameraManager=null,this.objectPalette=null,this.propertyPanel=null,this.sceneHierarchy=null,this.guiTexture=null,this.gizmoManager=null,this.activeGizmo=null,this.lightHelpers=new Map}initialize(e){this.guiTexture=e,this.selectionManager=new w(this.scene,this),this.objectFactory=new b(this.scene),this.serializationManager=new y(this.scene),this.cameraManager=new C(this.scene,this.canvas),this.cameraManager.initialize(),this.selectionManager.setupPicking(this.canvas),this.initializeGizmos(),this.selectionManager.addSelectionCallback(t=>{this.updateGizmoAttachment()}),this.setupKeyboardShortcuts(),console.log("EditorManager initialized")}initializeGizmos(){this.gizmoManager=new BABYLON.GizmoManager(this.scene),this.gizmoManager.usePointerToAttachGizmos=!1,this.gizmoManager.scaleRatio=1,this.gizmoManager.gizmoCoordinatesMode=BABYLON.GizmoCoordinatesMode.Local,this.gizmoManager.positionGizmoEnabled=!1,this.gizmoManager.scaleGizmoEnabled=!1,this.gizmoManager.rotationGizmoEnabled=!1,console.log("Gizmo system initialized"),console.log("GizmoManager:",this.gizmoManager)}setGizmoMode(e){this.gizmoManager.positionGizmoEnabled=!1,this.gizmoManager.rotationGizmoEnabled=!1,this.gizmoManager.scaleGizmoEnabled=!1;const t=this.selectionManager.selectedObject;if(!e||!t){this.activeGizmo=null,this.gizmoManager.attachToMesh(null);return}e==="move"?(this.gizmoManager.positionGizmoEnabled=!0,this.gizmoManager.attachToMesh(t),this.activeGizmo="move",console.log("Position gizmo enabled for:",t.name)):e==="rotate"?(this.gizmoManager.rotationGizmoEnabled=!0,this.gizmoManager.attachToMesh(t),this.activeGizmo="rotate",console.log("Rotation gizmo enabled for:",t.name)):e==="scale"&&(this.gizmoManager.scaleGizmoEnabled=!0,this.gizmoManager.attachToMesh(t),this.activeGizmo="scale",setTimeout(()=>{if(this.gizmoManager.gizmos&&this.gizmoManager.gizmos.scaleGizmo){const i=this.propertyPanel?this.propertyPanel.uniformScaling:!0,o=this.gizmoManager.gizmos.scaleGizmo;i?(o.xGizmo&&(o.xGizmo.isEnabled=!1),o.yGizmo&&(o.yGizmo.isEnabled=!1),o.zGizmo&&(o.zGizmo.isEnabled=!1),o.uniformScaleGizmo&&(o.uniformScaleGizmo.isEnabled=!0)):(o.xGizmo&&(o.xGizmo.isEnabled=!0),o.yGizmo&&(o.yGizmo.isEnabled=!0),o.zGizmo&&(o.zGizmo.isEnabled=!0),o.uniformScaleGizmo&&(o.uniformScaleGizmo.isEnabled=!1)),console.log("Scale gizmo configured - uniform mode:",i)}},10),console.log("Scale gizmo enabled for:",t.name))}updateScaleGizmoUniformMode(e){if(console.log("updateScaleGizmoUniformMode called with:",e),this.gizmoManager&&this.gizmoManager.gizmos&&this.gizmoManager.gizmos.scaleGizmo){const t=this.gizmoManager.gizmos.scaleGizmo;e?(t.xGizmo&&(t.xGizmo.isEnabled=!1),t.yGizmo&&(t.yGizmo.isEnabled=!1),t.zGizmo&&(t.zGizmo.isEnabled=!1),t.uniformScaleGizmo&&(t.uniformScaleGizmo.isEnabled=!0),console.log("Uniform scaling enabled - showing center gizmo only")):(t.xGizmo&&(t.xGizmo.isEnabled=!0),t.yGizmo&&(t.yGizmo.isEnabled=!0),t.zGizmo&&(t.zGizmo.isEnabled=!0),t.uniformScaleGizmo&&(t.uniformScaleGizmo.isEnabled=!1),console.log("Non-uniform scaling enabled - showing axis gizmos"))}else console.warn("Scale gizmo not available")}setupKeyboardShortcuts(){window.addEventListener("keydown",e=>{if(e.key==="e"||e.key==="E"){this.toggleMode();return}this.isEditorMode&&(e.key==="Delete"&&this.deleteSelected(),e.ctrlKey&&(e.key==="d"||e.key==="D")&&(e.preventDefault(),this.duplicateSelected()),e.ctrlKey&&(e.key==="s"||e.key==="S")&&(e.preventDefault(),this.saveScene()),e.ctrlKey&&(e.key==="o"||e.key==="O")&&(e.preventDefault(),this.loadScene()),(e.key==="f"||e.key==="F")&&this.focusOnSelected(),e.key==="Escape"&&this.selectionManager.deselectObject())}),console.log("Keyboard shortcuts registered")}focusOnSelected(){if(this.selectionManager.selectedObject&&this.cameraManager.editorCamera){const e=this.selectionManager.selectedObject.position;this.cameraManager.editorCamera.setTarget(e),console.log(`Focused camera on: ${this.selectionManager.selectedObject.name}`)}}toggleMode(){this.isEditorMode=!this.isEditorMode,this.isEditorMode?this.enterEditorMode():this.enterPlayMode(),console.log(`Mode switched to: ${this.isEditorMode?"Editor":"Play"}`)}enterEditorMode(){this.isEditorMode=!0,this.cameraManager.switchToEditorCamera(),this.guiTexture&&(this.guiTexture.layer.isEnabled=!0),this.objectPalette&&this.objectPalette.show(),this.propertyPanel&&this.propertyPanel.show(),this.sceneHierarchy&&this.sceneHierarchy.show(),this.selectionManager&&this.selectionManager.setupPicking(this.canvas),console.log("Entered editor mode")}enterPlayMode(){this.isEditorMode=!1,this.cameraManager.switchToPlayerCamera(),this.guiTexture&&(this.guiTexture.layer.isEnabled=!1),this.objectPalette&&this.objectPalette.hide(),this.propertyPanel&&this.propertyPanel.hide(),this.sceneHierarchy&&this.sceneHierarchy.hide(),this.selectionManager&&this.selectionManager.deselectObject(),console.log("Entered play mode")}deleteSelected(){const e=this.selectionManager.selectedObject;if(!e){console.warn("No object selected to delete");return}if(["playerCamera","editorCamera","camera"].includes(e.name)){console.warn(`Cannot delete essential object: ${e.name}`),alert(`Cannot delete essential object: ${e.name}`);return}const i=e.name;this.gizmoManager&&this.gizmoManager.attachToMesh(null),this.selectionManager.deselectObject(),e.material&&e.material.dispose(),e.dispose(),this.sceneHierarchy&&this.sceneHierarchy.refresh(),console.log(`Deleted object: ${i}`)}duplicateSelected(){const e=this.selectionManager.selectedObject;if(!e){console.warn("No object selected to duplicate");return}const t=this.objectFactory.duplicateObject(e);t&&(this.selectionManager.selectObject(t),this.sceneHierarchy&&this.sceneHierarchy.refresh(),console.log(`Duplicated object: ${t.name}`))}async saveScene(){try{await this.serializationManager.saveToFile(),console.log("Scene saved successfully")}catch(e){console.error("Failed to save scene:",e)}}async loadScene(e=!1){try{await this.serializationManager.loadFromFile(e),this.selectionManager.deselectObject(),this.sceneHierarchy&&this.sceneHierarchy.refresh(),console.log("Scene loaded successfully")}catch(t){e||console.error("Failed to load scene:",t)}}async autoLoadScene(){try{await this.loadScene(!0),this.sceneHierarchy&&this.sceneHierarchy.refresh(),console.log("Auto-loaded saved scene")}catch{console.log("No saved scene to auto-load"),this.sceneHierarchy&&this.sceneHierarchy.refresh()}}setLightGizmoMode(e,t){if(this.gizmoManager.positionGizmoEnabled=!1,this.gizmoManager.scaleGizmoEnabled=!1,!e||!t){this.activeGizmo=null,this.gizmoManager.attachToMesh(null),this.lightHelpers.has(t)&&(this.lightHelpers.get(t).dispose(),this.lightHelpers.delete(t));return}let i=this.lightHelpers.get(t);if(i||(i=BABYLON.MeshBuilder.CreateSphere(`_lightHelper_${t.name}`,{diameter:.3},this.scene),i.isVisible=!1,i.isPickable=!1,this.scene.onBeforeRenderObservable.add(()=>{t.position&&i&&i.position.copyFrom(t.position)}),this.lightHelpers.set(t,i)),t.position&&i.position.copyFrom(t.position),e==="move"){this.gizmoManager.positionGizmoEnabled=!0,this.gizmoManager.attachToMesh(i),this.activeGizmo="move";const o=this.gizmoManager.gizmos.positionGizmo;o&&o.onDragEndObservable.add(()=>{t.position&&t.position.copyFrom(i.position)}),console.log("Position gizmo enabled for light:",t.name)}}updateGizmoAttachment(){const e=this.selectionManager.selectedObject;this.activeGizmo&&this.gizmoManager&&this.gizmoManager.attachToMesh(e)}dispose(){this.selectionManager&&this.selectionManager.dispose(),this.gizmoManager&&this.gizmoManager.dispose(),this.lightHelpers.forEach(e=>e.dispose()),this.lightHelpers.clear()}}class A{constructor(e,t){this.editor=e,this.guiTexture=t,this.panel=null,this.scrollViewer=null,this.isVisible=!0,this.initialize()}initialize(){this.scrollViewer=new BABYLON.GUI.ScrollViewer,this.scrollViewer.width="240px",this.scrollViewer.height="45%",this.scrollViewer.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,this.scrollViewer.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,this.scrollViewer.top="10px",this.scrollViewer.left="10px",this.scrollViewer.background="#2a2a2a",this.scrollViewer.thickness=2,this.scrollViewer.thumbLength=.5,this.scrollViewer.barColor="#4a9eff",this.scrollViewer.barBackground="#1a1a1a",this.scrollViewer.isPointerBlocker=!0,this.guiTexture.addControl(this.scrollViewer),this.panel=new BABYLON.GUI.StackPanel,this.panel.width="200px",this.scrollViewer.addControl(this.panel),this.createFileSection(),this.createPrimitiveSection(),this.createLightSection(),this.createModelSection(),console.log("ObjectPalette initialized with 45% height and scrolling")}createFileSection(){const e=this.createSectionHeader("File");this.panel.addControl(e);const t=this.createButton("Save Scene",()=>{this.editor.saveScene()});this.panel.addControl(t);const i=this.createButton("Load Scene",()=>{this.editor.loadScene()});this.panel.addControl(i);const o=new BABYLON.GUI.Container;o.height="10px",this.panel.addControl(o)}createSectionHeader(e){const t=new BABYLON.GUI.TextBlock;return t.text=e,t.height="30px",t.width="190px",t.color="#4a9eff",t.fontSize=16,t.fontWeight="bold",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.textWrapping=!0,t.paddingLeft="5px",t}createButton(e,t){const i=BABYLON.GUI.Button.CreateSimpleButton(`btn_${e}_${Date.now()}`,e);return i.width="180px",i.height="30px",i.color="white",i.background="#3a3a3a",i.fontSize=14,i.cornerRadius=4,i.onPointerEnterObservable.add(()=>{i.background="#4a4a4a"}),i.onPointerOutObservable.add(()=>{i.background="#3a3a3a"}),i.onPointerClickObservable.add(t),i}createPrimitiveSection(){const e=this.createSectionHeader("Primitives");this.panel.addControl(e),["Box","Sphere","Cylinder","Cone","Plane","Torus"].forEach(o=>{const n=this.createButton(o,()=>{const s=this.editor.objectFactory.createPrimitive(o);s&&(this.editor.selectionManager.selectObject(s),this.editor.sceneHierarchy&&this.editor.sceneHierarchy.refresh())});this.panel.addControl(n)});const i=new BABYLON.GUI.Container;i.height="10px",this.panel.addControl(i)}createLightSection(){const e=this.createSectionHeader("Lights");this.panel.addControl(e),["Point","Directional","Spot","Hemispheric"].forEach(o=>{const n=this.createButton(o,()=>{const s=this.editor.objectFactory.createLight(o);s&&(this.editor.selectionManager.selectObject(s),this.editor.sceneHierarchy&&this.editor.sceneHierarchy.refresh())});this.panel.addControl(n)});const i=new BABYLON.GUI.Container;i.height="10px",this.panel.addControl(i)}createModelSection(){const e=this.createSectionHeader("Models");this.panel.addControl(e);const t=this.createButton("Load Model",()=>{this.openModelSelector()});this.panel.addControl(t)}async openModelSelector(){try{const t=await(await fetch("http://localhost:3001/api/list-models")).json();if(!t.success)throw new Error(t.error);const i=t.models;if(i.length===0){alert(`No models found in the /models directory.
Place your .gltf or .glb files there.`);return}this.showModelSelectionDialog(i)}catch(e){console.error("Failed to list models:",e),alert(`Failed to load models list: ${e.message}
Make sure the server is running.`)}}showModelSelectionDialog(e){const t=document.createElement("div");t.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    `;const i=document.createElement("div");i.style.cssText=`
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      max-height: 500px;
      overflow-y: auto;
      color: white;
      font-family: Arial, sans-serif;
    `;const o=document.createElement("h3");o.textContent="Select Model",o.style.cssText="margin-top: 0; color: #4a9eff;",i.appendChild(o),e.forEach(s=>{const r=document.createElement("button");r.textContent=s,r.style.cssText=`
        display: block;
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        background: #3a3a3a;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      `,r.onmouseenter=()=>r.style.background="#4a4a4a",r.onmouseleave=()=>r.style.background="#3a3a3a",r.onclick=async()=>{document.body.removeChild(t),await this.loadModelFromServer(s)},i.appendChild(r)});const n=document.createElement("button");n.textContent="Cancel",n.style.cssText=`
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      background: #555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    `,n.onclick=()=>document.body.removeChild(t),i.appendChild(n),t.appendChild(i),document.body.appendChild(t)}async loadModelFromServer(e){try{console.log(`Loading model: ${e}`);const t=`/models/${e}`,i=await this.editor.objectFactory.importGLTF(t,e);i&&(this.editor.selectionManager.selectObject(i),this.editor.sceneHierarchy&&this.editor.sceneHierarchy.refresh(),console.log("Model loaded successfully"))}catch(t){console.error("Failed to load model:",t),alert(`Failed to load model: ${t.message}`)}}show(){this.scrollViewer&&(this.scrollViewer.isVisible=!0,this.isVisible=!0)}hide(){this.scrollViewer&&(this.scrollViewer.isVisible=!1,this.isVisible=!1)}}class M{constructor(e,t){this.editor=e,this.guiTexture=t,this.panel=null,this.currentObject=null,this.propertyControls=[],this.isVisible=!1,this.activeGizmoMode=null,this.uniformScaling=!0,this.moveButton=null,this.rotateButton=null,this.scaleButton=null,this.uniformScaleCheckbox=null,this.initialize()}initialize(){const e=new BABYLON.GUI.ScrollViewer;e.width="320px",e.height="600px",e.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT,e.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,e.paddingTop="10px",e.paddingRight="10px",e.background="#2a2a2a",e.thickness=2,e.color="#4a9eff",e.isVisible=!1,this.guiTexture.addControl(e),this.panel=new BABYLON.GUI.StackPanel,this.panel.width="300px",this.panel.background="#2a2a2a",e.isPointerBlocker=!0,e.addControl(this.panel),this.scrollViewer=e,this.editor.selectionManager.addSelectionCallback(t=>{this.updateForObject(t)}),console.log("PropertyPanel initialized")}updateForObject(e){if(console.log("PropertyPanel.updateForObject called with:",e?e.name:"null"),this.clearControls(),this.currentObject=e,!e){this.scrollViewer.isVisible=!1,console.log("PropertyPanel hidden - no object selected");return}console.log("PropertyPanel showing for object:",e.name),this.scrollViewer.isVisible=!0,this.createHeader(e),e instanceof BABYLON.Mesh?(this.createTransformSection(e),this.createMaterialSection(e)):e instanceof BABYLON.Light&&this.createLightSection(e),this.createDeleteButton()}clearControls(){this.panel&&this.panel.clearControls(),this.propertyControls=[]}createHeader(e){const t=new BABYLON.GUI.TextBlock;t.text=`Object: ${e.name}`,t.height="40px",t.color="#4a9eff",t.fontSize=18,t.fontWeight="bold",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.paddingLeft="5px",this.panel.addControl(t);const i=new BABYLON.GUI.InputText;i.width="280px",i.height="30px",i.color="white",i.background="#3a3a3a",i.text=e.name,i.fontSize=14,i.onTextChangedObservable.add(n=>{const s=n.text.trim();if(s&&s!==e.name){let r=s,l=1;for(;this.editor.scene.getMeshByName(r)||this.editor.scene.getLightByName(r);)r=`${s}_${l}`,l++;e.name=r,t.text=`Object: ${r}`,n.text=r,this.editor.sceneHierarchy&&this.editor.sceneHierarchy.refresh()}}),this.panel.addControl(i);const o=new BABYLON.GUI.Container;o.height="10px",this.panel.addControl(o)}createMaterialSection(e){if(!e.material)return;this.addSectionHeader("Material");const t=e.material;t.diffuseColor&&this.addColorControl("Diffuse",t.diffuseColor,i=>{t.diffuseColor=i}),t.specularColor&&this.addColorControl("Specular",t.specularColor,i=>{t.specularColor=i}),t.emissiveColor&&this.addColorControl("Emissive",t.emissiveColor,i=>{t.emissiveColor=i})}addColorControl(e,t,i){const o=new BABYLON.GUI.TextBlock;o.text=e+" Color:",o.height="25px",o.color="white",o.fontSize=12,o.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,o.paddingLeft="5px",this.panel.addControl(o);const n=new BABYLON.GUI.ColorPicker;n.value=t,n.height="180px",n.width="180px",n.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER,n.onValueChangedObservable.add(r=>{t.r=r.r,t.g=r.g,t.b=r.b,i(t)}),this.panel.addControl(n);const s=new BABYLON.GUI.Container;s.height="10px",this.panel.addControl(s)}createLightSection(e){if(e.position){this.addSectionHeader("Transform Gizmos"),this.createLightGizmoButtons(e);const s=new BABYLON.GUI.Container;s.height="10px",this.panel.addControl(s)}this.addSectionHeader("Light Properties");const t=new BABYLON.GUI.StackPanel;t.height="40px",t.isVertical=!1;const i=new BABYLON.GUI.TextBlock;i.text="Intensity:",i.width="80px",i.color="white",i.fontSize=12,t.addControl(i);const o=new BABYLON.GUI.Slider;o.minimum=0,o.maximum=10,o.value=e.intensity,o.height="20px",o.width="150px",o.color="#4a9eff",o.background="#3a3a3a",o.onValueChangedObservable.add(s=>{e.intensity=s}),t.addControl(o);const n=new BABYLON.GUI.TextBlock;if(n.text=e.intensity.toFixed(2),n.width="50px",n.color="white",n.fontSize=12,t.addControl(n),o.onValueChangedObservable.add(s=>{n.text=s.toFixed(2)}),this.panel.addControl(t),e.diffuse&&this.addColorControl("Light",e.diffuse,s=>{e.diffuse=s}),e.position&&(this.addSectionHeader("Position"),this.addVector3Control("X",e.position.x,s=>{e.position.x=s}),this.addVector3Control("Y",e.position.y,s=>{e.position.y=s}),this.addVector3Control("Z",e.position.z,s=>{e.position.z=s})),e.direction&&(this.addSectionHeader("Direction"),this.addVector3Control("X",e.direction.x,s=>{e.direction.x=s,e.direction.normalize()}),this.addVector3Control("Y",e.direction.y,s=>{e.direction.y=s,e.direction.normalize()}),this.addVector3Control("Z",e.direction.z,s=>{e.direction.z=s,e.direction.normalize()})),e.range!==void 0){this.addSectionHeader("Range");const s=new BABYLON.GUI.StackPanel;s.height="40px",s.isVertical=!1;const r=new BABYLON.GUI.TextBlock;r.text="Range:",r.width="80px",r.color="white",r.fontSize=12,s.addControl(r);const l=new BABYLON.GUI.Slider;l.minimum=1,l.maximum=50,l.value=e.range,l.height="20px",l.width="150px",l.color="#4a9eff",l.background="#3a3a3a",l.onValueChangedObservable.add(d=>{e.range=d}),s.addControl(l);const c=new BABYLON.GUI.TextBlock;c.text=e.range.toFixed(1),c.width="50px",c.color="white",c.fontSize=12,s.addControl(c),l.onValueChangedObservable.add(d=>{c.text=d.toFixed(1)}),this.panel.addControl(s)}}createDeleteButton(){const e=new BABYLON.GUI.Container;e.height="20px",this.panel.addControl(e);const t=BABYLON.GUI.Button.CreateSimpleButton("deleteBtn","Delete Object");t.width="280px",t.height="35px",t.color="white",t.background="#cc0000",t.fontSize=14,t.cornerRadius=4,t.onPointerEnterObservable.add(()=>{t.background="#ff0000"}),t.onPointerOutObservable.add(()=>{t.background="#cc0000"}),t.onPointerClickObservable.add(()=>{this.editor.deleteSelected()}),this.panel.addControl(t)}show(){this.currentObject&&this.scrollViewer&&(this.scrollViewer.isVisible=!0,this.isVisible=!0)}hide(){this.scrollViewer&&(this.scrollViewer.isVisible=!1,this.isVisible=!1)}createTransformSection(e){this.addSectionHeader("Transform Gizmos"),this.createGizmoButtons(e);const t=new BABYLON.GUI.Container;t.height="10px",this.panel.addControl(t),this.addSectionHeader("Position"),this.addVector3Control("X",e.position.x,i=>{e.position.x=i}),this.addVector3Control("Y",e.position.y,i=>{e.position.y=i}),this.addVector3Control("Z",e.position.z,i=>{e.position.z=i}),this.addSectionHeader("Rotation"),this.addVector3Control("X",e.rotation.x*180/Math.PI,i=>{e.rotation.x=i*Math.PI/180}),this.addVector3Control("Y",e.rotation.y*180/Math.PI,i=>{e.rotation.y=i*Math.PI/180}),this.addVector3Control("Z",e.rotation.z*180/Math.PI,i=>{e.rotation.z=i*Math.PI/180}),this.addSectionHeader("Scale"),this.addVector3Control("X",e.scaling.x,i=>{e.scaling.x=i}),this.addVector3Control("Y",e.scaling.y,i=>{e.scaling.y=i}),this.addVector3Control("Z",e.scaling.z,i=>{e.scaling.z=i})}createLightGizmoButtons(e){const t=new BABYLON.GUI.StackPanel;t.height="40px",t.isVertical=!1,t.paddingLeft="5px",this.moveButton=BABYLON.GUI.Button.CreateSimpleButton("moveGizmo","Move"),this.moveButton.width="90px",this.moveButton.height="35px",this.moveButton.color="white",this.moveButton.background="#3a3a3a",this.moveButton.fontSize=13,this.moveButton.cornerRadius=4,this.moveButton.onPointerClickObservable.add(()=>{this.toggleLightGizmoMode("move",e)}),t.addControl(this.moveButton),this.panel.addControl(t),this.updateGizmoButtonStates()}createGizmoButtons(e){const t=new BABYLON.GUI.StackPanel;t.height="40px",t.isVertical=!1,t.paddingLeft="5px",this.moveButton=BABYLON.GUI.Button.CreateSimpleButton("moveGizmo","Move"),this.moveButton.width="90px",this.moveButton.height="35px",this.moveButton.color="white",this.moveButton.background="#3a3a3a",this.moveButton.fontSize=13,this.moveButton.cornerRadius=4,this.moveButton.paddingRight="3px",this.moveButton.onPointerClickObservable.add(()=>{this.toggleGizmoMode("move")}),t.addControl(this.moveButton),this.rotateButton=BABYLON.GUI.Button.CreateSimpleButton("rotateGizmo","Rotate"),this.rotateButton.width="90px",this.rotateButton.height="35px",this.rotateButton.color="white",this.rotateButton.background="#3a3a3a",this.rotateButton.fontSize=13,this.rotateButton.cornerRadius=4,this.rotateButton.paddingLeft="3px",this.rotateButton.paddingRight="3px",this.rotateButton.onPointerClickObservable.add(()=>{this.toggleGizmoMode("rotate")}),t.addControl(this.rotateButton),this.scaleButton=BABYLON.GUI.Button.CreateSimpleButton("scaleGizmo","Scale"),this.scaleButton.width="90px",this.scaleButton.height="35px",this.scaleButton.color="white",this.scaleButton.background="#3a3a3a",this.scaleButton.fontSize=13,this.scaleButton.cornerRadius=4,this.scaleButton.paddingLeft="3px",this.scaleButton.onPointerClickObservable.add(()=>{this.toggleGizmoMode("scale")}),t.addControl(this.scaleButton),this.panel.addControl(t);const i=new BABYLON.GUI.StackPanel;i.height="30px",i.isVertical=!1,i.paddingLeft="5px",i.paddingTop="5px";const o=new BABYLON.GUI.Checkbox;o.name="uniformScale",o.width="20px",o.height="20px",o.isChecked=this.uniformScaling,o.color="#4a9eff",o.background="#3a3a3a",o.onIsCheckedChangedObservable.add(s=>{this.uniformScaling=s,this.editor.updateScaleGizmoUniformMode(s)}),i.addControl(o);const n=new BABYLON.GUI.TextBlock;n.text=" Lock Aspect Ratio",n.width="150px",n.height="20px",n.color="white",n.fontSize=12,n.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,n.paddingLeft="5px",i.addControl(n),this.panel.addControl(i),this.uniformScaleCheckbox=i,this.updateGizmoButtonStates()}toggleLightGizmoMode(e,t){this.activeGizmoMode===e?(this.activeGizmoMode=null,this.editor.setLightGizmoMode(null,t)):(this.activeGizmoMode=e,this.editor.setLightGizmoMode(e,t)),this.updateGizmoButtonStates()}toggleGizmoMode(e){this.activeGizmoMode===e?(this.activeGizmoMode=null,this.editor.setGizmoMode(null)):(this.activeGizmoMode=e,this.editor.setGizmoMode(e)),this.updateGizmoButtonStates()}updateGizmoButtonStates(){this.moveButton&&(this.activeGizmoMode==="move"?this.moveButton.background="#4a9eff":this.moveButton.background="#3a3a3a"),this.rotateButton&&(this.activeGizmoMode==="rotate"?this.rotateButton.background="#4a9eff":this.rotateButton.background="#3a3a3a"),this.scaleButton&&(this.activeGizmoMode==="scale"?this.scaleButton.background="#4a9eff":this.scaleButton.background="#3a3a3a"),this.uniformScaleCheckbox&&(this.uniformScaleCheckbox.isVisible=this.activeGizmoMode==="scale")}addSectionHeader(e){const t=new BABYLON.GUI.TextBlock;t.text=e,t.height="25px",t.color="white",t.fontSize=14,t.fontWeight="bold",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.paddingLeft="5px",this.panel.addControl(t)}addVector3Control(e,t,i){const o=new BABYLON.GUI.StackPanel;o.height="30px",o.isVertical=!1;const n=new BABYLON.GUI.TextBlock;n.text=e+":",n.width="30px",n.color="white",n.fontSize=12,n.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,o.addControl(n);const s=new BABYLON.GUI.InputText;s.width="240px",s.height="25px",s.color="white",s.background="#3a3a3a",s.text=t.toFixed(2),s.fontSize=12,s.onTextChangedObservable.add(r=>{const l=parseFloat(r.text);isNaN(l)||i(l)}),o.addControl(s),this.panel.addControl(o)}}class T{constructor(e,t){this.editor=e,this.guiTexture=t,this.panel=null,this.scrollViewer=null,this.objectButtons=new Map,this.isVisible=!0,this.initialize()}initialize(){this.scrollViewer=new BABYLON.GUI.ScrollViewer,this.scrollViewer.width="240px",this.scrollViewer.height="45%",this.scrollViewer.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,this.scrollViewer.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM,this.scrollViewer.left="10px",this.scrollViewer.top="-50px",this.scrollViewer.background="#2a2a2a",this.scrollViewer.thickness=2,this.scrollViewer.thumbLength=.5,this.scrollViewer.barColor="#4a9eff",this.scrollViewer.barBackground="#1a1a1a",this.scrollViewer.isPointerBlocker=!0,this.guiTexture.addControl(this.scrollViewer),this.panel=new BABYLON.GUI.StackPanel,this.panel.width="200px",this.scrollViewer.addControl(this.panel),this.editor.selectionManager.addSelectionCallback(e=>{this.highlightSelected(e)}),this.refresh(),console.log("SceneHierarchy initialized with 45% height and scrolling")}refresh(){this.panel.clearControls(),this.objectButtons.clear();const e=new BABYLON.GUI.TextBlock;e.text="Scene Hierarchy",e.height="30px",e.width="190px",e.color="#4a9eff",e.fontSize=16,e.fontWeight="bold",e.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.textWrapping=!0,e.paddingLeft="5px",this.panel.addControl(e);const t=this.editor.scene.meshes.filter(o=>!o.name.startsWith("_")),i=this.editor.scene.lights;this.addSection("Meshes",t),this.addSection("Lights",i)}addSection(e,t){if(t.length===0)return;const i=new BABYLON.GUI.TextBlock;i.text=e,i.height="25px",i.color="white",i.fontSize=14,i.fontWeight="bold",i.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,i.paddingLeft="5px",this.panel.addControl(i),t.forEach(n=>{const s=this.createObjectButton(n);this.panel.addControl(s),this.objectButtons.set(n,s)});const o=new BABYLON.GUI.Container;o.height="5px",this.panel.addControl(o)}createObjectButton(e){const t=BABYLON.GUI.Button.CreateSimpleButton(`hierarchy_${e.name}_${Date.now()}`,e.name);return t.width="180px",t.height="25px",t.color="white",t.background="#333",t.fontSize=12,t.cornerRadius=2,t.paddingLeft="10px",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.onPointerEnterObservable.add(()=>{this.editor.selectionManager.selectedObject!==e&&(t.background="#444")}),t.onPointerOutObservable.add(()=>{this.editor.selectionManager.selectedObject!==e&&(t.background="#333")}),t.onPointerClickObservable.add(()=>{this.editor.selectionManager.selectObject(e)}),t}highlightSelected(e){this.objectButtons.forEach((t,i)=>{i===e?t.background="#4a9eff":t.background="#333"})}show(){this.scrollViewer&&(this.scrollViewer.isVisible=!0,this.isVisible=!0)}hide(){this.scrollViewer&&(this.scrollViewer.isVisible=!1,this.isVisible=!1)}}class O{constructor(e,t){this.guiTexture=e,this.pipeline=t,this.panel=null,this.scrollViewer=null,this.isVisible=!1,this.toggleButton=null,this.initialize()}initialize(){this.toggleButton=BABYLON.GUI.Button.CreateSimpleButton("settingsToggle","⚙ Settings"),this.toggleButton.width="100px",this.toggleButton.height="30px",this.toggleButton.color="white",this.toggleButton.background="#2a2a2a",this.toggleButton.fontSize=14,this.toggleButton.cornerRadius=4,this.toggleButton.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT,this.toggleButton.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,this.toggleButton.top="50px",this.toggleButton.left="-10px",this.toggleButton.onPointerClickObservable.add(()=>{this.toggle()}),this.guiTexture.addControl(this.toggleButton),this.scrollViewer=new BABYLON.GUI.ScrollViewer,this.scrollViewer.width="320px",this.scrollViewer.height="500px",this.scrollViewer.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT,this.scrollViewer.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,this.scrollViewer.top="90px",this.scrollViewer.left="-10px",this.scrollViewer.background="#2a2a2a",this.scrollViewer.thickness=2,this.scrollViewer.barColor="#4a9eff",this.scrollViewer.barBackground="#1a1a1a",this.scrollViewer.isVisible=!1,this.scrollViewer.isPointerBlocker=!0,this.guiTexture.addControl(this.scrollViewer),this.panel=new BABYLON.GUI.StackPanel,this.panel.width="300px",this.scrollViewer.addControl(this.panel),this.createControls(),console.log("SettingsPanel initialized")}createControls(){const e=this.createHeader("Post-Processing Settings");this.panel.addControl(e),this.addCheckbox("FXAA Antialiasing",this.pipeline.fxaaEnabled,t=>{this.pipeline.fxaaEnabled=t}),this.addSectionHeader("Bloom"),this.addCheckbox("Enable Bloom",this.pipeline.bloomEnabled,t=>{this.pipeline.bloomEnabled=t}),this.addSlider("Bloom Threshold",this.pipeline.bloomThreshold,0,1,t=>{this.pipeline.bloomThreshold=t}),this.addSlider("Bloom Weight",this.pipeline.bloomWeight,0,1,t=>{this.pipeline.bloomWeight=t}),this.addSlider("Bloom Scale",this.pipeline.bloomScale,0,1,t=>{this.pipeline.bloomScale=t}),this.addSectionHeader("Image Processing"),this.addSlider("Contrast",this.pipeline.imageProcessing.contrast,.5,2,t=>{this.pipeline.imageProcessing.contrast=t}),this.addSlider("Exposure",this.pipeline.imageProcessing.exposure,.5,2,t=>{this.pipeline.imageProcessing.exposure=t}),this.addSectionHeader("Vignette"),this.addCheckbox("Enable Vignette",this.pipeline.imageProcessing.vignetteEnabled,t=>{this.pipeline.imageProcessing.vignetteEnabled=t}),this.addSlider("Vignette Weight",this.pipeline.imageProcessing.vignetteWeight,0,4,t=>{this.pipeline.imageProcessing.vignetteWeight=t}),this.addSectionHeader("Chromatic Aberration"),this.addCheckbox("Enable Chromatic Aberration",this.pipeline.chromaticAberrationEnabled,t=>{this.pipeline.chromaticAberrationEnabled=t}),this.addSlider("Aberration Amount",this.pipeline.chromaticAberration.aberrationAmount,0,100,t=>{this.pipeline.chromaticAberration.aberrationAmount=t}),this.addSectionHeader("Film Grain"),this.addCheckbox("Enable Grain",this.pipeline.grainEnabled,t=>{this.pipeline.grainEnabled=t}),this.addSlider("Grain Intensity",this.pipeline.grain.intensity,0,50,t=>{this.pipeline.grain.intensity=t}),this.addCheckbox("Animated Grain",this.pipeline.grain.animated,t=>{this.pipeline.grain.animated=t}),this.addSectionHeader("Sharpen"),this.addCheckbox("Enable Sharpen",this.pipeline.sharpenEnabled,t=>{this.pipeline.sharpenEnabled=t}),this.addSlider("Edge Amount",this.pipeline.sharpen.edgeAmount,0,1,t=>{this.pipeline.sharpen.edgeAmount=t}),this.addSlider("Color Amount",this.pipeline.sharpen.colorAmount,0,1,t=>{this.pipeline.sharpen.colorAmount=t})}createHeader(e){const t=new BABYLON.GUI.TextBlock;return t.text=e,t.height="40px",t.color="#4a9eff",t.fontSize=18,t.fontWeight="bold",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.paddingLeft="10px",t}addSectionHeader(e){const t=new BABYLON.GUI.TextBlock;t.text=e,t.height="30px",t.color="white",t.fontSize=14,t.fontWeight="bold",t.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,t.paddingLeft="10px",t.paddingTop="10px",this.panel.addControl(t)}addCheckbox(e,t,i){const o=new BABYLON.GUI.StackPanel;o.height="30px",o.isVertical=!1,o.paddingLeft="10px";const n=new BABYLON.GUI.Checkbox;n.width="20px",n.height="20px",n.isChecked=t,n.color="#4a9eff",n.background="#3a3a3a",n.onIsCheckedChangedObservable.add(r=>{i(r)});const s=new BABYLON.GUI.TextBlock;s.text=e,s.width="250px",s.height="20px",s.color="white",s.fontSize=12,s.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,s.paddingLeft="10px",o.addControl(n),o.addControl(s),this.panel.addControl(o)}addSlider(e,t,i,o,n){const s=new BABYLON.GUI.TextBlock;s.text=`${e}: ${t.toFixed(2)}`,s.height="25px",s.color="white",s.fontSize=12,s.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,s.paddingLeft="10px",this.panel.addControl(s);const r=new BABYLON.GUI.Slider;r.minimum=i,r.maximum=o,r.value=t,r.height="20px",r.width="280px",r.color="#4a9eff",r.background="#3a3a3a",r.borderColor="#4a9eff",r.onValueChangedObservable.add(c=>{s.text=`${e}: ${c.toFixed(2)}`,n(c)}),this.panel.addControl(r);const l=new BABYLON.GUI.Container;l.height="5px",this.panel.addControl(l)}toggle(){this.isVisible=!this.isVisible,this.scrollViewer.isVisible=this.isVisible,this.isVisible?this.toggleButton.background="#4a9eff":this.toggleButton.background="#2a2a2a"}show(){this.isVisible=!0,this.scrollViewer.isVisible=!0,this.toggleButton.background="#4a9eff"}hide(){this.isVisible=!1,this.scrollViewer.isVisible=!1,this.toggleButton.background="#2a2a2a"}refresh(){this.panel.clearControls(),this.createControls(),console.log("Settings panel refreshed with loaded values")}}class S{constructor(e){this.scene=e,this.monitorMesh=null,this.screenMaterial=null,this.dynamicTexture=null,this.config=null,this.currentFrame=null,this.frames=new Map,this.hiddenIframe=null,this.renderCanvas=null,this.renderContext=null,this.isActive=!1,this.selectedElementIndex=0,this.interactiveElements=[],this.inputBuffer="",this.activeInputField=null,this.textureWidth=1024,this.textureHeight=768,this.refreshRate=30,this.lastRenderTime=0,console.log("MonitorController initialized")}async initialize(){try{await this.loadConfig(),this.setupRenderingInfrastructure();const e=this.setupMonitorMesh();return this.setupKeyboardInput(),console.log("MonitorController initialized - showing alignment pattern"),!0}catch(e){return console.error("Failed to initialize MonitorController:",e),!1}}async loadConfig(){try{const e=await fetch("/src/monitor/frames/frames-config.json");if(!e.ok)throw new Error(`Failed to load config: ${e.statusText}`);this.config=await e.json(),console.log("Frames config loaded:",this.config)}catch(e){throw console.error("Error loading frames config:",e),e}}setupRenderingInfrastructure(){this.hiddenIframe=document.createElement("iframe"),this.hiddenIframe.style.cssText=`
      position: fixed;
      top: -9999px;
      left: -9999px;
      width: ${this.textureWidth}px;
      height: ${this.textureHeight}px;
      border: none;
      visibility: hidden;
    `,document.body.appendChild(this.hiddenIframe),this.renderCanvas=document.createElement("canvas"),this.renderCanvas.width=this.textureWidth,this.renderCanvas.height=this.textureHeight,this.renderContext=this.renderCanvas.getContext("2d"),console.log("Rendering infrastructure setup complete")}setupMonitorMesh(){return this.monitorMesh=this.scene.getMeshByName("SM_Prop_ComputerMonitor_A_29_screen_mesh"),this.monitorMesh||(this.monitorMesh=this.scene.getMeshByName("monitor_screen")),this.monitorMesh?(console.log("Monitor mesh found:",this.monitorMesh.name),this.applyMaterialToMesh(),!0):(console.log("Monitor mesh not found yet, waiting for scene to load..."),this.setupMeshObserver(),!1)}setupMeshObserver(){const e=setInterval(()=>{this.monitorMesh=this.scene.getMeshByName("SM_Prop_ComputerMonitor_A_29_screen_mesh"),this.monitorMesh||(this.monitorMesh=this.scene.getMeshByName("monitor_screen")),this.monitorMesh&&(console.log("Monitor mesh found:",this.monitorMesh.name),clearInterval(e),this.applyMaterialToMesh())},200);setTimeout(()=>{clearInterval(e),this.monitorMesh||(console.warn("Monitor mesh not found, creating test plane"),this.monitorMesh=BABYLON.MeshBuilder.CreatePlane("monitor_screen",{width:2,height:1.5},this.scene),this.monitorMesh.position=new BABYLON.Vector3(0,1.5,-3),this.applyMaterialToMesh())},1e4)}applyMaterialToMesh(){var e,t,i;this.monitorMesh&&(this.dynamicTexture=new BABYLON.DynamicTexture("monitorTexture",{width:this.textureWidth,height:this.textureHeight},this.scene,!1),this.originalMaterial=this.monitorMesh.material,console.log("Original material:",this.originalMaterial),console.log("Original material name:",(e=this.originalMaterial)==null?void 0:e.name),console.log("Original material type:",(t=this.originalMaterial)==null?void 0:t.getClassName()),this.originalMaterial&&this.originalMaterial.name==="monitorscreen"?(console.log("Found monitorscreen material, modifying it..."),this.originalMaterial.albedoTexture!==void 0?(this.originalMaterial.albedoTexture=this.dynamicTexture,this.originalMaterial.emissiveTexture=this.dynamicTexture,this.originalMaterial.emissiveColor=new BABYLON.Color3(1,1,1),this.originalMaterial.emissiveIntensity=1,this.originalMaterial.unlit=!0,this.dynamicTexture.wAng=270*Math.PI/180,this.dynamicTexture.uScale=1.32,this.dynamicTexture.vScale=-.96,this.dynamicTexture.uOffset=-.15,this.dynamicTexture.vOffset=.79,console.log("Modified PBR material with dynamic texture (calibrated UV mapping)")):(this.originalMaterial.diffuseTexture=this.dynamicTexture,this.originalMaterial.emissiveTexture=this.dynamicTexture,this.originalMaterial.emissiveColor=new BABYLON.Color3(1,1,1),this.originalMaterial.disableLighting=!0,this.dynamicTexture.wAng=270*Math.PI/180,this.dynamicTexture.uScale=1.32,this.dynamicTexture.vScale=-.96,this.dynamicTexture.uOffset=-.15,this.dynamicTexture.vOffset=.79,console.log("Modified Standard material with dynamic texture (calibrated UV mapping)")),this.screenMaterial=this.originalMaterial):(console.log("Creating new material..."),this.screenMaterial=new BABYLON.StandardMaterial("monitorMaterial",this.scene),this.screenMaterial.diffuseTexture=this.dynamicTexture,this.screenMaterial.emissiveTexture=this.dynamicTexture,this.screenMaterial.disableLighting=!0,this.screenMaterial.emissiveColor=new BABYLON.Color3(1,1,1),this.screenMaterial.diffuseColor=new BABYLON.Color3(1,1,1),this.screenMaterial.backFaceCulling=!1,this.monitorMesh.material=this.screenMaterial),console.log("Material applied to monitor mesh"),console.log("Mesh name:",this.monitorMesh.name),console.log("Final material:",(i=this.monitorMesh.material)==null?void 0:i.name),console.log("Texture size:",this.dynamicTexture.getSize()),this.drawCornerMarkersPattern())}drawCornerMarkersPattern(){const e=this.dynamicTexture.getContext();e.fillStyle="#000000",e.fillRect(0,0,this.textureWidth,this.textureHeight),e.strokeStyle="#00ff00",e.lineWidth=10,e.strokeRect(5,5,this.textureWidth-10,this.textureHeight-10);const t=100,i=20;e.fillStyle="#ff0000",e.fillRect(i,i,t,t),e.fillStyle="#ffffff",e.font="20px Arial",e.textAlign="left",e.fillText("TOP-LEFT",i+5,i+130),e.fillStyle="#0000ff",e.fillRect(this.textureWidth-i-t,i,t,t),e.fillStyle="#ffffff",e.textAlign="right",e.fillText("TOP-RIGHT",this.textureWidth-i-5,i+130),e.fillStyle="#ffff00",e.fillRect(i,this.textureHeight-i-t,t,t),e.fillStyle="#000000",e.textAlign="left",e.fillText("BOTTOM-LEFT",i+5,this.textureHeight-i-110),e.fillStyle="#ff00ff",e.fillRect(this.textureWidth-i-t,this.textureHeight-i-t,t,t),e.fillStyle="#ffffff",e.textAlign="right",e.fillText("BOTTOM-RIGHT",this.textureWidth-i-5,this.textureHeight-i-110),e.fillStyle="#00ff00",e.fillRect(this.textureWidth/2-50,this.textureHeight/2-50,100,100),e.fillStyle="#000000",e.textAlign="center",e.fillText("CENTER",this.textureWidth/2,this.textureHeight/2+5),this.dynamicTexture.update(),console.log("Corner markers test pattern drawn")}async loadFrame(e){if(!this.config.frames[e])return console.error(`Frame ${e} not found in config`),!1;const t=this.config.frames[e],i=`/src/monitor/frames/${t.file}`;try{const o=await fetch(i);if(!o.ok)throw new Error(`Failed to load frame: ${o.statusText}`);const n=await o.text(),s=this.hiddenIframe.contentDocument||this.hiddenIframe.contentWindow.document;return s.open(),s.write(n),s.close(),await new Promise(r=>{this.hiddenIframe.contentWindow.document.readyState==="complete"?r():this.hiddenIframe.onload=r}),this.currentFrame=t,this.findInteractiveElements(),await this.renderFrameToTexture(),console.log(`Frame loaded: ${e}`),!0}catch(o){return console.error(`Error loading frame ${e}:`,o),!1}}findInteractiveElements(){const e=this.hiddenIframe.contentDocument||this.hiddenIframe.contentWindow.document,t=Array.from(e.querySelectorAll("[data-transition]")),i=Array.from(e.querySelectorAll("input, textarea"));this.interactiveElements=[...t,...i],this.selectedElementIndex=0,this.interactiveElements.length>0&&this.highlightElement(0),console.log(`Found ${this.interactiveElements.length} interactive elements`)}highlightElement(e){(this.hiddenIframe.contentDocument||this.hiddenIframe.contentWindow.document).querySelectorAll(".selected").forEach(i=>{i.classList.remove("selected")}),this.interactiveElements[e]&&(this.interactiveElements[e].classList.add("selected"),this.selectedElementIndex=e)}async renderFrameToTexture(){try{const t=(this.hiddenIframe.contentDocument||this.hiddenIframe.contentWindow.document).body;if(!t){console.error("Iframe body not found");return}if(typeof html2canvas<"u"){console.log("Rendering HTML to canvas...");const i=await html2canvas(t,{canvas:this.renderCanvas,backgroundColor:"#0a0a0a",scale:1,logging:!1,width:this.textureWidth,height:this.textureHeight}),o=this.dynamicTexture.getContext();o.clearRect(0,0,this.textureWidth,this.textureHeight),o.drawImage(i,0,0),this.dynamicTexture.update(),console.log("Texture updated successfully")}else console.warn("html2canvas not available, using fallback rendering"),this.renderFallback()}catch(e){console.error("Error rendering frame to texture:",e),this.renderFallback()}}renderFallback(){var t;console.log("Using fallback rendering");const e=this.dynamicTexture.getContext();e.fillStyle="#0a0a0a",e.fillRect(0,0,this.textureWidth,this.textureHeight),e.strokeStyle="#00ff00",e.lineWidth=4,e.strokeRect(10,10,this.textureWidth-20,this.textureHeight-20),e.fillStyle="#00ff00",e.font='48px "Courier New"',e.textAlign="center",e.textBaseline="middle",e.fillText(((t=this.currentFrame)==null?void 0:t.name)||"MONITOR ACTIVE",this.textureWidth/2,this.textureHeight/2),e.font='24px "Courier New"',e.fillText("Press M to toggle",this.textureWidth/2,this.textureHeight/2+60),this.dynamicTexture.update(),console.log("Fallback rendering complete")}setupKeyboardInput(){window.addEventListener("keydown",e=>{this.isActive&&this.handleKeyPress(e)}),console.log("Keyboard input setup complete")}async handleKeyPress(e){const t=e.key,i=this.interactiveElements[this.selectedElementIndex];i&&(i.tagName==="INPUT"||i.tagName==="TEXTAREA")&&this.activeInputField?t.length===1?(i.value+=t,await this.renderFrameToTexture()):t==="Backspace"?(i.value=i.value.slice(0,-1),await this.renderFrameToTexture(),e.preventDefault()):t==="Escape"&&(this.activeInputField=null):t==="ArrowDown"||t==="s"||t==="S"?(this.selectedElementIndex=(this.selectedElementIndex+1)%this.interactiveElements.length,this.highlightElement(this.selectedElementIndex),await this.renderFrameToTexture(),e.preventDefault()):t==="ArrowUp"||t==="w"||t==="W"?(this.selectedElementIndex=(this.selectedElementIndex-1+this.interactiveElements.length)%this.interactiveElements.length,this.highlightElement(this.selectedElementIndex),await this.renderFrameToTexture(),e.preventDefault()):t==="Enter"&&(await this.activateElement(i),e.preventDefault())}async activateElement(e){if(!e)return;const t=e.getAttribute("data-transition");if(t){await this.transitionToFrame(t);return}(e.tagName==="INPUT"||e.tagName==="TEXTAREA")&&(this.activeInputField=e,e.focus(),console.log("Entered input mode"))}async transitionToFrame(e){return this.currentFrame.transitions.includes(e)?(await this.loadFrame(e),this.config.activeFrame=e,!0):(console.warn(`Invalid transition from ${this.currentFrame.id} to ${e}`),!1)}activate(){this.isActive=!0,this.currentFrame===null&&this.config&&this.loadFrame(this.config.activeFrame),console.log("Monitor activated")}deactivate(){this.isActive=!1,this.activeInputField=null,console.log("Monitor deactivated")}update(){const e=Date.now();e-this.lastRenderTime>1e3/this.refreshRate&&(this.lastRenderTime=e)}debugTestPattern(){const e=this.dynamicTexture.getContext(),t=["#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#00ffff"],i=t[Math.floor(Math.random()*t.length)];e.fillStyle=i,e.fillRect(0,0,this.textureWidth,this.textureHeight),e.fillStyle="#ffffff",e.font="bold 128px Arial",e.textAlign="center",e.textBaseline="middle",e.fillText("DEBUG",this.textureWidth/2,this.textureHeight/2),this.dynamicTexture.update(),console.log("Debug test pattern rendered with color:",i)}debugRotateTexture(e){const t=e*Math.PI/180;this.dynamicTexture.wAng=t,this.dynamicTexture.update(),console.log(`Texture rotated to ${e}°`)}debugScaleTexture(e,t){this.dynamicTexture.uScale=e,this.dynamicTexture.vScale=t,this.dynamicTexture.update(),console.log(`Texture scaled to U:${e}, V:${t}`)}dispose(){this.hiddenIframe&&document.body.removeChild(this.hiddenIframe),this.dynamicTexture&&this.dynamicTexture.dispose(),this.screenMaterial&&this.screenMaterial.dispose(),console.log("MonitorController disposed")}}let u=null,g=null,f=null,z=Date.now(),h=null,B=null,m=null;window.addEventListener("DOMContentLoaded",()=>{k()});function N(a,e){const t=new BABYLON.DefaultRenderingPipeline("defaultPipeline",!0,a,e);return t.samples=4,t.fxaaEnabled=!0,t.bloomEnabled=!0,t.bloomThreshold=.8,t.bloomWeight=.3,t.bloomKernel=64,t.bloomScale=.5,t.imageProcessingEnabled=!0,t.imageProcessing.contrast=1.1,t.imageProcessing.exposure=1,t.imageProcessing.toneMappingEnabled=!0,t.imageProcessing.toneMappingType=BABYLON.ImageProcessingConfiguration.TONEMAPPING_ACES,t.imageProcessing.vignetteEnabled=!0,t.imageProcessing.vignetteWeight=1.5,t.imageProcessing.vignetteCameraFov=.8,t.chromaticAberrationEnabled=!0,t.chromaticAberration.aberrationAmount=5,t.grainEnabled=!0,t.grain.intensity=10,t.grain.animated=!0,t.sharpenEnabled=!0,t.sharpen.edgeAmount=.3,t.sharpen.colorAmount=.5,console.log("Post-processing pipeline initialized with bloom, AA, and effects"),t}function v(){const a={webglSupported:!1,webgl2Supported:!1,browserName:"Unknown",browserVersion:"Unknown",compatible:!1,warnings:[]},e=navigator.userAgent;e.indexOf("Chrome")>-1&&e.indexOf("Edg")===-1?a.browserName="Chrome":e.indexOf("Firefox")>-1?a.browserName="Firefox":e.indexOf("Edg")>-1?a.browserName="Edge":e.indexOf("Safari")>-1&&(a.browserName="Safari");const t=document.createElement("canvas"),i=t.getContext("webgl")||t.getContext("experimental-webgl"),o=t.getContext("webgl2");return i&&(a.webglSupported=!0),o&&(a.webgl2Supported=!0),a.webgl2Supported?(a.compatible=!0,console.log("✓ WebGL 2.0 supported")):a.webglSupported?(a.compatible=!0,a.warnings.push("WebGL 2.0 not supported, falling back to WebGL 1.0"),console.warn("⚠ WebGL 2.0 not supported, using WebGL 1.0 fallback")):(a.compatible=!1,console.error("✗ WebGL not supported")),["Chrome","Firefox","Edge"].includes(a.browserName)||a.warnings.push(`Browser ${a.browserName} may not be fully supported. Recommended: Chrome, Firefox, or Edge`),console.log(`Browser: ${a.browserName}, WebGL: ${a.webglSupported}, WebGL2: ${a.webgl2Supported}`),a}function G(){const a=document.createElement("div");return a.id="fps-counter",a.style.cssText=`
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: #00ff00;
    padding: 8px 12px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    z-index: 1000;
    min-width: 80px;
  `,a.textContent="FPS: --",document.body.appendChild(a),a}function E(){if(f&&u){const a=u.getFps().toFixed(0);f.textContent=`FPS: ${a}`,a>=50?f.style.color="#00ff00":a>=30?f.style.color="#ffff00":f.style.color="#ff0000"}}function I(){const a=(Date.now()-z)/1e3;return console.log(`Game loaded in ${a.toFixed(2)} seconds`),a>5?console.warn(`⚠ Load time (${a.toFixed(2)}s) exceeds target of 5 seconds`):console.log("✓ Load time within target (< 5 seconds)"),a}async function k(){try{const a=v();if(!a.compatible){p("WebGL is not supported in your browser. Please use a modern browser like Chrome, Firefox, or Edge.");return}a.warnings.length>0&&a.warnings.forEach(s=>{console.warn(s)});const e=document.getElementById("renderCanvas");if(!e){console.error("Canvas element not found"),p("Failed to initialize: Canvas element not found");return}try{u=new BABYLON.Engine(e,!0,{preserveDrawingBuffer:!0,stencil:!0,disableWebGL2Support:!a.webgl2Supported})}catch(s){console.error("Failed to create Babylon.js engine:",s),p("WebGL not supported or failed to initialize. Please use a modern browser.");return}g=new BABYLON.Scene(u),g.clearColor=new BABYLON.Color3(.01,.01,.02),BABYLON.KhronosTextureContainer2&&(u.enableOfflineSupport=!1,g.enableOfflineSupport=!1,BABYLON.KhronosTextureContainer2.URLConfig||(BABYLON.KhronosTextureContainer2.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,jsMSCTranscoder:null,wasmMSCTranscoder:null}),console.log("KTX2 decoder initialized for compressed textures"));const t=new BABYLON.HemisphericLight("hemisphericLight",new BABYLON.Vector3(0,1,0),g);t.intensity=.5,t.diffuse=new BABYLON.Color3(.8,.8,.9),console.log("Basic scene initialized without room geometry");const i=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");h=new L(g,e),h.initialize(i),h.objectPalette=new A(h,i),h.propertyPanel=new M(h,i),h.sceneHierarchy=new T(h,i);const o=[h.cameraManager.editorCamera,h.cameraManager.playerCamera];B=N(g,o),window.postProcessingPipeline=B;const n=new O(i,B);window.settingsPanel=n,m=new S(g),window.monitorController=m,m.initialize().then(()=>{console.log("Monitor system ready")}).catch(s=>{console.error("Monitor initialization failed:",s)}),window.addEventListener("keydown",s=>{(s.key==="m"||s.key==="M")&&(m.isActive?(m.deactivate(),console.log("Monitor deactivated - press M to reactivate")):(m.activate(),console.log("Monitor activated - use Arrow keys/WASD to navigate, Enter to select, Escape to exit input")))}),h.enterEditorMode(),setTimeout(()=>{h.autoLoadScene()},100),window.addEventListener("resize",()=>{u.resize()}),console.log("Spooky Game - Engine and scene initialized successfully"),f=G(),I(),u.runRenderLoop(()=>{try{g.render(),E(),m&&m.update()}catch(s){console.error("Render error:",s)}})}catch(a){console.error("Unexpected error during initialization:",a),p("An unexpected error occurred during initialization")}}function p(a){let e=document.getElementById("error-message");e||(e=document.createElement("div"),e.id="error-message",e.style.cssText="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ff0000; color: #ffffff; padding: 20px; border-radius: 5px; font-family: Arial, sans-serif; z-index: 1000;",document.body.appendChild(e)),e.textContent=a}
